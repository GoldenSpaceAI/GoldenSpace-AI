<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GoldenSpaceAI ¬∑ Advanced Chat</title>
<style>
:root {
  --gold1: #ffd700;
  --gold2: #ffed4e;
  --border: rgba(255,255,255,.12);
  --text-dark: #f8f8f8;
  --text-light: #222;
}

/* ===== Background / Themes ===== */
body {
  margin: 0;
  font-family: "Segoe UI", Roboto, system-ui;
  color: var(--text-dark);
  background: url("https://images.unsplash.com/photo-1444703686981-a3abbc4d4fe3?q=80&w=1600&auto=format&fit=crop")
              center/cover fixed no-repeat #04050a;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  transition: background .5s ease, color .5s ease;
  overflow-y: auto;
}
body.light {
  color: var(--text-light);
  background: url("https://images.unsplash.com/photo-1454789548928-9efd52dc4031?q=80&w=1600&auto=format&fit=crop")
              center/cover fixed no-repeat #f5f5f5;
}

/* ===== Header ===== */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(0,0,0,0.55);
  padding: 14px 20px;
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
}
body.light header { background: rgba(255,255,255,0.55); }

.brand {
  display: flex;
  align-items: center;
  gap: .6rem;
  font-weight: 800;
}
.logo {
  width: 32px; height: 32px;
  border-radius: 50%;
  background: conic-gradient(from 210deg, var(--gold1), var(--gold2), #b89200, var(--gold1));
  box-shadow: 0 0 15px rgba(255,215,0,.4);
}
.theme-toggle {
  background: transparent;
  border: 1px solid var(--border);
  padding: 8px 14px;
  border-radius: 10px;
  color: inherit;
  cursor: pointer;
  font-weight: 700;
}

/* ===== Chat ===== */
main {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px 140px;
  scroll-behavior: smooth;
}
.msg {
  max-width: 750px;
  margin: 8px auto;
  padding: 10px 14px;
  border-radius: 14px;
  border: 1px solid var(--border);
  backdrop-filter: blur(6px);
  box-shadow: 0 3px 12px rgba(0,0,0,.25);
  line-height: 1.45;
}
.msg small {
  display: block;
  font-size: .75rem;
  opacity: .6;
  margin-bottom: 4px;
}
.msg.ai { background: rgba(12,12,18,.65); }
.msg.user {
  background: linear-gradient(180deg,rgba(255,215,0,.12),rgba(255,215,0,.08));
  border-color: rgba(255,215,0,.35);
}
body.light .msg.ai { background: #fff; }
body.light .msg.user { background: #fff9cc; }
.uploaded-image {
  max-width: 300px;
  max-height: 300px;
  border-radius: 8px;
  margin: 8px 0;
  border: 1px solid var(--border);
}
.generated-image {
  max-width: 100%;
  max-height: 500px;
  border-radius: 10px;
  border: 2px solid gold;
  margin: 10px 0;
}
.tools { margin-top: 6px; display: flex; gap: 8px; flex-wrap: wrap; }
.speak-btn, .copy-btn {
  background: linear-gradient(180deg,var(--gold1),var(--gold2));
  border: none;
  border-radius: 8px;
  padding: 5px 10px;
  font-weight: 800;
  color: #141209;
  cursor: pointer;
  font-size: 12px;
}

/* ===== Composer ===== */
.composer-wrap {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: rgba(0,0,0,.6);
  backdrop-filter: blur(10px);
  border-top: 1px solid var(--border);
  padding: 14px 0;
}
body.light .composer-wrap { background: rgba(255,255,255,.7); }
.composer {
  width: min(940px,94%);
  margin: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
#prompt {
  resize: none;
  min-height: 56px;
  max-height: 140px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.2);
  background: rgba(255,255,255,.08);
  color: inherit;
  padding: 12px 14px;
  font-size: 15px;
}
.actions {
  display: flex;
  justify-content: center;
  gap: 8px;
  flex-wrap: wrap;
}
.act-btn {
  flex: 1;
  min-width: 120px;
  padding: 12px 8px;
  text-align: center;
  border-radius: 14px;
  border: 1px solid rgba(255,215,0,.3);
  background: rgba(255,215,0,.08);
  color: var(--gold1);
  font-weight: 800;
  cursor: pointer;
  transition: .25s;
  font-size: 14px;
}
.act-btn:hover {
  background: rgba(255,215,0,.18);
}
.act-btn.active {
  background: linear-gradient(45deg,var(--gold1),var(--gold2));
  color: #141209;
  box-shadow: 0 0 20px rgba(255,215,0,.45);
}
.act-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ===== Subscription Plans Modal ===== */
.plans-modal {
  background: linear-gradient(145deg, rgba(30,25,0,0.95), rgba(20,15,0,0.92));
  border: 2px solid rgba(255,215,0,0.6);
  border-radius: 20px;
  padding: 30px;
  max-width: 800px;
  width: 90%;
  color: #fff;
  text-align: center;
}
.plans-title {
  font-size: 2rem;
  font-weight: 900;
  margin-bottom: 10px;
  color: gold;
}
.plans-subtitle {
  color: #ccc;
  margin-bottom: 30px;
  font-size: 1.1rem;
}
.plans-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 30px;
}
.plan-card {
  background: rgba(255,255,255,0.05);
  border: 2px solid rgba(255,255,255,0.1);
  border-radius: 15px;
  padding: 25px;
  text-align: left;
  transition: all 0.3s ease;
  position: relative;
}
.plan-card.featured {
  border-color: gold;
  background: rgba(255,215,0,0.05);
  transform: scale(1.05);
}
.plan-card.featured::before {
  content: "üî• MOST POPULAR";
  position: absolute;
  top: -12px;
  left: 50%;
  transform: translateX(-50%);
  background: gold;
  color: #000;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
}
.plan-name {
  font-size: 1.5rem;
  font-weight: 900;
  margin-bottom: 10px;
  color: gold;
}
.plan-price {
  font-size: 2rem;
  font-weight: 900;
  margin-bottom: 15px;
}
.plan-features {
  list-style: none;
  padding: 0;
  margin: 0 0 20px 0;
}
.plan-features li {
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.plan-features li:last-child {
  border-bottom: none;
}
.plan-features li::before {
  content: "‚úì ";
  color: gold;
  font-weight: bold;
  margin-right: 8px;
}
.subscribe-btn {
  width: 100%;
  background: linear-gradient(45deg, var(--gold1), var(--gold2));
  color: #141209;
  border: none;
  border-radius: 12px;
  padding: 15px;
  font-weight: 900;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 1.1rem;
}
.subscribe-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(255,215,0,0.4);
}
.subscribe-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}
.plan-badge {
  display: inline-block;
  background: rgba(255,215,0,0.2);
  color: gold;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: bold;
  margin-left: 10px;
}

/* ===== Existing styles remain the same ===== */
.chat-sidebar {
  position: fixed;
  left: 0;
  top: 0;
  bottom: 0;
  width: 280px;
  background: rgba(0,0,0,.8);
  backdrop-filter: blur(10px);
  border-right: 1px solid var(--border);
  padding: 80px 15px 20px;
  overflow-y: auto;
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  z-index: 100;
}
.chat-sidebar.open {
  transform: translateX(0);
}
.chat-item {
  padding: 12px;
  margin: 8px 0;
  background: rgba(255,255,255,.05);
  border-radius: 8px;
  cursor: pointer;
  border: 1px solid transparent;
}
.chat-item:hover {
  background: rgba(255,255,255,.1);
}
.chat-item.active {
  border-color: var(--gold1);
  background: rgba(255,215,0,.1);
}
.new-chat-btn {
  background: linear-gradient(45deg,var(--gold1),var(--gold2));
  color: #141209;
  border: none;
  padding: 12px;
  border-radius: 8px;
  font-weight: 800;
  cursor: pointer;
  margin-bottom: 15px;
  width: 100%;
}

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.8);
  backdrop-filter: blur(18px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.status-indicator {
  position: fixed;
  top: 14px;
  right: 120px;
  background: rgba(255,215,0,0.1);
  border: 1px solid rgba(255,215,0,0.3);
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 12px;
  font-weight: 700;
  color: gold;
  display: flex;
  align-items: center;
  gap: 6px;
  z-index: 102;
  backdrop-filter: blur(10px);
}

.image-counter {
  background: rgba(255,215,0,0.1);
  border: 1px solid rgba(255,215,0,0.3);
  border-radius: 10px;
  padding: 8px 12px;
  font-size: 12px;
  color: gold;
  display: none;
  margin-bottom: 10px;
}
</style>
</head>
<body>
<header>
  <button class="menu-btn" id="menuBtn">‚ò∞ Chats</button>
  <div class="brand">
    <div class="logo"></div><span>GoldenSpaceAI</span>
  </div>
  <div class="status-indicator" id="goldenStatus">
    <span>‚ö°</span>
    <span id="goldenBalance">Loading...</span>
  </div>
  <button id="themeToggle" class="theme-toggle">üåô Dark Mode</button>
</header>

<!-- Subscription Plans Modal -->
<div class="modal-overlay" id="plansModal">
  <div class="plans-modal">
    <div class="plans-title">Choose Your Advanced AI Plan</div>
    <div class="plans-subtitle">Unlock powerful AI features with our subscription plans</div>
    
    <div class="plans-container">
      <!-- Plus Plan -->
      <div class="plan-card">
        <div class="plan-name">Plus Plan</div>
        <div class="plan-price">20G<span style="font-size: 1rem; color: #ccc;">/month</span></div>
        <ul class="plan-features">
          <li>GPT-5-Nano Chat Access</li>
          <li>20 Image Generations per month</li>
          <li>Chat Memory & History</li>
          <li>Custom Instructions</li>
          <li>Basic AI Features</li>
        </ul>
        <button class="subscribe-btn" onclick="subscribeToPlan('plus')" id="subscribePlus">
          Subscribe to Plus
        </button>
      </div>
      
      <!-- Pro Plan -->
      <div class="plan-card featured">
        <div class="plan-name">Pro Plan</div>
        <div class="plan-price">40G<span style="font-size: 1rem; color: #ccc;">/month</span></div>
        <ul class="plan-features">
          <li>Full GPT-5 Model Access</li>
          <li>50 Image Generations per month</li>
          <li>Unlimited Chat Messages</li>
          <li>Deep Search & Analysis</li>
          <li>Study & Learn Mode</li>
          <li>Deep Think Feature</li>
          <li>All Plus Features Included</li>
        </ul>
        <button class="subscribe-btn" onclick="subscribeToPlan('pro')" id="subscribePro">
          Subscribe to Pro
        </button>
      </div>
    </div>
    
    <div style="color: #ccc; font-size: 0.9rem;">
      üí° Subscription automatically renews monthly. Cancel anytime.
    </div>
  </div>
</div>

<!-- Existing modals remain... -->
<div class="modal-overlay" id="goldenModal">
  <div class="golden-modal">
    <div class="golden-icon">‚ö°</div>
    <div class="golden-title">Insufficient Golden</div>
    <div class="golden-desc" id="goldenModalDesc">
      You don't have enough Golden for this action.
    </div>
    <div class="golden-balance">
      Your Balance: <strong id="currentBalance">0</strong> Golden
    </div>
    <div class="golden-actions">
      <button class="golden-btn" onclick="showPlansModal()">
        View Subscription Plans
      </button>
      <button class="golden-btn secondary" onclick="closeGoldenModal()">
        Cancel
      </button>
    </div>
  </div>
</div>

<main id="chat">
  <div class="msg ai">
    <small>GoldenSpaceAI</small>
    Welcome to Advanced AI Chat! Choose a subscription plan to unlock powerful AI features including GPT-5, image generation, and advanced capabilities.
    <br><br>
    <button class="subscribe-btn" onclick="showPlansModal()" style="max-width: 200px; margin: 10px 0;">
      View Subscription Plans
    </button>
  </div>
</main>

<div class="composer-wrap">
  <div class="composer">
    <!-- Image Counter -->
    <div class="image-counter" id="imageCounter">
      üñºÔ∏è Images this month: <span id="imagesUsed">0</span>/<span id="imageLimit">0</span>
    </div>
    
    <textarea id="prompt" placeholder="Subscribe to unlock Advanced AI features..." disabled></textarea>
    <div class="actions">
      <button class="act-btn" id="uploadBtn" disabled>üìÅ Upload Image</button>
      <button class="act-btn" id="generateImageBtn" disabled>üñºÔ∏è Generate Image</button>
      <button class="act-btn" id="deepThinkBtn" disabled>ü§î Deep Think</button>
      <button class="act-btn" id="instantBtn" disabled>‚ö° GPT-5-Nano</button>
      <button class="act-btn" id="gpt5Btn" disabled>üöÄ GPT-5 Pro</button>
    </div>
  </div>
</div>

<script>
// Global variables
const chat = document.getElementById("chat");
const promptEl = document.getElementById("prompt");
const uploadBtn = document.getElementById("uploadBtn");
const generateImageBtn = document.getElementById("generateImageBtn");
const deepThinkBtn = document.getElementById("deepThinkBtn");
const instantBtn = document.getElementById("instantBtn");
const gpt5Btn = document.getElementById("gpt5Btn");
const goldenBalanceEl = document.getElementById("goldenBalance");
const imageCounter = document.getElementById("imageCounter");
const imagesUsedEl = document.getElementById("imagesUsed");
const imageLimitEl = document.getElementById("imageLimit");

let fileData = null;
let currentChatId = 'default';
let currentMode = 'normal';
let userBalance = 0;
let userSubscription = null; // null, 'plus', or 'pro'
let subscriptionExpiry = null;
let imagesUsedThisMonth = 0;
let monthlyImageLimit = 0;

const BACKEND = "/chat-advanced-ai";

// Initialize
loadUserBalance();
checkSubscriptionStatus();
updateUI();

// Theme toggle
document.getElementById("themeToggle").onclick = () => {
  document.body.classList.toggle("light");
  document.getElementById("themeToggle").textContent = document.body.classList.contains("light") ? "üåû Light Mode" : "üåô Dark Mode";
};

// Subscription Management
function showPlansModal() {
  document.getElementById('plansModal').style.display = 'flex';
  updateSubscribeButtons();
}

function closePlansModal() {
  document.getElementById('plansModal').style.display = 'none';
}

function updateSubscribeButtons() {
  const plusBtn = document.getElementById('subscribePlus');
  const proBtn = document.getElementById('subscribePro');
  
  if (userBalance >= 20) {
    plusBtn.disabled = false;
    plusBtn.textContent = "Subscribe to Plus";
  } else {
    plusBtn.disabled = true;
    plusBtn.textContent = "Insufficient Golden";
  }
  
  if (userBalance >= 40) {
    proBtn.disabled = false;
    proBtn.textContent = "Subscribe to Pro";
  } else {
    proBtn.disabled = true;
    proBtn.textContent = "Insufficient Golden";
  }
}

async function subscribeToPlan(plan) {
  try {
    const planCost = plan === 'plus' ? 20 : 40;
    
    if (userBalance < planCost) {
      showGoldenModal(`You need ${planCost} Golden to subscribe to ${plan} plan.`);
      return;
    }

    const response = await fetch('/api/subscribe-advanced-ai', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include',
      body: JSON.stringify({ plan: plan })
    });

    const result = await response.json();
    
    if (result.success) {
      userBalance = result.newBalance;
      userSubscription = plan;
      subscriptionExpiry = result.subscription.expires_at;
      imagesUsedThisMonth = 0;
      monthlyImageLimit = plan === 'plus' ? 20 : 50;
      
      updateUI();
      closePlansModal();
      
      addMsg("ai", `üéâ Welcome to ${plan === 'plus' ? 'Plus' : 'Pro'}! Your subscription is active. You now have access to advanced AI features.`);
      
    } else {
      alert('Subscription failed: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    alert('Subscription error: ' + error.message);
  }
}

async function checkSubscriptionStatus() {
  try {
    const response = await fetch('/api/advanced-ai-status', {
      credentials: 'include'
    });
    const data = await response.json();
    
    if (data.active) {
      userSubscription = data.plan;
      subscriptionExpiry = data.expires_at;
      imagesUsedThisMonth = data.images_used || 0;
      monthlyImageLimit = data.plan === 'plus' ? 20 : 50;
      
      updateUI();
    } else {
      userSubscription = null;
      updateUI();
    }
  } catch (error) {
    console.error('Failed to check subscription status:', error);
    userSubscription = null;
    updateUI();
  }
}

function updateUI() {
  if (userSubscription) {
    // User has active subscription
    promptEl.disabled = false;
    promptEl.placeholder = "Type your message... (Shift + Enter = newline)";
    uploadBtn.disabled = false;
    generateImageBtn.disabled = false;
    
    // Enable features based on plan
    if (userSubscription === 'plus') {
      instantBtn.disabled = false;
      gpt5Btn.disabled = true; // Plus users don't get full GPT-5
      deepThinkBtn.disabled = true; // Plus users don't get deep think
      
      // Show image counter for Plus users
      imageCounter.style.display = 'block';
      imagesUsedEl.textContent = imagesUsedThisMonth;
      imageLimitEl.textContent = monthlyImageLimit;
      
      goldenBalanceEl.innerHTML = `<span>‚ö°</span> ${userBalance} Golden <span class="plan-badge">Plus</span>`;
      
    } else if (userSubscription === 'pro') {
      instantBtn.disabled = false;
      gpt5Btn.disabled = false;
      deepThinkBtn.disabled = false;
      
      // Hide image counter for Pro users (unlimited)
      imageCounter.style.display = 'none';
      
      goldenBalanceEl.innerHTML = `<span>üöÄ</span> ${userBalance} Golden <span class="plan-badge">Pro</span>`;
    }
    
  } else {
    // No active subscription
    promptEl.disabled = true;
    promptEl.placeholder = "Subscribe to unlock Advanced AI features...";
    uploadBtn.disabled = true;
    generateImageBtn.disabled = true;
    deepThinkBtn.disabled = true;
    instantBtn.disabled = true;
    gpt5Btn.disabled = true;
    imageCounter.style.display = 'none';
    
    goldenBalanceEl.innerHTML = `<span>üîí</span> ${userBalance} Golden`;
  }
}

async function loadUserBalance() {
  try {
    const response = await fetch('/api/golden-balance', {
      credentials: 'include'
    });
    const data = await response.json();
    
    if (data.loggedIn) {
      userBalance = data.balance;
      goldenBalanceEl.querySelector('span:last-child').textContent = userBalance + ' Golden';
    } else {
      userBalance = 0;
      goldenBalanceEl.innerHTML = `<span>üîí</span> Login Required`;
    }
  } catch (error) {
    console.error('Failed to load balance:', error);
    goldenBalanceEl.innerHTML = `<span>‚ùå</span> Error`;
  }
}

function showGoldenModal(message = "You don't have enough Golden for this action.") {
  document.getElementById("goldenModalDesc").textContent = message;
  document.getElementById("currentBalance").textContent = userBalance;
  document.getElementById("goldenModal").style.display = 'flex';
}

function closeGoldenModal() {
  document.getElementById("goldenModal").style.display = 'none';
}

// Chat functionality
function addMsg(role, text, image = null) {
  const m = document.createElement("div");
  m.className = "msg " + role;
  
  let content = `<small>${role === "user" ? "You" : "GoldenSpaceAI"}</small><div>${text.replace(/\n/g, "<br>")}</div>`;
  
  if (image) {
    if (typeof image === 'string' && image.startsWith('data:image')) {
      content += `
        <div style="text-align: center; margin: 20px 0;">
          <img src="${image}" class="generated-image" alt="Generated Image">
          <div style="margin-top: 10px; font-size: 12px; color: #888;">
            <span>üñºÔ∏è AI Generated Image</span>
          </div>
        </div>
      `;
    } else {
      content += `<img src="${image}" class="uploaded-image" alt="Uploaded image">`;
    }
  }
  
  m.innerHTML = content;
  chat.appendChild(m);
  scrollToBottom();
}

function scrollToBottom() {
  chat.scrollTop = chat.scrollHeight;
}

function spinner() {
  const s = document.createElement("div");
  s.className = "msg ai";
  s.innerHTML = '<div>Thinking...</div>';
  chat.appendChild(s);
  scrollToBottom();
  return s;
}

// Action buttons
uploadBtn.onclick = () => {
  if (!userSubscription) {
    showPlansModal();
    return;
  }
  
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = e => {
    fileData = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
      addMsg("user", "Uploaded image:", e.target.result);
    };
    reader.readAsDataURL(fileData);
  };
  input.click();
};

[generateImageBtn, deepThinkBtn, instantBtn, gpt5Btn].forEach(btn => {
  btn.onclick = () => {
    if (!userSubscription) {
      showPlansModal();
      return;
    }
    
    // Check image limits for Plus users
    if (btn === generateImageBtn && userSubscription === 'plus' && imagesUsedThisMonth >= monthlyImageLimit) {
      showGoldenModal(`You've reached your monthly limit of ${monthlyImageLimit} images. Upgrade to Pro for unlimited images.`);
      return;
    }
    
    // Check feature access
    if (btn === gpt5Btn && userSubscription !== 'pro') {
      showGoldenModal("Full GPT-5 access is only available for Pro subscribers.");
      return;
    }
    
    if (btn === deepThinkBtn && userSubscription !== 'pro') {
      showGoldenModal("Deep Think feature is only available for Pro subscribers.");
      return;
    }
    
    if (promptEl.value.trim()) {
      sendMessage(btn.id.replace('Btn', ''));
    }
  };
});

// Send message function
async function sendMessage(mode = 'normal') {
  if (!userSubscription) {
    showPlansModal();
    return;
  }

  const text = (promptEl.value || "").trim();
  if (!text && !fileData) return;

  addMsg("user", text, fileData ? URL.createObjectURL(fileData) : null);
  const s = spinner();
  
  try {
    const fd = new FormData();
    if (fileData) fd.append("image", fileData);
    fd.append("q", text);
    
    // Set model based on mode and subscription
    if (mode === 'generateImage') {
      fd.append("model", "gpt-image-1");
      
      // Update image counter for Plus users
      if (userSubscription === 'plus') {
        imagesUsedThisMonth++;
        imagesUsedEl.textContent = imagesUsedThisMonth;
      }
    } else if (mode === 'instant') {
      fd.append("model", "gpt-5-nano");
    } else if (mode === 'gpt5') {
      fd.append("model", "gpt-5");
    } else if (mode === 'deepThink') {
      fd.append("model", "gpt-5-deep");
    } else {
      fd.append("model", "gpt-4o");
    }

    const r = await fetch(BACKEND, { method: "POST", body: fd, credentials: "include" });
    const j = await r.json();
    chat.removeChild(s);
    
    if (j.dataUrl) {
      addMsg("ai", "", j.dataUrl);
    } else if (j.reply && j.reply.startsWith('data:image/')) {
      addMsg("ai", "", j.reply);
    } else {
      addMsg("ai", j.reply || j.answer || j.error || "[No reply]");
    }
  } catch (e) {
    chat.removeChild(s);
    addMsg("ai", "‚ö†Ô∏è Error: " + e.message);
  } finally {
    promptEl.value = "";
    fileData = null;
  }
}

// Enter key to send
promptEl.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    if (userSubscription && promptEl.value.trim()) {
      sendMessage(currentMode);
    } else if (!userSubscription) {
      showPlansModal();
    }
  }
});

// Auto-scroll
const observer = new MutationObserver(() => {
  scrollToBottom();
});
observer.observe(chat, { childList: true });

// Periodically refresh balance and subscription status
setInterval(() => {
  loadUserBalance();
  checkSubscriptionStatus();
}, 30000);

// Close modals when clicking outside
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal-overlay')) {
    e.target.style.display = 'none';
  }
});
</script>
</body>
</html>
