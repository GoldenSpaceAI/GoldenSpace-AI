<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GoldenSpaceAI ¬∑ Advanced Chat</title>
<style>
/* --- core theme & layout --- */
body {
  margin: 0;
  font-family: "Segoe UI", Roboto, system-ui;
  color: #fff;
  background: #050505 url("https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=1920&auto=format&fit=crop") center/cover fixed;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
header {
  background: rgba(0,0,0,.6);
  backdrop-filter: blur(10px);
  padding: 12px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid rgba(255,255,255,.1);
}
header h1 {
  font-size: 20px;
  color: gold;
  margin: 0;
}
#projectsPanel {
  position: fixed;
  left: 0; top: 0; bottom: 0;
  width: 260px;
  background: rgba(0,0,0,.8);
  backdrop-filter: blur(8px);
  border-right: 1px solid rgba(255,255,255,.1);
  transform: translateX(-100%);
  transition: .3s;
  padding: 80px 12px 20px;
  overflow-y: auto;
  z-index: 50;
}
#projectsPanel.open { transform: translateX(0); }
.project-item {
  background: rgba(255,255,255,.06);
  border: 1px solid transparent;
  border-radius: 8px;
  margin: 6px 0;
  padding: 10px;
  cursor: pointer;
}
.project-item:hover { background: rgba(255,255,255,.1); }
.project-item.active {
  border-color: gold;
  background: rgba(255,215,0,.1);
}
button {
  font-family: inherit;
  font-weight: 700;
  cursor: pointer;
}
#newProjectBtn {
  background: linear-gradient(45deg,gold,#ffe66b);
  border: none;
  border-radius: 8px;
  padding: 10px;
  width: 100%;
  margin-bottom: 10px;
}
main {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px 150px;
}
.msg {
  max-width: 800px;
  margin: 10px auto;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.1);
  padding: 12px 16px;
  line-height: 1.45;
  backdrop-filter: blur(5px);
}
.msg.user { background: rgba(255,215,0,.1); }
.msg.ai { background: rgba(255,255,255,.07); }
small { opacity:.6; display:block; font-size:12px; margin-bottom:4px; }
#composer {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: rgba(0,0,0,.7);
  backdrop-filter: blur(12px);
  border-top: 1px solid rgba(255,255,255,.1);
  padding: 12px 0;
}
#composerBox {
  width: min(940px,95%);
  margin:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
}
#prompt {
  resize: none;
  min-height: 60px;
  border-radius: 12px;
  padding: 10px;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.2);
  color: #fff;
}
.action-row { display:flex; gap:6px; flex-wrap:wrap; }
.act-btn {
  flex:1;
  min-width:120px;
  border-radius:10px;
  border:1px solid rgba(255,215,0,.3);
  background:rgba(255,215,0,.1);
  color:gold;
  font-weight:800;
  padding:10px;
}
.act-btn:disabled { opacity:.5; cursor:not-allowed; }
</style>
</head>
<body>
<header>
  <button id="menuBtn">‚ò∞ Projects</button>
  <h1>GoldenSpaceAI ¬∑ Advanced Chat</h1>
  <div id="balanceBox">‚ö° Loading...</div>
</header>

<aside id="projectsPanel">
  <button id="newProjectBtn">Ôºã New Project</button>
  <div id="projectsList"></div>
</aside>

<main id="chatArea">
  <div class="msg ai">
    <small>GoldenSpaceAI</small>
    Welcome! Create a new project to start chatting. Your messages and custom instructions will be saved.
  </div>
</main>

<div id="composer">
  <div id="composerBox">
    <textarea id="prompt" placeholder="Type your message..." disabled></textarea>
    <div class="action-row">
      <button class="act-btn" id="instantBtn" disabled>‚ö° GPT-5-Nano</button>
      <button class="act-btn" id="proBtn" disabled>üöÄ GPT-5 Pro</button>
      <button class="act-btn" id="imgBtn" disabled>üñºÔ∏è Image</button>
    </div>
  </div>
</div>

<script>
const chatArea=document.getElementById("chatArea");
const promptEl=document.getElementById("prompt");
const balanceBox=document.getElementById("balanceBox");
const menuBtn=document.getElementById("menuBtn");
const panel=document.getElementById("projectsPanel");
const projectsList=document.getElementById("projectsList");
let currentProject=null,userPlan=null,balance=0,imageLimit=0,imagesUsed=0;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addMsg(role,text){
  const div=document.createElement("div");
  div.className="msg "+role;
  div.innerHTML=`<small>${role==="user"?"You":"GoldenSpaceAI"}</small>${text}`;
  chatArea.appendChild(div);
  chatArea.scrollTop=chatArea.scrollHeight;
}
function spinner(){
  const s=document.createElement("div");
  s.className="msg ai";
  s.textContent="Thinking...";
  chatArea.appendChild(s);
  chatArea.scrollTop=chatArea.scrollHeight;
  return s;
}
function clearChat(){ chatArea.innerHTML=""; }

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Project handling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
menuBtn.onclick=()=>panel.classList.toggle("open");

async function loadProjects(){
  const r=await fetch("/api/projects",{credentials:"include"});
  const data=await r.json();
  projectsList.innerHTML="";
  data.projects?.forEach(p=>{
    const d=document.createElement("div");
    d.className="project-item"+(p.id===currentProject?" active":"");
    d.textContent=p.name;
    d.onclick=()=>selectProject(p.id);
    projectsList.appendChild(d);
  });
}

async function selectProject(id){
  currentProject=id;
  panel.classList.remove("open");
  clearChat();
  const r=await fetch(`/api/messages?project_id=${id}`,{credentials:"include"});
  const data=await r.json();
  if(data.messages?.length){
    data.messages.forEach(m=>addMsg(m.sender,m.content));
  }else addMsg("ai","New project ready. You can add custom instructions or start chatting.");
  updateComposerState(true);
}

document.getElementById("newProjectBtn").onclick=async()=>{
  const name=prompt("Project name:");
  if(!name)return;
  const r=await fetch("/api/projects",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({name})});
  const data=await r.json();
  if(data.success){
    currentProject=data.project.id;
    await loadProjects();
    selectProject(currentProject);
  }else alert("Couldn't create project");
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Balance & Plan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function refreshStatus(){
  const s=await fetch("/api/advanced-ai-status",{credentials:"include"}).then(r=>r.json());
  if(!s.active){
    updateComposerState(false);
    balanceBox.textContent="üîí Subscribe";
    addMsg("ai","No active subscription. Please subscribe to Plus or Pro to chat.");
    return;
  }
  userPlan=s.plan;
  balance=s.balance;
  imageLimit=s.plan==="plus"?20:Infinity;
  imagesUsed=s.images_used||0;
  balanceBox.textContent=`‚ö° ${balance} G ¬∑ ${userPlan.toUpperCase()}`;
  updateComposerState(true);
}

function updateComposerState(active){
  promptEl.disabled=!active;
  document.getElementById("instantBtn").disabled=!active;
  document.getElementById("proBtn").disabled=!(active&&userPlan==="pro");
  document.getElementById("imgBtn").disabled=!active;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Messaging ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendMessage(model){
  if(!currentProject)return alert("Select or create a project first.");
  const text=promptEl.value.trim();
  if(!text)return;
  addMsg("user",text);
  promptEl.value="";
  const wait=spinner();
  const fd=new FormData();
  fd.append("q",text);
  fd.append("model",model);
  fd.append("project_id",currentProject);
  const r=await fetch("/chat-advanced-ai",{method:"POST",body:fd,credentials:"include"});
  const j=await r.json();
  wait.remove();
  addMsg("ai",j.reply||"[No reply]");
}
document.getElementById("instantBtn").onclick=()=>sendMessage("gpt-5-nano");
document.getElementById("proBtn").onclick=()=>sendMessage("gpt-5");
document.getElementById("imgBtn").onclick=()=>sendMessage("gpt-image-1");
promptEl.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage("gpt-5-nano");}
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async()=>{
  await loadProjects();
  await refreshStatus();
})();
</script>
</body>
</html>
