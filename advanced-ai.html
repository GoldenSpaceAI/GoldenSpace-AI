<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GoldenSpaceAI ‚Äî Assistant</title>
  <link rel="icon" href="/generated-icon.png" />
  <!-- Tailwind (CDN) for quick pro styling -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#050814;
      --panel:#0b1020;
      --panel-2:#0e1630;
      --ink:#eaf1ff;
      --muted:#9fb2d7;
      --brand:#ffd24f;
      --accent:#7aa2ff;
      --red:#ff6b6b;
      --green:#36d399;
    }
    html,body{height:100%}
    body{
      background:
        radial-gradient(1200px 800px at 80% -10%, #161f44 0%, #0c122a 50%, #050814 100%),
        linear-gradient(160deg, rgba(255,255,255,.03), rgba(255,255,255,.0));
      color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, Roboto, Arial;
    }
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(8px);
    }
    /* Animated circular voice button (sound-wave look) */
    .voice-btn{
      width:84px;height:84px;border-radius:9999px;
      display:grid;place-items:center;position:relative;
      background:#0f1a3a;border:1px solid rgba(255,255,255,.15);
      transition:transform .08s ease, box-shadow .25s ease, background .25s;
      cursor:pointer;
    }
    .voice-btn:hover{transform:translateY(-1px);box-shadow:0 12px 32px rgba(0,0,0,.35)}
    .voice-btn .pulse, .voice-btn .pulse:before, .voice-btn .pulse:after{
      content:""; position:absolute; inset:-3px; border-radius:inherit;
      border:2px solid rgba(122,162,255,.35);
      animation:pulse 2.2s linear infinite;
    }
    .voice-btn .pulse:before{animation-delay:.5s}
    .voice-btn .pulse:after{animation-delay:1s}
    @keyframes pulse { 0%{ transform:scale(1); opacity:.9 } 70%{ opacity:.05 } 100%{ transform:scale(1.45); opacity:0 } }
    .voice-btn.active{
      background:linear-gradient(0deg, rgba(122,162,255,.2), rgba(122,162,255,.05));
      border-color:rgba(122,162,255,.7);
      box-shadow:0 0 0 2px rgba(122,162,255,.35);
    }
    .icon-mic{
      width:30px;height:30px;border-radius:8px;display:grid;place-items:center;
      background:linear-gradient(180deg, #a7bfff, #7aa2ff);
      color:#0c142a;font-weight:900
    }
    .btn{
      display:inline-flex;align-items:center;gap:.6rem;
      padding:.7rem 1rem;border-radius:.8rem;border:1px solid rgba(255,255,255,.1);
      background:rgba(255,255,255,.04); color:var(--ink);
      transition:transform .05s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.06)}
    .btn-green{background:rgba(54,211,153,.12); border-color:rgba(54,211,153,.35)}
    .btn-red{background:rgba(255,107,107,.12); border-color:rgba(255,107,107,.35)}
    .badge{font-size:.72rem;color:var(--muted);border:1px dashed rgba(255,255,255,.12);padding:.25rem .5rem;border-radius:9999px}

    /* Chat area */
    .msg{max-width:80ch;white-space:pre-wrap}
    .msg.ai{background:rgba(255,255,255,.035);border:1px solid rgba(255,255,255,.08)}
    .msg.you{background:rgba(255,210,79,.07);border:1px solid rgba(255,210,79,.25)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .video-thumb{width:220px;height:124px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.12)}
  </style>
</head>
<body>
  <header class="px-5 md:px-10 py-5 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img src="/generated-icon.png" width="32" height="32" class="rounded-lg" alt="">
      <div>
        <div class="text-lg font-bold">GoldenSpaceAI Assistant</div>
        <div class="text-xs text-gray-300">Ask by text ‚Ä¢ Speak by voice ‚Ä¢ Optional mic & camera</div>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <span id="planBadge" class="badge">Plan: ‚Ä¶</span>
      <a class="btn" href="/plans.html">Upgrade</a>
      <button id="logoutBtn" class="btn">Log out</button>
    </div>
  </header>

  <main class="px-5 md:px-10 pb-28">
    <div class="grid lg:grid-cols-3 gap-6 items-start">
      <!-- Left: chat -->
      <section class="lg:col-span-2 glass rounded-2xl p-4 md:p-6">
        <div id="feed" class="space-y-4">
          <div class="msg ai rounded-2xl p-4">
            <div class="text-sm text-gray-300 mb-1">GoldenSpaceAI</div>
            <div>Hey Faris! I‚Äôm ready. Type your question ‚Äî or press the voice button to talk.</div>
          </div>
        </div>

        <!-- Compose -->
        <div class="mt-4 grid md:grid-cols-[1fr_auto] gap-3 items-center">
          <div class="flex gap-3">
            <input id="input" class="flex-1 w-full bg-transparent border border-white border-opacity-10 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Type your message‚Ä¶" />
            <button id="sendBtn" class="btn">Send</button>
          </div>

          <div class="flex items-center gap-3">
            <!-- Circular voice button -->
            <button id="voiceBtn" class="voice-btn" title="Hold to talk / tap to toggle">
              <span class="pulse" aria-hidden="true"></span>
              <span class="icon-mic">üé§</span>
            </button>
            <div class="text-sm text-gray-300">
              <div class="font-semibold">Voice</div>
              <div class="opacity-70" id="voiceHint">Tap to speak. I‚Äôll answer out loud.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Right: devices & options -->
      <aside class="glass rounded-2xl p-4 md:p-6 space-y-4">
        <div class="text-sm text-gray-300">Devices</div>
        <div class="flex gap-3">
          <button id="micToggle" class="btn btn-green">Enable Mic</button>
          <button id="camToggle" class="btn">Enable Camera</button>
        </div>

        <div id="videoWrap" class="hidden">
          <div class="text-xs text-gray-400">Camera preview (optional)</div>
          <div class="video-thumb mt-2">
            <video id="cam" autoplay playsinline muted></video>
          </div>
        </div>

        <div class="pt-2">
          <div class="text-sm text-gray-300 mb-1">Reply voice</div>
          <label class="inline-flex items-center gap-2">
            <input id="ttsToggle" type="checkbox" class="form-checkbox" checked />
            <span class="text-sm text-gray-300">Speak AI replies</span>
          </label>
        </div>

        <div class="pt-2">
          <div class="text-sm text-gray-300 mb-1">Tips</div>
          <ul class="text-sm text-gray-400 space-y-1 list-disc list-inside">
            <li>You can block mic/camera anytime; the page works without them.</li>
            <li>If speech-to-text isn‚Äôt supported, the voice button fills after you stop talking.</li>
            <li>Go to <a href="/learn-physics.html" class="text-blue-300 underline">Learn Physics</a> or <a href="/create-planet.html" class="text-blue-300 underline">Create Planet</a> from the top menu.</li>
          </ul>
        </div>
      </aside>
    </div>
  </main>

  <!-- Floating footer -->
  <footer class="fixed bottom-0 left-0 right-0 py-3 px-5 md:px-10">
    <div class="glass rounded-2xl px-4 py-3 flex items-center justify-between text-xs text-gray-300">
      <div>¬©Ô∏è GoldenSpaceAI ¬∑ <a class="underline" href="/privacy.html">Privacy</a> ¬∑ <a class="underline" href="/terms.html">Terms</a></div>
      <div id="usage" class="mono opacity-80"></div>
    </div>
  </footer>

  <script>
    // ---------- Simple helpers ----------
    const $ = sel => document.querySelector(sel);
    const feed = $('#feed');
    const input = $('#input');
    const sendBtn = $('#sendBtn');
    const voiceBtn = $('#voiceBtn');
    const voiceHint = $('#voiceHint');
    const micToggle = $('#micToggle');
    const camToggle = $('#camToggle');
    const videoWrap = $('#videoWrap');
    const camEl = $('#cam');
    const ttsToggle = $('#ttsToggle');
    const usage = $('#usage');
    const planBadge = $('#planBadge');
    const logoutBtn = $('#logoutBtn');

    const addMsg = (who, text) => {
      const el = document.createElement('div');
      el.className = 'msg ' + (who === 'you' ? 'you' : 'ai') + ' rounded-2xl p-4';
      el.innerHTML = \`<div class="text-sm text-gray-300 mb-1">\${who === 'you' ? 'You' : 'GoldenSpaceAI'}</div>\` +
                     '<div>' + (text || '').replace(/</g,'&lt;') + '</div>';
      feed.appendChild(el);
      el.scrollIntoView({behavior:'smooth',block:'end'});
    };

    // ---------- Session / limits ----------
    async function refreshMe(){
      try{
        const r = await fetch('/api/me');
        const j = await r.json();
        planBadge.textContent = 'Plan: ' + j.plan.toUpperCase();
        usage.textContent = \`Ask: \${j.remaining?.ask ?? '‚àû'} ¬∑ Search: \${j.remaining?.search ?? '‚àû'} ¬∑ Physics: \${j.remaining?.physics ?? '‚àû'}\`;
      }catch(e){}
    }
    refreshMe();

    logoutBtn.onclick = async ()=>{
      await fetch('/logout',{method:'POST'});
      window.location.href = '/login.html';
    };

    // ---------- Send text to backend ----------
    async function ask(q){
      addMsg('you', q);
      input.value = '';
      try{
        const r = await fetch('/ask', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({question: q})
        });
        const j = await r.json();
        const answer = j.answer || 'No response.';
        addMsg('ai', answer);
        refreshMe();
        if(ttsToggle.checked){ speak(answer); }
      }catch(err){
        addMsg('ai', 'Error contacting the AI.');
      }
    }
    sendBtn.onclick = ()=>{ const q = input.value.trim(); if(q) ask(q); };
    input.addEventListener('keydown', e => { if(e.key === 'Enter'){ const q = input.value.trim(); if(q) ask(q); } });

    // ---------- Speech Synthesis (AI speaks) ----------
    function speak(text){
      try{
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1; u.pitch = 1; u.volume = 1;
        const voice = speechSynthesis.getVoices().find(v=>/en|US|GB/i.test(v.lang));
        if(voice) u.voice = voice;
        speechSynthesis.speak(u);
      }catch(e){}
    }

    // ---------- Mic (and optional speech-to-text) ----------
    let stream = null;
    let isListening = false;
    let rec = null; // Web Speech Recognition

    function initRecognition(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return null;
      const r = new SR();
      r.lang = 'en-US';
      r.interimResults = true;
      r.continuous = false;
      r.onstart = ()=>{ voiceHint.textContent = 'Listening‚Ä¶ speak now'; };
      r.onresult = (ev)=>{
        let finalText = '';
        for (const res of ev.results){
          if(res.isFinal) finalText += res[0].transcript + ' ';
        }
        if(finalText.trim()) ask(finalText.trim());
      };
      r.onend = ()=>{
        isListening = false;
        voiceBtn.classList.remove('active');
        voiceHint.textContent = 'Tap to speak. I‚Äôll answer out loud.';
      };
      return r;
    }

    async function enableMic(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({audio:true});
        micToggle.classList.add('btn-green');
        micToggle.textContent = 'Mic Enabled';
        return true;
      }catch(e){
        micToggle.classList.remove('btn-green');
        micToggle.classList.add('btn-red');
        micToggle.textContent = 'Mic Blocked';
        return false;
      }
    }
    micToggle.onclick = enableMic;

    // Voice button toggles recognition if available, else just records permission and shows hint
    voiceBtn.onclick = async ()=>{
      // ensure mic permission
      if(!stream){
        const ok = await enableMic();
        if(!ok) return;
      }
      if(!rec) rec = initRecognition();

      if(rec){
        if(!isListening){ // start
          isListening = true;
          voiceBtn.classList.add('active');
          voiceHint.textContent = 'Listening‚Ä¶';
          rec.start();
        }else{ // stop early
          rec.stop();
        }
      }else{
        // No Web Speech API: show a small info & let user type
        voiceHint.textContent = 'Speech-to-text not supported in this browser. Type your question.';
        voiceBtn.classList.add('active');
        setTimeout(()=>voiceBtn.classList.remove('active'),800);
      }
    };

    // ---------- Camera (optional preview only) ----------
    let camOn = false;
    camToggle.onclick = async ()=>{
      if(!camOn){
        try{
          const s = await navigator.mediaDevices.getUserMedia({video:true});
          camEl.srcObject = s;
          videoWrap.classList.remove('hidden');
          camToggle.classList.add('btn-green');
          camToggle.textContent = 'Camera On';
          camOn = true;
        }catch(e){
          camToggle.classList.add('btn-red');
          camToggle.textContent = 'Camera Blocked';
        }
      }else{
        const s = camEl.srcObject;
        if(s) s.getTracks().forEach(t=>t.stop());
        camEl.srcObject = null;
        videoWrap.classList.add('hidden');
        camToggle.classList.remove('btn-green','btn-red');
        camToggle.textContent = 'Enable Camera';
        camOn = false;
      }
    };
  </script>
</body>
</html>
