<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GoldenSpaceAI ‚Ä¢ Advanced Chat</title>
<style>
:root {
  --gold1:#ffd700;
  --gold2:#ffed4e;
  --border:rgba(255,255,255,.15);
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:"Segoe UI",Roboto,sans-serif;
  color:#fff;
  background:#000 url("https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=2400&auto=format&fit=crop") center/cover fixed no-repeat;
  min-height:100vh;
  display:flex;
  overflow:hidden;
}
/* Sidebar Styles */
#sidebar{
  width:300px;
  background:rgba(0,0,0,.85);
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  height:100vh;
  transition:transform 0.3s ease;
}
.sidebar-header{
  padding:20px;
  border-bottom:1px solid var(--border);
}
.new-chat-btn{
  width:100%;
  padding:12px;
  background:linear-gradient(45deg,var(--gold1),var(--gold2));
  border:none;
  border-radius:10px;
  color:#141000;
  font-weight:800;
  cursor:pointer;
  margin-bottom:15px;
}
.custom-instructions{
  width:100%;
  padding:10px;
  background:rgba(255,255,255,.08);
  border:1px solid var(--border);
  border-radius:8px;
  color:#fff;
  font-size:12px;
  resize:vertical;
  min-height:60px;
  margin-bottom:15px;
}
.chats-list{
  flex:1;
  overflow-y:auto;
  padding:0 15px 15px;
}
.chat-item{
  padding:12px;
  margin-bottom:8px;
  background:rgba(255,255,255,.08);
  border-radius:8px;
  cursor:pointer;
  border:1px solid transparent;
  transition:all 0.2s ease;
}
.chat-item:hover{
  background:rgba(255,255,255,.12);
}
.chat-item.active{
  border-color:var(--gold1);
  background:rgba(255,215,0,.1);
}
.chat-preview{
  font-size:12px;
  color:#aaa;
  margin-top:4px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
/* Main Content */
#main-content{
  flex:1;
  display:flex;
  flex-direction:column;
  height:100vh;
}
header{
  background:rgba(0,0,0,.7);
  backdrop-filter:blur(10px);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 20px;
  border-bottom:1px solid var(--border);
}
header .logo{
  width:34px;
  height:34px;
  border-radius:50%;
  background:conic-gradient(from 200deg,var(--gold1),var(--gold2),#b89200,var(--gold1));
  box-shadow:0 0 10px rgba(255,215,0,.4);
}
header h1{
  margin:0;
  font-size:18px;
  color:var(--gold1);
  font-weight:900;
}
#userBalance{
  font-size:14px;
  color:#ddd;
}
.menuBtn{
  background:none;
  border:none;
  color:var(--gold1);
  font-size:24px;
  font-weight:bold;
  cursor:pointer;
  margin-left:10px;
}
/* Lock Screen */
#locked{
  flex:1;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.8);
  backdrop-filter:blur(20px);
}
.lockBox{
  background:rgba(0,0,0,.9);
  backdrop-filter:blur(15px);
  padding:40px 30px;
  border:2px solid var(--gold1);
  border-radius:20px;
  max-width:400px;
  text-align:center;
  box-shadow:0 0 50px rgba(255,215,0,.3);
}
.lockBox h2{
  color:var(--gold1);
  font-size:28px;
  margin:0 0 15px 0;
}
.lockBox p{
  font-size:16px;
  margin-bottom:25px;
  line-height:1.5;
}
.lockBtn{
  background:linear-gradient(45deg,var(--gold1),var(--gold2));
  border:none;
  border-radius:12px;
  padding:15px 30px;
  font-weight:800;
  font-size:16px;
  color:#141000;
  cursor:pointer;
  transition:transform 0.2s ease;
}
.lockBtn:hover{
  transform:scale(1.05);
}
/* Chat Area */
#chatArea{
  flex:1;
  overflow-y:auto;
  padding:20px;
  display:none;
}
.msg{
  max-width:800px;
  margin:15px auto;
  padding:15px 20px;
  border-radius:15px;
  border:1px solid var(--border);
  backdrop-filter:blur(6px);
  word-wrap:break-word;
  animation:fadeIn 0.3s ease;
}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px);}
  to{opacity:1;transform:translateY(0);}
}
.msg.user{
  background:linear-gradient(180deg,rgba(255,215,0,.12),rgba(255,215,0,.08));
  margin-left:auto;
  margin-right:0;
}
.msg.ai{
  background:rgba(15,15,30,.6);
}
.msg small{
  display:block;
  font-size:.75rem;
  opacity:.6;
  margin-bottom:5px;
}
.msg img{
  max-width:100%;
  border-radius:10px;
  margin-top:10px;
  border:1px solid var(--border);
}
.thinking{
  color:var(--gold1);
  font-style:italic;
}
/* Feature Bar */
#featureBar{
  display:none;
  justify-content:center;
  gap:15px;
  padding:15px;
  background:rgba(0,0,0,.7);
  border-bottom:1px solid var(--border);
}
.featureBtn{
  background:rgba(255,255,255,.1);
  border:1px solid var(--border);
  border-radius:12px;
  color:var(--gold1);
  padding:12px 20px;
  text-align:center;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s ease;
  min-width:140px;
}
.featureBtn:hover{
  background:rgba(255,255,255,.15);
  transform:translateY(-2px);
}
.featureBtn.pro-thinking{
  background:linear-gradient(45deg,#8b5cf6,#a855f7);
  color:white;
  border-color:#8b5cf6;
}
/* Footer */
footer{
  background:rgba(0,0,0,.75);
  backdrop-filter:blur(12px);
  border-top:1px solid var(--border);
  padding:20px;
  display:none;
}
#composer{
  display:flex;
  gap:12px;
  max-width:900px;
  margin:auto;
  align-items:end;
}
#prompt{
  flex:1;
  resize:none;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.2);
  background:rgba(255,255,255,.08);
  color:#fff;
  padding:12px 16px;
  min-height:50px;
  font-family:inherit;
}
button.send{
  background:linear-gradient(45deg,var(--gold1),var(--gold2));
  border:none;
  border-radius:12px;
  padding:12px 24px;
  font-weight:800;
  color:#141000;
  cursor:pointer;
  transition:transform 0.2s ease;
}
button.send:hover{
  transform:scale(1.05);
}
/* Mobile Responsive */
@media(max-width:768px){
  #sidebar{
    position:fixed;
    left:-300px;
    top:0;
    height:100vh;
    z-index:1000;
  }
  #sidebar.active{
    left:0;
  }
  .menuBtn{
    display:block;
  }
}
</style>
</head>
<body>
<!-- Sidebar -->
<div id="sidebar">
  <div class="sidebar-header">
    <button class="new-chat-btn" id="newChat">Ôºã New Chat</button>
    <textarea class="custom-instructions" id="customInstructions" placeholder="Custom instructions for AI (e.g., 'Always respond in Spanish', 'Be concise', etc.)"></textarea>
  </div>
  <div class="chats-list" id="chatsList">
    <!-- Chat items will be loaded here -->
  </div>
</div>

<!-- Main Content -->
<div id="main-content">
  <header>
    <div style="display:flex;align-items:center;gap:12px;">
      <button class="menuBtn" id="toggleSidebar">‚ò∞</button>
      <div class="logo"></div>
      <h1>GoldenSpaceAI</h1>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <span id="userBalance">G: ‚Äî</span>
    </div>
  </header>

  <!-- Lock Screen -->
  <div id="locked">
    <div class="lockBox">
      <div style="font-size:60px;margin-bottom:20px;">üîí</div>
      <h2>Advanced Chat Locked</h2>
      <p>This premium feature costs <b style="color:var(--gold1);">20 G</b> per month</p>
      <p>Unlock unlimited advanced conversations with GPT-5 and image generation capabilities</p>
      <button class="lockBtn" id="unlockBtn">Activate for 20 G</button>
    </div>
  </div>

  <!-- Feature Bar -->
  <div id="featureBar">
    <div class="featureBtn" id="genImage">üñºÔ∏è Generate Image</div>
    <div class="featureBtn" id="studyLearn">üìö Study & Learn</div>
    <div class="featureBtn pro-thinking" id="proThinking">üöÄ Pro Thinking (GPT-5)</div>
  </div>

  <!-- Chat Area -->
  <div id="chatArea">
    <div class="msg ai">
      <small>GoldenSpaceAI</small>
      Welcome to Advanced Chat! You have access to GPT-5, image generation, and smart features. 
      Start by typing a message or using the feature buttons above.
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div id="composer">
      <textarea id="prompt" placeholder="Type your message‚Ä¶" rows="1"></textarea>
      <button class="send" id="sendBtn">Send</button>
    </div>
  </footer>
</div>

<script>
// Global variables
let currentChat = null;
let currentMode = "normal";
let customInstructions = "";
let chatHistory = [];

// DOM Elements
const sidebar = document.getElementById('sidebar');
const chatsList = document.getElementById('chatsList');
const chatArea = document.getElementById('chatArea');
const lockedScreen = document.getElementById('locked');
const featureBar = document.getElementById('featureBar');
const footer = document.getElementById('footer');
const promptInput = document.getElementById('prompt');
const userBalance = document.getElementById('userBalance');

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  checkSubscriptionStatus();
  loadCustomInstructions();
  setupEventListeners();
});

// Event Listeners
function setupEventListeners() {
  document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
  document.getElementById('newChat').addEventListener('click', createNewChat);
  document.getElementById('unlockBtn').addEventListener('click', unlockAdvancedChat);
  document.getElementById('sendBtn').addEventListener('click', sendMessage);
  document.getElementById('genImage').addEventListener('click', () => activateFeature('image'));
  document.getElementById('studyLearn').addEventListener('click', () => activateFeature('study'));
  document.getElementById('proThinking').addEventListener('click', () => activateFeature('pro'));
  
  document.getElementById('customInstructions').addEventListener('change', saveCustomInstructions);
  
  promptInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  promptInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
  });
}

// Sidebar toggle
function toggleSidebar() {
  sidebar.classList.toggle('active');
}

// Subscription check
async function checkSubscriptionStatus() {
  try {
    const response = await fetch("/api/advanced-ai-status", { credentials: "include" });
    const data = await response.json();
    
    userBalance.textContent = `G: ${data.balance ?? "--"}`;
    
    if (!data.active) {
      lockedScreen.style.display = "flex";
      chatArea.style.display = "none";
      featureBar.style.display = "none";
      footer.style.display = "none";
    } else {
      lockedScreen.style.display = "none";
      chatArea.style.display = "block";
      featureBar.style.display = "flex";
      footer.style.display = "block";
      loadChats();
    }
  } catch (error) {
    console.error("Status check failed:", error);
    lockedScreen.style.display = "flex";
  }
}

// Unlock advanced chat
async function unlockAdvancedChat() {
  try {
    const response = await fetch("/api/subscribe-advanced-ai", {
      method: "POST",
      credentials: "include"
    });
    const data = await response.json();
    
    if (data.success) {
      alert("‚úÖ Advanced Chat activated successfully!");
      location.reload();
    } else {
      alert("‚ùå " + (data.error || "Activation failed"));
    }
  } catch (error) {
    alert("‚ùå Error: " + error.message);
  }
}

// Chat Management
async function loadChats() {
  try {
    const response = await fetch("/api/projects", { credentials: "include" });
    const data = await response.json();
    
    chatsList.innerHTML = "";
    
    if (!data.projects?.length) {
      chatsList.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">No chats yet</div>';
      return;
    }
    
    data.projects.forEach(project => {
      const chatItem = document.createElement('div');
      chatItem.className = 'chat-item';
      chatItem.innerHTML = `
        <div style="font-weight:600;">${project.name}</div>
        <div class="chat-preview">${project.description || 'No messages yet'}</div>
        <div style="margin-top:5px; display:flex; justify-content:space-between; align-items:center;">
          <small style="color:#666;">${new Date(project.created_at).toLocaleDateString()}</small>
          <span class="delete-btn" style="color:#ff5555; cursor:pointer; font-size:12px;">‚úï</span>
        </div>
      `;
      
      chatItem.querySelector('.delete-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        deleteChat(project.id);
      });
      
      chatItem.addEventListener('click', () => openChat(project));
      chatsList.appendChild(chatItem);
    });
  } catch (error) {
    console.error("Failed to load chats:", error);
  }
}

async function createNewChat() {
  const chatName = prompt("Enter chat name:", `Chat ${new Date().toLocaleDateString()}`);
  if (!chatName) return;
  
  try {
    const response = await fetch("/api/projects/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ name: chatName, description: "New chat" })
    });
    
    const data = await response.json();
    
    if (data.success) {
      loadChats();
      openChat(data.project);
    }
  } catch (error) {
    alert("Failed to create chat: " + error.message);
  }
}

async function openChat(project) {
  currentChat = project.id;
  
  // Update active chat UI
  document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
  event.currentTarget.classList.add('active');
  
  // Load chat messages
  await loadChatMessages(project.id);
}

async function loadChatMessages(chatId) {
  try {
    const response = await fetch(`/api/chat/${chatId}`, { credentials: "include" });
    const data = await response.json();
    
    chatArea.innerHTML = "";
    chatHistory = [];
    
    if (data.messages?.length) {
      data.messages.forEach(message => {
        addMessageToChat(message.sender, message.content, false);
        // Keep last 5 messages for context
        if (chatHistory.length < 5) {
          chatHistory.push({
            role: message.sender === 'ai' ? 'assistant' : 'user',
            content: message.content
          });
        }
      });
    } else {
      addMessageToChat('ai', 'Welcome to your new chat! Start by sending a message.', false);
    }
    
    chatArea.scrollTop = chatArea.scrollHeight;
  } catch (error) {
    console.error("Failed to load messages:", error);
  }
}

async function deleteChat(chatId) {
  if (!confirm("Are you sure you want to delete this chat?")) return;
  
  try {
    await fetch(`/api/projects/${chatId}`, {
      method: "DELETE",
      credentials: "include"
    });
    loadChats();
    
    if (currentChat === chatId) {
      currentChat = null;
      chatArea.innerHTML = '<div class="msg ai"><small>GoldenSpaceAI</small>Select or create a chat to start messaging.</div>';
    }
  } catch (error) {
    alert("Failed to delete chat: " + error.message);
  }
}

// Message Handling
async function sendMessage() {
  const message = promptInput.value.trim();
  if (!message || !currentChat) return;
  
  // Add user message to chat
  addMessageToChat('user', message, true);
  promptInput.value = "";
  promptInput.style.height = 'auto';
  
  // Show thinking indicator
  const thinkingMsg = addMessageToChat('ai', '<span class="thinking">Thinking...</span>', true);
  
  try {
    const requestBody = {
      q: message,
      project_id: currentChat,
      mode: currentMode,
      custom_instructions: customInstructions,
      chat_history: chatHistory
    };
    
    const response = await fetch("/chat-advanced-ai", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(requestBody)
    });
    
    const data = await response.json();
    
    // Remove thinking message and add actual response
    thinkingMsg.remove();
    
    if (data.imageUrl) {
      // Handle image response
      addMessageToChat('ai', `![Generated Image](${data.imageUrl})`, true);
    } else {
      addMessageToChat('ai', data.reply || data.error || "No response received", true);
    }
    
    // Reset mode after use
    currentMode = "normal";
    
  } catch (error) {
    thinkingMsg.remove();
    addMessageToChat('ai', "Error: " + error.message, true);
  }
}

function addMessageToChat(sender, content, saveToHistory = false) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `msg ${sender}`;
  
  // Handle image URLs in content
  let formattedContent = content;
  const imageMatch = content.match(/!\[.*?\]\((.*?)\)/);
  if (imageMatch) {
    formattedContent = content.replace(/!\[.*?\]\((.*?)\)/, 
      `<img src="${imageMatch[1]}" alt="Generated image" onload="this.scrollIntoView({behavior: 'smooth'})">`);
  }
  
  messageDiv.innerHTML = `<small>${sender === 'ai' ? 'GoldenSpaceAI' : 'You'}</small>${formattedContent}`;
  chatArea.appendChild(messageDiv);
  chatArea.scrollTop = chatArea.scrollHeight;
  
  // Save to chat history (last 5 messages)
  if (saveToHistory && sender === 'user') {
    chatHistory.push({ role: 'user', content: content });
    if (chatHistory.length > 5) chatHistory.shift();
  }
  
  return messageDiv;
}

// Feature Management
function activateFeature(feature) {
  switch(feature) {
    case 'image':
      currentMode = 'image';
      alert('üñºÔ∏è Image generation activated! Your next message will generate an image.');
      break;
    case 'study':
      currentMode = 'study';
      alert('üìö Study mode activated! AI will provide detailed explanations.');
      break;
    case 'pro':
      currentMode = 'pro';
      alert('üöÄ Pro Thinking (GPT-5) activated! Your next message will use advanced reasoning.');
      break;
  }
  
  // Highlight active feature
  document.querySelectorAll('.featureBtn').forEach(btn => btn.style.opacity = '1');
  event.currentTarget.style.opacity = '0.8';
}

// Custom Instructions
function loadCustomInstructions() {
  const saved = localStorage.getItem('goldenspace_custom_instructions');
  if (saved) {
    document.getElementById('customInstructions').value = saved;
    customInstructions = saved;
  }
}

function saveCustomInstructions() {
  customInstructions = document.getElementById('customInstructions').value;
  localStorage.setItem('goldenspace_custom_instructions', customInstructions);
}

// Auto-resize textarea
promptInput.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});
</script>
</body>
</html>
