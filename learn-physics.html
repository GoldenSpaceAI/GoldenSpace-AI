<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldenSpaceAI ‚Ä¢ Learn Physics</title>

  <style>
    :root{
      --bg:#0a0e15; --panel:#121827; --panel2:#0c1220;
      --border:#1f2a40; --gold:#f6c64a; --gold2:#eb8b36;
      --text:#e6f0ff; --muted:#99a3b5; --ok:#9cff9c; --err:#ff9a9a;
      --shadow:0 18px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);
      font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 520px at 85% -10%, rgba(246,198,74,.12), transparent 60%),
        radial-gradient(900px 480px at -10% 0%, rgba(246,198,74,.08), transparent 60%),
        var(--bg);
      min-height:100svh;
    }
    a{color:inherit;text-decoration:none}

    /* Topbar */
    .top{position:sticky;top:0;z-index:20;padding:14px 18px 10px;
      background:linear-gradient(180deg,rgba(10,14,21,.92),rgba(10,14,21,.65) 60%,transparent);
      border-bottom:1px solid var(--border);backdrop-filter:blur(8px);
      display:flex;align-items:center;gap:12px}
    .back{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;font-weight:900;font-size:14px;
      background:linear-gradient(180deg,var(--gold),var(--gold2));color:#1b1300;border:1px solid rgba(0,0,0,.18);
      box-shadow:0 10px 26px rgba(246,198,74,.25);transition:.2s}
    .back:hover{transform:translateY(-1px);filter:saturate(1.05)}
    .title{font-weight:900;letter-spacing:.3px;color:var(--gold);font-size:clamp(22px,2.6vw,28px);text-shadow:0 0 18px rgba(246,198,74,.25)}
    .spacer{flex:1}
    .balance{font-weight:800;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:10px;background:#0d1420}

    /* Layout */
    .wrap{max-width:1200px;margin:26px auto;padding:0 18px;display:grid;gap:18px;grid-template-columns:1.4fr .9fr}
    @media (max-width:1100px){.wrap{grid-template-columns:1fr}}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow)}
    .panel h2{margin:0 0 10px;font-size:18px;color:var(--gold);font-weight:900}
    .sub{margin:6px 0 14px;color:var(--muted);font-size:14px}

    /* Topics */
    .topics{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .card{background:#0d1420;border:1px solid var(--border);border-radius:14px;padding:14px;cursor:pointer;transition:.12s}
    .card:hover{transform:translateY(-2px);box-shadow:0 14px 30px rgba(0,0,0,.25)}
    .card h3{margin:0 0 6px;font-size:16px;display:flex;align-items:center;gap:8px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:800;color:#1b1300;background:linear-gradient(180deg,#f8d772,#e7b72f)}
    .tiny{font-size:12px;color:var(--muted)}
    .formula{font-family:ui-monospace,Menlo,Consolas,monospace;color:#ffe08a}

    details{margin-top:8px;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    summary{cursor:pointer;padding:10px 12px;background:#0f1725;list-style:none;font-weight:800}
    summary::-webkit-details-marker{display:none}
    details .content{padding:12px;background:#0b111c}

    /* Tutor */
    .chat{height:320px;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:10px;background:#0b1219;border:1px solid var(--border);border-radius:12px}
    .bubble{padding:10px 12px;border-radius:12px;border:1px solid #22304a;background:#0e1622}
    .me{align-self:flex-end;background:#121b29;border-color:#3a2a00}
    .assistant{align-self:flex-start}
    .controls{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:start;margin-top:10px}
    textarea,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1219;color:var(--text)}
    .btn{border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer;background:linear-gradient(180deg,var(--gold),var(--gold2));color:#1b1300;border:1px solid rgba(0,0,0,.18);box-shadow:0 10px 26px rgba(246,198,74,.28);transition:.2s}
    .btn:hover{transform:translateY(-1px);filter:saturate(1.05)}
    .modes{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 6px}
    .tag{font-size:11px;border:1px solid var(--border);padding:4px 8px;border-radius:999px;color:var(--muted);cursor:pointer}
    .tag.active{color:#000;background:linear-gradient(180deg,#f8d772,#e7b72f);border-color:#3b2a00}
    .status{margin-top:6px;font-size:12px;color:var(--muted)}

    /* 4G Lock Overlay */
    .golden-overlay{position:fixed;inset:0;background:rgba(11,16,32,.96);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;z-index:10000}
    .golden-unlock{background:linear-gradient(135deg,#0f1624,#0b1320);border:2px solid var(--gold);border-radius:20px;padding:26px;text-align:center;max-width:420px;width:92%}
    .golden-unlock h2{color:var(--gold);margin:0 0 8px}
    .golden-unlock .desc{color:var(--muted);margin:0 0 10px}
    .price{font-size:36px;font-weight:900;color:var(--gold);margin:10px 0}
    .price span{font-size:14px;color:var(--muted)}
    .balance-info{color:var(--muted);margin:8px 0}
    .unlock-btn{width:100%;margin-top:10px;border-radius:12px;padding:12px 16px;font-weight:900;cursor:pointer;background:linear-gradient(180deg,var(--gold),var(--gold2));color:#1a1300;border:none}
    .links{margin-top:14px}
    .links a{color:var(--gold);margin:0 10px}
    #statusMessage{margin-top:8px;min-height:20px}
  </style>
</head>
<body>
  <!-- ==================== TOP ==================== -->
  <div class="top">
    <a class="back" href="/">Home</a>
    <div class="title">Learn Physics</div>
    <div class="spacer"></div>
    <div class="balance">Balance: <span id="uiBalance">0</span> G</div>
  </div>

  <!-- ==================== 4G LOCK OVERLAY ==================== -->
  <div id="goldenOverlay" class="golden-overlay" hidden>
    <div class="golden-unlock">
      <div style="font-size:54px;margin-bottom:8px">üîí</div>
      <h2>Unlock This Feature</h2>
      <p class="desc">Access <strong>Learn Physics</strong> for 30 days</p>
      <div class="price">4G <span>per month</span></div>
      <div class="balance-info">Your balance: <span id="userBalance">0</span> G</div>
      <button class="unlock-btn" id="unlockBtn">UNLOCK FOR 4G</button>
      <div id="statusMessage"></div>
      <div class="links">
        <a href="/buy-golden.html">Need Golden? Buy here</a>
        <a href="/">Back to Home</a>
      </div>
    </div>
  </div>

  <!-- ==================== MAIN ==================== -->
  <main class="wrap" id="pageContent" style="visibility:hidden">
    <!-- LEFT: topics -->
    <section class="panel">
      <h2>Core Topics</h2>
      <p class="sub">Tap a topic to focus; expand formulas to revise quickly.</p>

      <div id="topics" class="topics">
        <!-- (Kept compact but polished) -->
        <div class="card" data-topic="Mechanics">
          <h3>Mechanics <span class="pill">Kinematics & Dynamics</span></h3>
          <div class="tiny">Forces, motion, energy, momentum.</div>
          <details><summary>Key formulas</summary>
            <div class="content">
              <p><span class="formula">v = u + at</span> ‚Ä¢ <span class="formula">s = ut + ¬Ωat¬≤</span> ‚Ä¢ <span class="formula">v¬≤ = u¬≤ + 2as</span></p>
              <p><span class="formula">F = ma</span> ‚Ä¢ <span class="formula">W = Fs</span> ‚Ä¢ <span class="formula">P = W/t</span></p>
            </div>
          </details>
        </div>

        <div class="card" data-topic="Rotational Dynamics">
          <h3>Rotational Dynamics <span class="pill">Torque</span></h3>
          <div class="tiny">Angular motion, inertia, rolling.</div>
          <details><summary>Key formulas</summary>
            <div class="content">
              <p><span class="formula">œÑ = IŒ±</span> ‚Ä¢ <span class="formula">L = Iœâ</span> ‚Ä¢ <span class="formula">K‚Ççrot‚Çé = ¬ΩIœâ¬≤</span></p>
            </div>
          </details>
        </div>

        <div class="card" data-topic="Thermodynamics">
          <h3>Thermodynamics <span class="pill">Laws</span></h3>
          <div class="tiny">First/second law; PV diagrams; engines.</div>
          <details><summary>Key formulas</summary>
            <div class="content">
              <p><span class="formula">ŒîU = Q - W</span> ‚Ä¢ <span class="formula">PV = nRT</span> ‚Ä¢ <span class="formula">Œ∑ = 1 - T<sub>c</sub>/T<sub>h</sub></span></p>
            </div>
          </details>
        </div>

        <div class="card" data-topic="Electricity">
          <h3>Electricity <span class="pill">DC Circuits</span></h3>
          <div class="tiny">Ohm‚Äôs law; series/parallel; power.</div>
          <details><summary>Key formulas</summary>
            <div class="content">
              <p><span class="formula">V = IR</span> ‚Ä¢ <span class="formula">P = VI = I¬≤R = V¬≤/R</span></p>
            </div>
          </details>
        </div>

        <div class="card" data-topic="Waves & Optics">
          <h3>Waves & Optics <span class="pill">Interference</span></h3>
          <div class="tiny">Wave equation, diffraction, lenses.</div>
          <details><summary>Key formulas</summary>
            <div class="content">
              <p><span class="formula">v = fŒª</span> ‚Ä¢ <span class="formula">Œîy = ŒªL/d</span> ‚Ä¢ <span class="formula">1/f = 1/u + 1/v</span></p>
            </div>
          </details>
        </div>

        <div class="card" data-topic="Modern Physics">
          <h3>Modern Physics <span class="pill">Photoelectric</span></h3>
          <div class="tiny">Photons, Bohr model, Compton.</div>
          <details><summary>Key formulas</summary>
            <div class="content">
              <p><span class="formula">E = hf = hc/Œª</span> ‚Ä¢ <span class="formula">K<sub>max</sub> = hf - Œ¶</span></p>
            </div>
          </details>
        </div>
      </div>
    </section>

    <!-- RIGHT: AI Tutor -->
    <aside class="panel">
      <h2>Physics Tutor (GPT-4)</h2>
      <div class="sub">Choose a mode, then ask. Answers adapt to the topic you select.</div>

      <div class="modes">
        <div class="tag active" data-mode="Socratic">üí° Explain</div>
        <div class="tag" data-mode="Steps">ü™ú Step-by-Step</div>
        <div class="tag" data-mode="Practice">üß™ Quiz Me</div>
        <div class="tag" data-mode="Check">‚úÖ Check My Work</div>
      </div>

      <div class="chat" id="chat"></div>

      <div class="controls">
        <textarea id="ask" rows="2" placeholder="Ask a physics question‚Ä¶"></textarea>
        <button id="send" class="btn">Ask Tutor ‚Üí</button>
      </div>
      <div class="status" id="aiStatus"></div>
    </aside>
  </main>

  <script>
    // -------- Feature constants --------
    const FEATURE = 'learn_physics'; // backend key
    const OVERLAY = document.getElementById('goldenOverlay');
    const UI_BAL = document.getElementById('uiBalance');
    const USER_BAL = document.getElementById('userBalance');
    const STATUS = document.getElementById('statusMessage');
    const UNLOCK_BTN = document.getElementById('unlockBtn');
    const PAGE = document.getElementById('pageContent');

    // -------- Helper: toast --------
    function toast(msg){
      const el = document.createElement('div');
      el.textContent = msg;
      Object.assign(el.style,{
        position:'fixed',bottom:'18px',left:'50%',transform:'translateX(-50%)',
        padding:'8px 12px',border:'1px solid var(--border)',background:'#0d1420',
        color:'var(--gold)',borderRadius:'999px',boxShadow:'var(--shadow)',zIndex:9999
      });
      document.body.appendChild(el); setTimeout(()=>el.remove(),1400);
    }

    // -------- Auth + gating --------
    async function loadMe(){
      const me = await fetch('/api/me',{credentials:'include'}).then(r=>r.json()).catch(()=>({loggedIn:false}));
      if(!me.loggedIn){ window.location.href='/login-signup.html'; return null; }
      UI_BAL.textContent = me.balance ?? 0;
      USER_BAL.textContent = me.balance ?? 0;
      return me;
    }

    async function checkAccess(){
      try{
        const r = await fetch(`/api/feature-status?feature=${FEATURE}`,{credentials:'include'});
        if(!r.ok){ throw new Error('Feature status fetch failed'); }
        const data = await r.json();
        if(data.unlocked){
          OVERLAY.hidden = true;
          PAGE.style.visibility = 'visible';
        }else{
          OVERLAY.hidden = false;
          PAGE.style.visibility = 'hidden';
        }
      }catch(e){
        console.error(e);
        OVERLAY.hidden = false;
        STATUS.textContent = 'Network error. Please retry.'; STATUS.style.color = 'var(--err)';
      }
    }

    UNLOCK_BTN?.addEventListener('click', async ()=>{
      UNLOCK_BTN.disabled = true; UNLOCK_BTN.textContent = 'Processing‚Ä¶';
      STATUS.textContent = '';
      try{
        const res = await fetch('/api/unlock-feature',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body:JSON.stringify({ feature: FEATURE, cost: 4 })
        });
        const data = await res.json();
        if(data.success){
          STATUS.textContent = '‚úÖ Unlocked! Loading‚Ä¶'; STATUS.style.color = 'var(--ok)';
          const bal = Number(USER_BAL.textContent||0) - 4; USER_BAL.textContent = Math.max(0,bal);
          setTimeout(()=>{ OVERLAY.hidden = true; PAGE.style.visibility='visible'; }, 700);
        }else{
          STATUS.textContent = '‚ùå ' + (data.error || 'Could not unlock'); STATUS.style.color = 'var(--err)';
          UNLOCK_BTN.disabled = false; UNLOCK_BTN.textContent = 'UNLOCK FOR 4G';
        }
      }catch(e){
        STATUS.textContent = '‚ùå Network error'; STATUS.style.color = 'var(--err)';
        UNLOCK_BTN.disabled = false; UNLOCK_BTN.textContent = 'UNLOCK FOR 4G';
      }
    });

    // -------- Topics selection (sets CURRENT_TOPIC) --------
    let CURRENT_TOPIC = 'Mechanics';
    document.querySelectorAll('#topics .card[data-topic]').forEach(card=>{
      card.addEventListener('click', ()=>{
        CURRENT_TOPIC = card.getAttribute('data-topic');
        toast(`Topic set: ${CURRENT_TOPIC}`);
      });
    });

    // -------- Modes selection --------
    let MODE = 'Socratic';
    const modeTags = Array.from(document.querySelectorAll('.tag'));
    modeTags.forEach(t=>{
      t.addEventListener('click', ()=>{
        modeTags.forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        MODE = t.dataset.mode || 'Socratic';
        toast(`Mode: ${MODE}`);
      });
    });

    // -------- Tutor Chat --------
    const chat = document.getElementById('chat');
    const ask  = document.getElementById('ask');
    const send = document.getElementById('send');
    const aiStatus = document.getElementById('aiStatus');

    function bubble(role, html){
      const b = document.createElement('div');
      b.className = `bubble ${role==='user'?'me':'assistant'}`;
      b.innerHTML = html;
      chat.appendChild(b);
      chat.scrollTop = chat.scrollHeight;
      return b;
    }

    async function sendTutor(){
      const text = (ask.value||'').trim();
      if(!text) return;
      bubble('user', text.replace(/\n/g,'<br>'));
      ask.value = '';

      const thinking = bubble('assistant','<span class="tiny">Thinking‚Ä¶</span>');
      aiStatus.textContent = 'Contacting tutor‚Ä¶';

      try{
        const res = await fetch('/api/physics-tutor',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ question: text, topic: CURRENT_TOPIC, mode: MODE })
        });
        const data = await res.json();
        if(res.ok && data.reply){
          thinking.innerHTML = data.reply.replace(/\n/g,'<br>');
          aiStatus.textContent = '';
        }else{
          thinking.innerHTML = `<span style="color:var(--err)">No reply.</span>`;
          aiStatus.textContent = 'Tutor returned no content.';
        }
      }catch(e){
        thinking.innerHTML = `<span style="color:var(--err)">Error connecting to AI.</span>`;
        aiStatus.textContent = 'Network error.';
      }
    }

    send.addEventListener('click', sendTutor);
    ask.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendTutor(); }
    });

    // -------- Boot --------
    (async ()=>{
      const me = await loadMe(); if(!me) return;
      await checkAccess();
    })();
  </script>
</body>
</html>
