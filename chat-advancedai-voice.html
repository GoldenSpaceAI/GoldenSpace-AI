<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GoldenSpaceAI Â· Live Voice + Camera</title>
  <style>
    :root{
      --bg:#0e2a47;            /* deep blue */
      --bg2:#134a8e;           /* lighter blue */
      --grid:#ffffff22;        /* grid lines */
      --panel:#0b1730;         /* chat bubbles */
      --text:#eaf2ff;
      --muted:#b9c7e6;
      --gold:#ffd33d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font:15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        linear-gradient(180deg, #10355f88, #0e2a47 60%),
        radial-gradient(1200px 800px at 30% -10%, #2b6cb088, transparent 60%),
        var(--bg);
      overflow:hidden;
    }
    /* grid overlay */
    .grid{
      position:fixed; inset:0; pointer-events:none; z-index:-1;
      background:
        linear-gradient(var(--grid) 1px, transparent 1px) 0 0/ 28px 28px,
        linear-gradient(90deg, var(--grid) 1px, transparent 1px) 0 0/ 28px 28px;
    }

    .wrap{display:grid; grid-template-columns:minmax(280px,520px) 1fr; gap:16px; height:100%; padding:16px}
    @media(max-width:960px){ .wrap{grid-template-columns:1fr; } }

    /* Left column: live tile */
    .tile{
      background:linear-gradient(180deg,#11355f,#0d2746);
      border:1px solid #2a4773; border-radius:16px; padding:12px; box-shadow:0 12px 44px #0006;
      display:flex; flex-direction:column; min-height:280px
    }
    .tile h2{margin:0 0 8px; font-size:16px; color:#cfe2ff}
    .videoWrap{position:relative; background:#061224; border:1px solid #1b345b; border-radius:12px; overflow:hidden;
               display:grid; place-items:center; aspect-ratio: 4/3; }
    video{width:100%; height:100%; object-fit:cover; display:block}
    .controls{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .btn{cursor:pointer; border:none; border-radius:12px; padding:10px 12px; font-weight:700; background:#153960; color:#eaf2ff}
    .btn:hover{filter:brightness(1.1)}
    .btn.gold{background:linear-gradient(180deg,#ffd33d,#e2b400); color:#1c1400}
    .btn.ghost{background:transparent; border:1px solid #2a4773}

    /* Right column: chat */
    .chatWrap{background:linear-gradient(180deg,#0d1a34,#0a152a); border:1px solid #253a63; border-radius:16px; box-shadow:0 10px 40px #0006;
              display:grid; grid-template-rows:auto 1fr auto; min-height:0}
    header{display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid #243a62}
    header .dot{width:10px;height:10px;border-radius:50%; background:radial-gradient(circle at 30% 30%, #ffe58f, #ffd33d 60%, #e2b400 100%);
                box-shadow:0 0 14px #ffd33d88}
    header h1{margin:0; font-size:16px}
    #chat{overflow:auto; padding:14px; min-height:0}
    .msg{max-width:min(780px, 92%); padding:12px 14px; border-radius:14px; margin:8px 0; background:#101e3c; border:1px solid #203a6a}
    .msg.user{margin-left:auto; background:#142a55}
    .msg small{display:block; opacity:.7; font-size:.75rem; margin-bottom:4px; color:#c7d8ff}
    .spinner{width:18px;height:18px;border-radius:50%;border:2px solid #ffffff33;border-top-color:#ffd33d; animation:spin 1s linear infinite; display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}

    .composer{display:flex; align-items:center; gap:8px; padding:10px; border-top:1px solid #243a62}
    .fileChip{font-size:.8rem; padding:6px 8px; border:1px solid #2a4773; background:#13264a; border-radius:999px; margin-left:8px}
    textarea{flex:1; min-height:46px; max-height:120px; resize:vertical; border-radius:10px; border:1px solid #2a4773; background:#0d1f3e;
             color:#eaf2ff; padding:10px; outline:none}
    .muted{color:var(--muted); font-size:.8rem}
  </style>
</head>
<body>
  <div class="grid"></div>

  <div class="wrap">
    <!-- LEFT: Live video + mic always together -->
    <section class="tile" aria-label="Live camera and microphone">
      <h2>ðŸŽ¥ Live Camera + ðŸŽ¤ Mic</h2>
      <div class="videoWrap">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="frame" width="640" height="480" class="visually-hidden" style="display:none"></canvas>
      </div>
      <div class="controls">
        <button id="toggleLive" class="btn gold">Enable Camera & Mic</button>
        <button id="flip" class="btn ghost">Flip</button>
        <span id="liveStatus" class="muted">Off</span>
      </div>
      <div class="muted" style="margin-top:6px">
        Tip: When camera is ON, we also listen. When you finish speaking, weâ€™ll snapshot a frame and send it with your words.
      </div>
    </section>

    <!-- RIGHT: Chat -->
    <section class="chatWrap">
      <header>
        <div class="dot"></div>
        <h1>GoldenSpaceAI Â· Live Assistant (gpt-4o-mini)</h1>
        <div style="flex:1"></div>
      </header>

      <main id="chat" aria-live="polite">
        <div class="msg">
          <small>GoldenSpaceAI</small>
          Welcome! Turn on your camera to start voice chat. You can also type a message or attach a file below.
        </div>
      </main>

      <footer class="composer">
        <button id="pickFile" class="btn">ï¼‹ File</button>
        <input id="fileInput" type="file" style="display:none"/>
        <span id="fileBadge" class="fileChip" style="display:none"></span>
        <textarea id="prompt" placeholder="Type a messageâ€¦ (Enter to send)"></textarea>
        <button id="send" class="btn gold">Send</button>
      </footer>
    </section>
  </div>

  <script>
    // ===================== CONFIG =====================
    // We send to your existing chat route; it returns { reply: string }
    const CHAT_URL = "/api/chat";   // server must be logged-in session aware

    // ===================== DOM =====================
    const video = document.getElementById("video");
    const canvas = document.getElementById("frame");
    const ctx = canvas.getContext("2d");
    const toggleLiveBtn = document.getElementById("toggleLive");
    const flipBtn = document.getElementById("flip");
    const liveStatus = document.getElementById("liveStatus");
    const chat = document.getElementById("chat");
    const pickFileBtn = document.getElementById("pickFile");
    const fileInput = document.getElementById("fileInput");
    const fileBadge = document.getElementById("fileBadge");
    const promptEl = document.getElementById("prompt");
    const sendBtn = document.getElementById("send");

    // ===================== STATE =====================
    let stream = null;
    let facingMode = "user";   // or "environment"
    let listening = false;
    let recognizer = null;
    let attachedFile = null;
    let ttsEnabled = true;     // speak AI replies

    // ===================== CHAT HELPERS =====================
    function el(tag, attrs={}, ...children){
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==="class") n.className=v;
        else if(k==="html") n.innerHTML=v;
        else n.setAttribute(k,v);
      });
      children.forEach(c=> n.append(c instanceof Node? c : document.createTextNode(c)));
      return n;
    }
    function addMsg(role, text){
      const bubble = el("div",{class:"msg"+(role==="user"?" user":"")});
      bubble.append(el("small",{}, role==="user"?"You":"GoldenSpaceAI"));
      bubble.append(el("div",{html:(text||"").toString().replace(/\n/g,"<br>")}));
      chat.append(bubble);
      chat.scrollTop = chat.scrollHeight;
      return bubble;
    }
    function addSpinner(){
      const row = el("div",{class:"msg"});
      row.append(el("small",{},"GoldenSpaceAI"));
      row.append(el("span",{class:"spinner"}));
      chat.append(row);
      chat.scrollTop = chat.scrollHeight;
      return row;
    }

    async function speak(text){
      if(!ttsEnabled || !window.speechSynthesis) return;
      try{
        const utt = new SpeechSynthesisUtterance(text);
        utt.rate = 1.0; utt.pitch = 1.0; utt.lang = "en-US";
        speechSynthesis.cancel(); // stop anything pending
        speechSynthesis.speak(utt);
      }catch(e){ /* ignore */ }
    }

    async function sendToBackend(message, withFrameBlob){
      const spinner = addSpinner();
      try{
        const fd = new FormData();
        fd.append("message", message || "");
        if(attachedFile) fd.append("files", attachedFile, attachedFile.name);
        if(withFrameBlob) fd.append("files", withFrameBlob, "live-frame.jpg"); // safe: server just ignores if unused

        const res = await fetch(CHAT_URL, { method:"POST", body: fd, credentials:"include" });
        const data = await res.json();
        chat.removeChild(spinner);
        const ai = data.reply || data.answer || "[No reply]";
        addMsg("ai", ai);
        speak(ai);
      }catch(err){
        chat.removeChild(spinner);
        addMsg("ai", "âš ï¸ " + (err?.message || "Network error"));
      }
    }

    // ===================== FILE UPLOAD =====================
    pickFileBtn.addEventListener("click", ()=> fileInput.click());
    fileInput.addEventListener("change", ()=>{
      attachedFile = fileInput.files?.[0] || null;
      if(attachedFile){
        fileBadge.style.display="inline-block";
        fileBadge.textContent = attachedFile.name;
      }else{
        fileBadge.style.display="none";
      }
    });

    // ===================== TYPED SEND =====================
    async function sendTyped(){
      const text = (promptEl.value||"").trim();
      if(!text && !attachedFile) return;
      addMsg("user", text || "(file only)");
      promptEl.value = "";
      await sendToBackend(text, null);
    }
    sendBtn.addEventListener("click", sendTyped);
    promptEl.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendTyped(); }
    });

    // ===================== CAMERA + MIC =====================
    async function startLive(){
      // Stop any existing
      await stopLive();

      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode },
          audio: true
        });
        video.srcObject = stream;
        liveStatus.textContent = "Camera + Mic: ON";
        toggleLiveBtn.textContent = "Disable Camera & Mic";
        startListening(); // start speech recognition
      }catch(err){
        addMsg("ai","âš ï¸ Allow camera & mic to use live chat.");
        console.error(err);
        liveStatus.textContent = "Permission denied";
      }
    }

    async function stopLive(){
      if(stream){
        stream.getTracks().forEach(t=> t.stop());
        stream = null;
      }
      stopListening();
      video.srcObject = null;
      liveStatus.textContent = "Off";
      toggleLiveBtn.textContent = "Enable Camera & Mic";
    }

    toggleLiveBtn.addEventListener("click", ()=>{
      if(stream) stopLive(); else startLive();
    });

    flipBtn.addEventListener("click", async ()=>{
      facingMode = (facingMode === "user") ? "environment" : "user";
      if(stream) await startLive(); // re-start with new camera
    });

    // Take a snapshot (Blob) of current frame to JPG
    function grabFrameBlob(){
      if(!video.videoWidth || !video.videoHeight) return null;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      return new Promise(resolve => canvas.toBlob(b=> resolve(b), "image/jpeg", 0.85));
    }

    // ===================== SPEECH RECOGNITION =====================
    function initRecognizer(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return null;
      const r = new SR();
      r.lang = "en-US";         // change if you want
      r.interimResults = false; // we only care about final transcriptions
      r.continuous = true;      // keep listening while live
      r.maxAlternatives = 1;
      return r;
    }

    function startListening(){
      if(listening) return;
      recognizer = recognizer || initRecognizer();
      if(!recognizer){
        addMsg("ai","âš ï¸ This browser doesnâ€™t support speech recognition. You can still type.");
        return;
      }
      recognizer.onstart = ()=>{ listening = true; liveStatus.textContent = "Listeningâ€¦ (camera + mic ON)"; };
      recognizer.onend   = ()=>{ listening = false; if(stream){ /* auto-restart */ recognizer.start(); } };
      recognizer.onerror = (e)=>{ addMsg("ai","âš ï¸ Mic error: "+(e.error||"unknown")); };
      recognizer.onresult = async (ev)=>{
        const transcript = (ev.results?.[ev.results.length-1]?.[0]?.transcript || "").trim();
        if(!transcript) return;
        addMsg("user", transcript);

        // Grab one frame at the moment you stopped speaking
        const blob = await grabFrameBlob();
        await sendToBackend(transcript, blob);
      };
      try { recognizer.start(); } catch(e) { /* ignore start race */ }
    }

    function stopListening(){
      if(recognizer){
        try{ recognizer.onend = null; recognizer.stop(); }catch(e){}
      }
      listening = false;
    }

    // =============== INIT ===============
    // (No auto-start; user must click Enable due to browser permissions)
  </script>
</body>
</html>
