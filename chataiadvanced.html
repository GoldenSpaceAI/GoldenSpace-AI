<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unlimited AI Assistant</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-color: #252526;
            --chat-bg: #1e1e1e;
            --msg-user: #007acc;
            --msg-ai: #333333;
            --text-color: #ffffff;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; background-color: var(--bg-color); color: var(--text-color); }
        
        /* Sidebar */
        #sidebar { width: 260px; background-color: var(--sidebar-color); display: flex; flex-direction: column; border-right: 1px solid #3e3e42; }
        .sidebar-header { padding: 20px; font-weight: bold; font-size: 1.2rem; border-bottom: 1px solid #3e3e42; }
        #chat-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .chat-item { padding: 10px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .chat-item:hover { background-color: #37373d; }
        .delete-btn { background: none; border: none; color: #ff4d4d; cursor: pointer; font-size: 12px; }
        #new-chat-btn { margin: 10px; padding: 10px; background-color: #0e639c; color: white; border: none; cursor: pointer; border-radius: 4px; }

        /* Main Chat Area */
        #main { flex: 1; display: flex; flex-direction: column; }
        #chat-history { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Messages */
        .message { max-width: 70%; padding: 10px 15px; border-radius: 8px; line-height: 1.5; }
        .user-msg { align-self: flex-end; background-color: var(--msg-user); }
        .ai-msg { align-self: flex-start; background-color: var(--msg-ai); border: 1px solid #444; }
        .msg-img { max-width: 100%; border-radius: 5px; margin-top: 5px; display: block; }

        /* Input Area */
        #input-area { padding: 20px; background-color: var(--sidebar-color); display: flex; gap: 10px; align-items: center; border-top: 1px solid #3e3e42; }
        #message-input { flex: 1; padding: 12px; border-radius: 5px; border: 1px solid #3e3e42; background-color: #3c3c3c; color: white; }
        #file-input { display: none; }
        .icon-btn { cursor: pointer; padding: 10px; background: #333; color: white; border: none; border-radius: 5px; }
        .icon-btn:hover { background: #444; }
        
        /* Image Preview Badge */
        #img-preview-badge { display: none; background: #2d2d2d; padding: 5px 10px; border-radius: 15px; font-size: 12px; color: #00ff88; margin-right: 10px;}
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">AI Assistant</div>
        <button id="new-chat-btn" onclick="createNewChat()">+ New Chat</button>
        <ul id="chat-list">
            </ul>
    </div>

    <div id="main">
        <div id="chat-history">
            <div class="message ai-msg">Hello! I am your AI Assistant. Upload an image or ask me anything.</div>
        </div>

        <div id="input-area">
            <span id="img-preview-badge">Image Attached</span>
            
            <input type="file" id="file-input" accept="image/*" onchange="handleImageSelect()">
            
            <button class="icon-btn" onclick="document.getElementById('file-input').click()">ðŸ“·</button>
            
            <input type="text" id="message-input" placeholder="Type a message..." onkeypress="if(event.key === 'Enter') sendMessage()">
            <button class="icon-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let currentChatId = Date.now().toString();
        let chats = JSON.parse(localStorage.getItem('my_ai_chats')) || {};
        let currentImageBase64 = null;

        // Initialize
        loadChatList();
        if(Object.keys(chats).length === 0) createNewChat();
        else loadChat(Object.keys(chats)[0]); // Load first chat

        // --- CORE FUNCTIONS ---

        function createNewChat() {
            currentChatId = Date.now().toString();
            chats[currentChatId] = { title: "New Chat " + new Date().toLocaleTimeString(), messages: [] };
            saveToLocal();
            loadChatList();
            renderMessages();
        }

        function deleteChat(e, id) {
            e.stopPropagation(); // Stop click from opening the chat
            delete chats[id];
            saveToLocal();
            loadChatList();
            if(id === currentChatId) document.getElementById('chat-history').innerHTML = '';
        }

        function loadChatList() {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            Object.keys(chats).reverse().forEach(id => {
                const li = document.createElement('li');
                li.className = 'chat-item';
                li.innerHTML = `<span>${chats[id].title}</span> <button class="delete-btn" onclick="deleteChat(event, '${id}')">âœ•</button>`;
                li.onclick = () => loadChat(id);
                list.appendChild(li);
            });
        }

        function loadChat(id) {
            currentChatId = id;
            renderMessages();
        }

        function renderMessages() {
            const historyDiv = document.getElementById('chat-history');
            historyDiv.innerHTML = '';
            const messages = chats[currentChatId].messages || [];
            
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message ${msg.role === 'user' ? 'user-msg' : 'ai-msg'}`;
                
                let content = msg.text;
                if(msg.image) {
                    content += `<br><img src="${msg.image}" class="msg-img">`;
                }
                div.innerHTML = content;
                historyDiv.appendChild(div);
            });
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }

        function handleImageSelect() {
            const file = document.getElementById('file-input').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = function() {
                    currentImageBase64 = reader.result;
                    document.getElementById('img-preview-badge').style.display = 'inline-block';
                }
                reader.readAsDataURL(file);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();

            if (!text && !currentImageBase64) return;

            // 1. Add User Message to UI
            addMessageToState('user', text, currentImageBase64);
            
            const payload = {
                message: text,
                image: currentImageBase64 // Send base64 image to backend
            };

            // Clear input
            input.value = '';
            currentImageBase64 = null;
            document.getElementById('file-input').value = '';
            document.getElementById('img-preview-badge').style.display = 'none';

            // 2. Send to Backend
            try {
                // Show loading state
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message ai-msg';
                loadingDiv.innerText = 'Analyzing...';
                loadingDiv.id = 'loading-msg';
                document.getElementById('chat-history').appendChild(loadingDiv);

                const response = await fetch('/api/unlimited-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                // Remove loading and add real response
                document.getElementById('loading-msg').remove();
                addMessageToState('assistant', data.reply);

            } catch (err) {
                console.error(err);
                addMessageToState('assistant', "Error connecting to AI.");
            }
        }

        function addMessageToState(role, text, image = null) {
            if(!chats[currentChatId]) createNewChat();
            
            chats[currentChatId].messages.push({ role, text, image });
            
            // Update Title if it's the first message
            if(chats[currentChatId].messages.length === 1) {
                chats[currentChatId].title = text.substring(0, 20) || "Image Chat";
            }
            
            saveToLocal();
            loadChatList();
            renderMessages();
        }

        function saveToLocal() {
            localStorage.setItem('my_ai_chats', JSON.stringify(chats));
        }
    </script>
</body>
</html>
