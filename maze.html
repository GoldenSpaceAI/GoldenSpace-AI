<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Colorful Maze Escape - Pro Edition</title>
    <style>
        :root {
            --gold: #FFD700;
            --bg: #0f0d05;
            --panel: rgba(15, 12, 0, 0.95);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg); 
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            /* Prevent accidental refreshing/scrolling on touch */
            touch-action: none;
        }

        /* Menu Overlays */
        .menu-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--panel);
            padding: 30px;
            border: 2px solid var(--gold);
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
            z-index: 30;
            width: 85%;
            max-width: 400px;
            backdrop-filter: blur(5px);
        }

        .menu-screen h1, .menu-screen h2 {
            color: var(--gold);
            margin-top: 0;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            font-size: 2.2rem;
            letter-spacing: -1px;
        }

        .menu-screen p {
            color: #ccc;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        /* In-Game UI Layer */
        #ui-layer {
            position: absolute;
            top: 10px;
            width: 95%;
            max-width: 800px;
            display: none; 
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        #ui-title {
            font-size: 1.2rem;
            margin: 0;
            color: var(--gold);
        }

        /* The Game Board */
        canvas {
            background-color: #1a1500;
            border: 3px solid #665500;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            display: none;
            max-width: 95vw;
            max-height: 70vh;
            touch-action: none;
        }

        /* Buttons */
        button {
            background: linear-gradient(180deg, rgba(255,215,0,0.1) 0%, rgba(255,215,0,0) 100%);
            color: var(--gold);
            border: 2px solid var(--gold);
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            margin: 5px;
            display: inline-block;
            font-weight: bold;
            text-transform: uppercase;
        }

        button:active {
            transform: scale(0.95);
            background: var(--gold);
            color: #000;
        }

        .level-btn {
            display: block;
            width: 90%;
            margin: 10px auto;
        }

        /* Virtual D-Pad for Mobile */
        #controls-wrapper {
            position: absolute;
            bottom: 20px;
            display: none;
            grid-template-areas: 
                ". up ."
                "left . right"
                ". down .";
            gap: 10px;
            z-index: 25;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 215, 0, 0.15);
            border: 2px solid var(--gold);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--gold);
            font-size: 1.5rem;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .control-btn:active {
            background: var(--gold);
            color: #000;
        }

        #up { grid-area: up; }
        #left { grid-area: left; }
        #right { grid-area: right; }
        #down { grid-area: down; }

        /* Currency Display */
        #currency-display {
            color: #FFD700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .coin-icon {
            width: 18px;
            height: 18px;
            background: var(--gold);
            border-radius: 50%;
            display: inline-block;
        }

        /* Custom Menu Styles */
        .custom-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
        }
        
        input[type="color"] {
            background: none;
            border: 1px solid var(--gold);
            height: 30px;
            width: 50px;
        }

        /* Death Wall Overlay */
        #death-wall {
            position: fixed;
            top: 0; left: 0; height: 100vh; width: 0;
            background: repeating-linear-gradient(-45deg, #cc0000, #cc0000 25px, #8a0000 25px, #8a0000 50px);
            border-right: 15px solid #ff3333;
            z-index: 20;
            display: none;
            pointer-events: none;
        }

        #timer-bar-container {
            position: fixed;
            bottom: 0; left: 0; width: 100%; height: 6px;
            background: rgba(255,255,255,0.1);
            display: none;
            z-index: 21;
        }

        #timer-bar { height: 100%; background: #ff3333; width: 0%; }
    </style>
</head>
<body>

    <!-- TOP HUD -->
    <div id="ui-layer">
        <div>
            <h1 id="ui-title">MAZE</h1>
            <span id="level-display" style="font-size: 0.8rem; color: #aaa;"></span>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <div id="currency-display"><span class="coin-icon"></span> <span id="coin-count">0</span></div>
            <button class="small-btn" style="margin:0; padding: 4px 10px; font-size: 0.7rem;" onclick="showMainMenu()">Exit</button>
        </div>
    </div>

    <!-- MAIN MENU -->
    <div id="main-menu" class="menu-screen">
        <h1>MAZE TYCOON</h1>
        <p>Master the colorful mazes and earn coins.</p>
        <button onclick="startRandom()" class="level-btn">Survival Mode (60s)</button>
        <button onclick="showLevels()" class="level-btn">Levels</button>
        <button onclick="showCustomMenu()" class="level-btn">Creator Studio</button>
        <div style="margin-top: 15px; font-size: 0.8rem; color: #777;">
            Personal Best: <span id="best-time">--</span>s
        </div>
    </div>

    <!-- LEVELS MENU -->
    <div id="levels-menu" class="menu-screen" style="display:none;">
        <h2>Select Difficulty</h2>
        <button class="level-btn" onclick="startLevel(1)">1 - Rookie (5¢)</button>
        <button class="level-btn" onclick="startLevel(2)">2 - Skilled (15¢)</button>
        <button class="level-btn" onclick="startLevel(3)">3 - Pro (30¢)</button>
        <button class="level-btn" onclick="startLevel(4)">4 - Master (60¢)</button>
        <button class="level-btn" onclick="startLevel(5)">5 - Legend (150¢)</button>
        <button class="level-btn" style="border-color: #888; color: #888;" onclick="showMainMenu()">Back</button>
    </div>

    <!-- CUSTOM MAZE MENU -->
    <div id="custom-menu" class="menu-screen" style="display:none;">
        <h2>Creator Studio</h2>
        <div class="custom-row">
            <label>Size: <span id="size-val">15</span></label>
            <input type="range" id="custom-size" min="5" max="40" value="15" oninput="updateCustomSize(this.value)">
        </div>
        <div class="custom-row"><label>Wall:</label> <input type="color" id="c-wall" value="#FFD700"></div>
        <div class="custom-row"><label>Path:</label> <input type="color" id="c-path" value="#1a1500"></div>
        <div class="custom-row"><label>Hero:</label> <input type="color" id="c-player" value="#FFFFFF"></div>
        <div class="custom-row"><label>Exit:</label> <input type="color" id="c-goal" value="#FFA500"></div>
        <button class="level-btn" onclick="startCustom()">Test Creation</button>
        <button class="level-btn" style="border-color: #888; color: #888;" onclick="showMainMenu()">Back</button>
    </div>

    <!-- GAME CANVAS -->
    <canvas id="mazeCanvas" width="600" height="600"></canvas>

    <!-- TOUCH CONTROLS -->
    <div id="controls-wrapper">
        <div id="up" class="control-btn" onmousedown="handleTouchMove('up')" ontouchstart="handleTouchMove('up')">▲</div>
        <div id="left" class="control-btn" onmousedown="handleTouchMove('left')" ontouchstart="handleTouchMove('left')">◀</div>
        <div id="right" class="control-btn" onmousedown="handleTouchMove('right')" ontouchstart="handleTouchMove('right')">▶</div>
        <div id="down" class="control-btn" onmousedown="handleTouchMove('down')" ontouchstart="handleTouchMove('down')">▼</div>
    </div>

    <!-- OVERLAYS -->
    <div id="death-wall"></div>
    <div id="timer-bar-container"><div id="timer-bar"></div></div>

    <div id="win-screen" class="menu-screen" style="display:none;">
        <h2 id="win-header">ESCAPED!</h2>
        <p id="win-text">You found the exit.</p>
        <div id="reward-box" style="margin-bottom: 20px; font-size: 1.5rem; color: var(--gold); font-weight: bold;">
            +<span id="reward-amt">0</span> Coins
        </div>
        <div id="win-buttons"></div>
    </div>

    <div id="lose-screen" class="menu-screen" style="display:none; border-color: #ff0000;">
        <h2 style="color: #ff0000;">TIME'S UP</h2>
        <p>The crushing wall caught you.</p>
        <button onclick="startRandom()" style="border-color: #ff0000; color: #ff0000;">Try Again</button>
        <button style="border-color: #888; color: #888;" onclick="showMainMenu()">Main Menu</button>
    </div>

    <script>
        const canvas = document.getElementById('mazeCanvas');
        const ctx = canvas.getContext('2d');
        const winScreen = document.getElementById('win-screen');
        const loseScreen = document.getElementById('lose-screen');
        const levelDisplay = document.getElementById('level-display');
        const mainMenu = document.getElementById('main-menu');
        const levelsMenu = document.getElementById('levels-menu');
        const customMenu = document.getElementById('custom-menu');
        const uiLayer = document.getElementById('ui-layer');
        const uiTitle = document.getElementById('ui-title');
        const deathWallOverlay = document.getElementById('death-wall');
        const timerBar = document.getElementById('timer-bar');
        const timerContainer = document.getElementById('timer-bar-container');
        const coinDisplay = document.getElementById('coin-count');
        const bestTimeDisplay = document.getElementById('best-time');
        const controlsWrapper = document.getElementById('controls-wrapper');

        // Logic State
        let coins = 0;
        let bestSurvivalTime = 0;
        let cols, rows, w; 
        let grid = [];
        let player, goal;
        let gameMode = 'MENU'; 
        let currentLevel = 1;
        let startTime = 0;
        let deathWallScreenX = 0;
        const SURVIVAL_TIME = 60000; 
        let themeWall, themePlayer, themeGoal, themePath;

        const THEMES = [
            { wall: '#FFD700', player: '#FFFFFF', goal: '#FFA500', path: '#1a1500', name: "GOLDEN" },
            { wall: '#00FFFF', player: '#FF00FF', goal: '#00FF00', path: '#001a1a', name: "CYBER" },
            { wall: '#FF00FF', player: '#00FFFF', goal: '#FFFF00', path: '#1a001a', name: "NEON" },
            { wall: '#00FF00', player: '#FFFFFF', goal: '#FF0000', path: '#001a00', name: "TOXIC" },
            { wall: '#FF4500', player: '#00FFCC', goal: '#FFD700', path: '#1a0500', name: "LAVA" },
            { wall: '#8A2BE2', player: '#00FF00', goal: '#FF1493', path: '#0d001a', name: "MAGIC" }
        ];

        // --- NAVIGATION ---
        function hideAllScreens() {
            [mainMenu, levelsMenu, customMenu, winScreen, loseScreen, canvas, uiLayer, deathWallOverlay, timerContainer, controlsWrapper].forEach(el => el.style.display = 'none');
        }

        function showMainMenu() {
            gameMode = 'MENU';
            hideAllScreens();
            mainMenu.style.display = 'block';
            coinDisplay.innerText = coins;
        }

        function showLevels() { hideAllScreens(); levelsMenu.style.display = 'block'; }
        function showCustomMenu() { hideAllScreens(); customMenu.style.display = 'block'; }
        function updateCustomSize(val) { document.getElementById('size-val').innerText = val; }

        // --- THEMES ---
        function applyDefaultTheme() {
            let t = THEMES[Math.floor(Math.random() * THEMES.length)];
            themeWall = t.wall; themePlayer = t.player; themeGoal = t.goal; themePath = t.path;
            uiTitle.innerText = t.name + " MAZE"; uiTitle.style.color = themeWall;
            canvas.style.borderColor = themeWall;
        }

        function applyCustomTheme() {
            themeWall = document.getElementById('c-wall').value; themePath = document.getElementById('c-path').value;
            themePlayer = document.getElementById('c-player').value; themeGoal = document.getElementById('c-goal').value;
            uiTitle.innerText = "CUSTOM MAZE"; uiTitle.style.color = themeWall;
            canvas.style.borderColor = themeWall;
        }

        // --- GAME START ---
        function startRandom() {
            gameMode = 'RANDOM'; applyDefaultTheme();
            startTime = Date.now(); deathWallScreenX = 0;
            setupGame(Math.floor(Math.random() * 5) + 12, 12, "Survival");
            deathWallOverlay.style.display = 'block'; timerContainer.style.display = 'block';
        }

        function startLevel(lvl) {
            gameMode = 'CAMPAIGN'; applyDefaultTheme(); currentLevel = lvl;
            let size = [0, 10, 15, 22, 32, 45][lvl];
            setupGame(size, size, `Level ${lvl}`);
        }

        function startCustom() {
            gameMode = 'CUSTOM'; applyCustomTheme();
            let size = parseInt(document.getElementById('custom-size').value);
            setupGame(size, size, "Custom");
        }

        function setupGame(c, r, titleText) {
            hideAllScreens();
            canvas.style.display = 'block'; uiLayer.style.display = 'flex';
            controlsWrapper.style.display = 'grid'; // Show touch controls
            levelDisplay.innerText = titleText; coinDisplay.innerText = coins;
            cols = c; rows = r; w = canvas.width / cols;
            grid = [];
            for (let y = 0; y < rows; y++) for (let x = 0; x < cols; x++) grid.push(new Cell(x, y));
            generateMaze();
            player = { c: 0, r: 0 }; goal = { c: cols - 1, r: rows - 1 };
        }

        class Cell {
            constructor(c, r) { this.c = c; this.r = r; this.walls = [true, true, true, true]; this.visited = false; }
            checkNeighbors() {
                let neighbors = [];
                let t = grid[index(this.c, this.r-1)], r = grid[index(this.c+1, this.r)], b = grid[index(this.c, this.r+1)], l = grid[index(this.c-1, this.r)];
                if (t && !t.visited) neighbors.push(t); if (r && !r.visited) neighbors.push(r); if (b && !b.visited) neighbors.push(b); if (l && !l.visited) neighbors.push(l);
                return neighbors.length > 0 ? neighbors[Math.floor(Math.random() * neighbors.length)] : undefined;
            }
        }

        function index(c, r) { return (c < 0 || r < 0 || c >= cols || r >= rows) ? -1 : c + r * cols; }
        function removeWalls(a, b) {
            let x = a.c - b.c, y = a.r - b.r;
            if (x === 1) { a.walls[3] = false; b.walls[1] = false; } else if (x === -1) { a.walls[1] = false; b.walls[3] = false; }
            if (y === 1) { a.walls[0] = false; b.walls[2] = false; } else if (y === -1) { a.walls[2] = false; b.walls[0] = false; }
        }

        function generateMaze() {
            let stack = []; let current = grid[0]; current.visited = true;
            while(true) {
                let next = current.checkNeighbors();
                if (next) { next.visited = true; stack.push(current); removeWalls(current, next); current = next; }
                else if (stack.length > 0) { current = stack.pop(); } else break;
            }
        }

        // --- RENDER ---
        function gameLoop() {
            if (['RANDOM', 'CAMPAIGN', 'CUSTOM'].includes(gameMode)) {
                drawGame();
                if (gameMode === 'RANDOM') {
                    let elapsed = Date.now() - startTime;
                    let progress = Math.min(elapsed / SURVIVAL_TIME, 1);
                    deathWallScreenX = progress * window.innerWidth;
                    deathWallOverlay.style.width = deathWallScreenX + 'px';
                    timerBar.style.width = (progress * 100) + '%';
                    checkDeath();
                }
            }
            requestAnimationFrame(gameLoop);
        }

        function drawGame() {
            ctx.fillStyle = themePath; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = themeWall; ctx.lineWidth = cols < 20 ? 4 : 2; ctx.lineCap = 'round';
            ctx.beginPath();
            grid.forEach(cell => {
                let x = cell.c * w, y = cell.r * w;
                if (cell.walls[0]) { ctx.moveTo(x, y); ctx.lineTo(x + w, y); }
                if (cell.walls[1]) { ctx.moveTo(x + w, y); ctx.lineTo(x + w, y + w); }
                if (cell.walls[2]) { ctx.moveTo(x + w, y + w); ctx.lineTo(x, y + w); }
                if (cell.walls[3]) { ctx.moveTo(x, y + w); ctx.lineTo(x, y); }
            });
            ctx.stroke();
            let pad = w * 0.2;
            ctx.fillStyle = themeGoal; ctx.fillRect(goal.c * w + pad, goal.r * w + pad, w - pad * 2, w - pad * 2);
            ctx.fillStyle = themePlayer; ctx.fillRect(player.c * w + pad, player.r * w + pad, w - pad * 2, w - pad * 2);
        }

        // --- MOVE LOGIC ---
        function handleTouchMove(dir) {
            if (!['RANDOM', 'CAMPAIGN', 'CUSTOM'].includes(gameMode)) return;
            let currentCell = grid[index(player.c, player.r)];
            if (dir === 'up' && !currentCell.walls[0]) player.r--;
            if (dir === 'right' && !currentCell.walls[1]) player.c++;
            if (dir === 'down' && !currentCell.walls[2]) player.r++;
            if (dir === 'left' && !currentCell.walls[3]) player.c--;
            checkWin();
        }

        // SWIPE DETECTION
        let touchStartX = 0, touchStartY = 0;
        canvas.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; }, false);
        canvas.addEventListener('touchend', e => {
            let diffX = e.changedTouches[0].clientX - touchStartX;
            let diffY = e.changedTouches[0].clientY - touchStartY;
            if (Math.abs(diffX) > 20 || Math.abs(diffY) > 20) {
                if (Math.abs(diffX) > Math.abs(diffY)) handleTouchMove(diffX > 0 ? 'right' : 'left');
                else handleTouchMove(diffY > 0 ? 'down' : 'up');
            }
        }, false);

        window.addEventListener('keydown', e => {
            if (e.key === 'ArrowUp' || e.key === 'w') handleTouchMove('up');
            if (e.key === 'ArrowRight' || e.key === 'd') handleTouchMove('right');
            if (e.key === 'ArrowDown' || e.key === 's') handleTouchMove('down');
            if (e.key === 'ArrowLeft' || e.key === 'a') handleTouchMove('left');
            if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault();
        });

        // --- WIN/LOSE ---
        function checkWin() {
            if (player.c === goal.c && player.r === goal.r) {
                let reward = gameMode === 'RANDOM' ? 50 : (gameMode === 'CAMPAIGN' ? [0, 5, 15, 30, 60, 150][currentLevel] : 0);
                if (gameMode === 'RANDOM') {
                    let sec = Math.floor((Date.now() - startTime)/1000);
                    if (sec > bestSurvivalTime) bestSurvivalTime = sec;
                    bestTimeDisplay.innerText = bestSurvivalTime;
                }
                coins += reward; hideAllScreens();
                winScreen.style.display = 'block'; document.getElementById('reward-amt').innerText = reward;
                document.getElementById('win-buttons').innerHTML = (gameMode === 'CAMPAIGN' && currentLevel < 5) ? `<button onclick="startLevel(${currentLevel+1})">Next Level</button>` : `<button onclick="showMainMenu()">Menu</button>`;
                gameMode = 'WON';
            }
        }

        function checkDeath() {
            let rect = canvas.getBoundingClientRect();
            if (deathWallScreenX >= (rect.left + (player.c * w) + (w * 0.2))) {
                gameMode = 'LOST'; hideAllScreens(); loseScreen.style.display = 'block';
            }
        }

        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
