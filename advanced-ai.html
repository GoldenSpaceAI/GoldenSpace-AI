<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GoldenSpaceAI â€” Advanced AI</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0a07; --panel:#121109; --ink:#fff6d8;
      --gold:#ffd24f; --gold-2:#ffb703; --line:rgba(255,210,79,.22);
    }
    html,body{height:100%}
    body{
      background:
        radial-gradient(1100px 700px at 80% -10%, #38300f 0%, #19160a 55%, #0a0a07 100%),
        linear-gradient(160deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      color:var(--ink);
      font-family: ui-sans-serif, system-ui, Inter, "Segoe UI", Arial;
    }
    .wrap{max-width:960px;margin:0 auto;padding:24px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
    }
    .msg{max-width:80ch;white-space:pre-wrap}
    .msg.ai{background:rgba(255,210,79,.06);border:1px solid var(--line)}
    .msg.you{background:rgba(255,183,3,.08);border:1px solid rgba(255,183,3,.35)}
    .thinking{opacity:.85;font-style:italic}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px}
    input{
      background:transparent;border:1px solid var(--line);color:var(--ink);
      border-radius:12px;padding:12px 14px;outline:none;
    }
    input:focus{box-shadow:0 0 0 2px rgba(255,210,79,.25)}
    .btn{
      border:1px solid var(--line);background:rgba(255,210,79,.12);color:var(--ink);
      padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;
    }
    .btn:hover{transform:translateY(-1px)}
    /* small circular mic+cam toggle */
    .vc-toggle{
      position:fixed;right:18px;bottom:86px;
      width:54px;height:54px;border-radius:9999px;display:grid;place-items:center;
      background:linear-gradient(180deg, var(--gold), var(--gold-2));
      color:#1a1200;font-weight:900;border:1px solid rgba(0,0,0,.35);
      cursor:pointer;box-shadow:0 10px 28px rgba(0,0,0,.45);
      transition:transform .08s ease, box-shadow .25s ease, filter .2s ease;
    }
    .vc-toggle:hover{transform:translateY(-2px)}
    .vc-toggle.off{filter:grayscale(.65) brightness(.85);opacity:.9}
    .preview{
      position:fixed;right:18px;bottom:152px;
      width:160px;height:90px;border-radius:12px;overflow:hidden;
      border:1px solid var(--line);display:none;background:#000;
      box-shadow:0 12px 28px rgba(0,0,0,.45);
    }
    .bottom-note{
      margin:16px auto 18px;max-width:960px;
      border:1px dashed var(--line);border-radius:14px;
      background:rgba(255,210,79,.06);color:var(--ink);
      font-size:.9rem;padding:10px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="text-2xl font-bold mb-3" style="color:var(--gold)">Advanced AI</h1>

    <div id="chat" class="card">
      <div id="feed" class="space-y-3">
        <div class="msg ai rounded-xl p-3">
          <div class="text-xs opacity-80 mb-1">GoldenSpaceAI</div>
          <div>Welcome, Faris. Type your question below. Toggle the small gold circle to enable mic+camera and spoken replies.</div>
        </div>
      </div>

      <div class="mt-3 row">
        <input id="input" placeholder="Type your messageâ€¦"/>
        <button id="sendBtn" class="btn">Send</button>
      </div>
    </div>
  </div>

  <!-- tiny camera preview (only when toggle ON and camera allowed) -->
  <div class="preview" id="preview">
    <video id="cam" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover"></video>
  </div>

  <!-- mic+cam + voice replies toggle -->
  <button id="vcBtn" class="vc-toggle off" title="Toggle mic+camera & spoken replies">ðŸŽ¤</button>

  <!-- >>> TEXT MOVED TO THE BOTTOM <<< -->
  <div class="bottom-note">
    <div>Voice reply is <strong id="state">OFF</strong>. Turn the gold circle ON to let me speak and show a small camera preview.</div>
    <div id="usage" class="opacity-80 text-xs"></div>
  </div>

  <script>
    // Elements
    const $ = s => document.querySelector(s);
    const feed = $('#feed'), input = $('#input'), sendBtn = $('#sendBtn');
    const vcBtn = $('#vcBtn'), stateEl = $('#state');
    const preview = $('#preview'), camEl = $('#cam');
    const usage = $('#usage');

    // State
    let voiceMode = false;   // when true â†’ speak replies
    let micStream = null;
    let camStream = null;

    // Helpers
    const addMsg = (who, text, extra='')=>{
      const el = document.createElement('div');
      el.className = 'msg ' + (who==='you'?'you':'ai') + ' rounded-xl p-3 ' + extra;
      el.innerHTML = \`<div class="text-xs opacity-80 mb-1">\${who==='you'?'You':'GoldenSpaceAI'}</div>\` +
                     '<div>' + (text??'').toString().replace(/</g,'&lt;') + '</div>';
      feed.appendChild(el); el.scrollIntoView({behavior:'smooth',block:'end'});
      return el;
    };

    async function refreshUsage(){
      try{
        const r = await fetch('/api/me', {credentials:'include'});
        if (!r.ok) return;
        const ct = r.headers.get('content-type')||'';
        if (!ct.includes('application/json')) return;
        const j = await r.json();
        const ask = j?.remaining?.ask ?? 'âˆž', se = j?.remaining?.search ?? 'âˆž', ph = j?.remaining?.physics ?? 'âˆž';
        usage.textContent = \`Ask \${ask} â€¢ Search \${se} â€¢ Physics \${ph}\`;
      }catch(e){ /* ignore */ }
    }
    refreshUsage();

    // TTS (only if voiceMode)
    function speak(text){
      if(!voiceMode) return;
      try{
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(String(text||''));
        const v = speechSynthesis.getVoices().find(v=>/en/i.test(v.lang));
        if(v) u.voice = v;
        speechSynthesis.speak(u);
      }catch(e){ console.warn('TTS error', e); }
    }

    // Toggle mic+cam and voice replies
    vcBtn.onclick = async ()=>{
      if(!voiceMode){
        // turn ON
        try{ micStream = await navigator.mediaDevices.getUserMedia({audio:true}); }catch(e){ micStream=null; }
        try{
          camStream = await navigator.mediaDevices.getUserMedia({video:true});
          camEl.srcObject = camStream; preview.style.display = 'block';
        }catch(e){
          camStream=null; camEl.srcObject=null; preview.style.display='none';
        }
        voiceMode = true; vcBtn.classList.remove('off'); stateEl.textContent = 'ON';
      }else{
        // turn OFF
        if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
        if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
        camEl.srcObject = null; preview.style.display = 'none';
        voiceMode = false; vcBtn.classList.add('off'); stateEl.textContent = 'OFF';
      }
    };

    // Send to backend (/ask) â€” server uses GEMINI_API_KEY from .env
    async function ask(q){
      const me = addMsg('you', q);
      const thinking = addMsg('ai', 'Thinkingâ€¦', 'thinking');
      try{
        const res = await fetch('/ask', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ question: q })
        });

        // If auth middleware redirected us to login (HTML), catch it:
        const ct = res.headers.get('content-type') || '';
        if (!res.ok) {
          thinking.remove();
          addMsg('ai', 'Server error: ' + res.status + ' â€” check logs.');
          console.error('ASK non-OK', res.status);
          return;
        }
        if (!ct.includes('application/json')) {
          thinking.remove();
          addMsg('ai', 'Looks like you are not signed in. Redirecting to loginâ€¦');
          console.warn('ASK returned non-JSON, probably login page.');
          window.location.href = '/login.html';
          return;
        }

        const data = await res.json();
        const answer = data?.answer ?? 'No response.';
        thinking.remove();
        addMsg('ai', answer);
        speak(answer);
        refreshUsage();
      }catch(e){
        thinking.remove();
        addMsg('ai', 'Network error. Open the browser console for details.');
        console.error('ASK fetch error', e);
      }
    }

    // UI events
    sendBtn.onclick = ()=>{
      const q = input.value.trim(); if(!q) return;
      input.value=''; ask(q);
    };
    input.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        const q = input.value.trim(); if(!q) return;
        input.value=''; ask(q);
      }
    });
  </script>
</body>
</html>
