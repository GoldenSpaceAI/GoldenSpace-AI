<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoldenSpace AI - Advanced</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #6366f1; /* Indigo */
            --primary-hover: #4f46e5;
            --bg-color: #0f172a; /* Dark Blue/Slate */
            --chat-bg: #1e293b;
            --user-msg-bg: #6366f1;
            --ai-msg-bg: #334155;
            --text-color: #f8fafc;
            --text-muted: #94a3b8;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.15) 0px, transparent 50%);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Main Container --- */
        .chat-container {
            width: 100%;
            max-width: 900px;
            height: 95vh;
            margin-top: 2.5vh;
            display: flex;
            flex-direction: column;
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: var(--glass-border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        /* --- Header --- */
        .chat-header {
            padding: 20px 30px;
            border-bottom: var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(15, 23, 42, 0.6);
        }

        .chat-header h1 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header i { color: var(--primary-color); }
        
        .model-badge {
            font-size: 0.75rem;
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
            padding: 4px 10px;
            border-radius: 20px;
            margin-left: 10px;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: var(--glass-border);
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        /* --- Chat Area --- */
        #chat-box {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        /* Scrollbar Styling */
        #chat-box::-webkit-scrollbar { width: 6px; }
        #chat-box::-webkit-scrollbar-track { background: transparent; }
        #chat-box::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        /* --- Messages --- */
        .message {
            display: flex;
            gap: 15px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .message.user { align-self: flex-end; flex-direction: row-reverse; }
        .message.ai { align-self: flex-start; }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .user .avatar { background: var(--user-msg-bg); color: white; }
        .ai .avatar { background: var(--primary-color); color: white; box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }

        .msg-content {
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
        }

        .user .msg-content {
            background: var(--user-msg-bg);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai .msg-content {
            background: var(--ai-msg-bg);
            color: var(--text-color);
            border: var(--glass-border);
            border-bottom-left-radius: 4px;
        }

        /* --- Message Tools (Speak Button) --- */
        .msg-tools {
            margin-top: 8px;
            display: flex;
            gap: 10px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .message:hover .msg-tools { opacity: 1; }
        
        .tool-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 0;
        }
        .tool-btn:hover { color: var(--text-color); }

        /* --- Image in Chat --- */
        .chat-image {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 10px;
            border: var(--glass-border);
        }

        /* --- Input Area --- */
        .input-area {
            padding: 20px 30px;
            background: rgba(15, 23, 42, 0.8);
            border-top: var(--glass-border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: rgba(30, 41, 59, 0.5);
            border: var(--glass-border);
            padding: 10px 15px;
            border-radius: 16px;
            transition: border-color 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-family: inherit;
            font-size: 0.95rem;
            resize: none;
            max-height: 150px;
            padding: 8px 0;
            outline: none;
        }

        /* --- Action Buttons --- */
        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .action-btn.send-btn {
            background: var(--primary-color);
            color: white;
        }
        
        .action-btn.send-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.05);
        }
        
        .action-btn.send-btn:disabled {
            background: #475569;
            cursor: not-allowed;
            transform: none;
        }

        .action-btn.recording {
            color: #ef4444; /* Red for recording */
            animation: pulse 1.5s infinite;
            background: rgba(239, 68, 68, 0.1);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* --- File Upload Styling --- */
        #imageInput { display: none; }
        
        .image-preview {
            display: none;
            position: absolute;
            bottom: 90px;
            left: 30px;
            background: #1e293b;
            padding: 8px;
            border-radius: 12px;
            border: var(--glass-border);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .image-preview img {
            height: 80px;
            border-radius: 8px;
            display: block;
        }
        
        .remove-img {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Loading Dot Animation --- */
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: var(--text-muted);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

    </style>
</head>
<body>

    <div class="chat-container">
        <div class="chat-header">
            <h1><i class="fa-solid fa-robot"></i> GoldenSpace AI <span class="model-badge">Unlimited</span></h1>
            <div class="header-controls">
                <button class="control-btn" onclick="loadChatHistory()">
                    <i class="fa-solid fa-history"></i> Load History
                </button>
                <button class="control-btn" onclick="clearChatHistory()">
                    <i class="fa-solid fa-trash"></i> Clear History
                </button>
                <div style="font-size: 0.85rem; color: var(--text-muted);">
                    <i class="fa-solid fa-circle" style="color: #10b981; font-size: 8px; margin-right: 5px;"></i> Online
                </div>
            </div>
        </div>

        <div id="chat-box">
            <div class="message ai">
                <div class="avatar"><i class="fa-solid fa-robot"></i></div>
                <div class="msg-content">
                    Hello! I am your advanced AI assistant. <br>
                    You can type, <b>speak</b>, or upload <b>images</b>. How can I help you today?
                </div>
            </div>
        </div>

        <div id="preview-container" class="image-preview">
            <button class="remove-img" onclick="clearImage()">Ã—</button>
            <img id="preview-img" src="" alt="Preview">
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <button class="action-btn" onclick="document.getElementById('imageInput').click()" title="Upload Image">
                    <i class="fa-regular fa-image"></i>
                </button>
                <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)">

                <button class="action-btn" id="mic-btn" onclick="toggleSpeech()" title="Speak">
                    <i class="fa-solid fa-microphone"></i>
                </button>

                <textarea id="userInput" rows="1" placeholder="Type a message or speak..." oninput="autoResize(this)"></textarea>

                <button class="action-btn send-btn" id="sendBtn" onclick="sendMessage()">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
            <div style="text-align: center; font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">
                AI can make mistakes. Please verify important information.
            </div>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById("chat-box");
        const userInput = document.getElementById("userInput");
        const sendBtn = document.getElementById("sendBtn");
        const previewContainer = document.getElementById("preview-container");
        const previewImg = document.getElementById("preview-img");
        const micBtn = document.getElementById("mic-btn");

        let selectedImage = null;
        let isRecording = false;
        let recognition = null;
        let chatHistory = [];
        const STORAGE_KEY = 'goldenspace_ai_chat_history';

        // --- Initialize Chat from Local Storage ---
        function initializeChat() {
            loadChatFromStorage();
            // Display welcome message only if no history exists
            if (chatHistory.length === 0) {
                chatHistory.push({
                    role: 'ai',
                    text: 'Hello! I am your advanced AI assistant. <br>You can type, <b>speak</b>, or upload <b>images</b>. How can I help you today?',
                    timestamp: new Date().toISOString()
                });
            }
            renderChatHistory();
        }

        // --- Local Storage Functions ---
        function saveChatToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory));
                console.log('Chat saved to local storage:', chatHistory.length, 'messages');
            } catch (error) {
                console.error('Error saving to local storage:', error);
            }
        }

        function loadChatFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    chatHistory = JSON.parse(saved);
                    console.log('Chat loaded from local storage:', chatHistory.length, 'messages');
                }
            } catch (error) {
                console.error('Error loading from local storage:', error);
                chatHistory = [];
            }
        }

        function clearChatHistory() {
            if (confirm('Are you sure you want to clear all chat history? This cannot be undone.')) {
                chatHistory = [];
                localStorage.removeItem(STORAGE_KEY);
                renderChatHistory();
                
                // Add a fresh welcome message
                addMessageToChat('ai', 'Hello! I am your advanced AI assistant. <br>You can type, <b>speak</b>, or upload <b>images</b>. How can I help you today?');
            }
        }

        function loadChatHistory() {
            loadChatFromStorage();
            renderChatHistory();
            alert(`Loaded ${chatHistory.length} messages from history.`);
        }

        function renderChatHistory() {
            chatBox.innerHTML = '';
            chatHistory.forEach(msg => {
                addMessageToChat(msg.role, msg.text, msg.imageUrl);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- Auto Resize Textarea ---
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
            if(textarea.value === '') textarea.style.height = 'auto';
        }

        // --- Handle Image Upload ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                selectedImage = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewContainer.style.display = "block";
                }
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            selectedImage = null;
            document.getElementById("imageInput").value = "";
            previewContainer.style.display = "none";
        }

        // --- Speech Recognition ---
        function toggleSpeech() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                alert("Speech recognition is not supported in this browser. Try Chrome, Edge, or Safari.");
                return;
            }

            if (isRecording) {
                recognition.stop();
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = function() {
                isRecording = true;
                micBtn.classList.add("recording");
                userInput.placeholder = "Listening...";
                micBtn.title = "Stop recording";
            };

            recognition.onend = function() {
                isRecording = false;
                micBtn.classList.remove("recording");
                userInput.placeholder = "Type a message or speak...";
                micBtn.title = "Speak";
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                userInput.value = (userInput.value ? userInput.value + ' ' : '') + transcript;
                autoResize(userInput);
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                isRecording = false;
                micBtn.classList.remove("recording");
                userInput.placeholder = "Type a message or speak...";
                micBtn.title = "Speak";
                
                if (event.error === 'not-allowed') {
                    alert('Microphone access denied. Please allow microphone access in your browser settings.');
                }
            };

            recognition.start();
        }

        // --- Text to Speech ---
        function speakText(text) {
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                // Remove HTML tags and clean text for speech
                const cleanText = text.replace(/<[^>]*>/g, '');
                
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'en-US';
                utterance.rate = 1;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                // Get available voices
                const voices = window.speechSynthesis.getVoices();
                if (voices.length > 0) {
                    // Prefer a natural-sounding voice
                    const preferredVoice = voices.find(voice => 
                        voice.lang.includes('en') && voice.name.includes('Natural')
                    ) || voices.find(voice => voice.lang.includes('en-US')) || voices[0];
                    
                    utterance.voice = preferredVoice;
                }
                
                // Speak the text
                window.speechSynthesis.speak(utterance);
            } else {
                alert('Text-to-speech is not supported in this browser.');
            }
        }

        // --- Send Message Logic ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text && !selectedImage) return;

            // 1. Save image URL if exists
            let imageUrl = null;
            if (selectedImage) {
                imageUrl = URL.createObjectURL(selectedImage);
            }

            // 2. Add User Message to Chat and History
            addMessageToChat("user", text, imageUrl);
            chatHistory.push({
                role: 'user',
                text: text,
                imageUrl: imageUrl,
                timestamp: new Date().toISOString()
            });
            
            // Clear inputs
            userInput.value = "";
            userInput.style.height = 'auto';
            const imageToSend = selectedImage;
            clearImage();

            // 3. Add Loading Indicator
            const loadingId = addLoadingIndicator();
            
            // 4. Prepare Data
            const formData = new FormData();
            formData.append("message", text);
            if (imageToSend) {
                formData.append("image", imageToSend);
            }

            try {
                // 5. Send to Backend (Replace with your actual API endpoint)
                const response = await fetch("/api/unlimited-chat", {
                    method: "POST",
                    body: formData
                });
                
                const data = await response.json();

                // 6. Remove Loading & Add AI Response
                removeLoadingIndicator(loadingId);
                
                if (data.reply) {
                    addMessageToChat("ai", data.reply);
                    chatHistory.push({
                        role: 'ai',
                        text: data.reply,
                        timestamp: new Date().toISOString()
                    });
                } else {
                    const errorMsg = "Error: " + (data.error || "Unknown error occurred.");
                    addMessageToChat("ai", errorMsg);
                    chatHistory.push({
                        role: 'ai',
                        text: errorMsg,
                        timestamp: new Date().toISOString()
                    });
                }

                // 7. Save to local storage
                saveChatToStorage();

            } catch (error) {
                removeLoadingIndicator(loadingId);
                const errorMsg = "Network Error: Could not reach server.";
                addMessageToChat("ai", errorMsg);
                chatHistory.push({
                    role: 'ai',
                    text: errorMsg,
                    timestamp: new Date().toISOString()
                });
                saveChatToStorage();
                console.error(error);
            }
        }

        // --- UI Helper: Add Message ---
        function addMessageToChat(role, text, imageUrl = null) {
            const msgDiv = document.createElement("div");
            msgDiv.className = `message ${role}`;
            
            let contentHtml = text.replace(/\n/g, "<br>");
            
            if (imageUrl) {
                contentHtml += `<br><img src="${imageUrl}" class="chat-image" alt="Uploaded Image">`;
            }

            // If AI, add speaker button
            let toolsHtml = "";
            if (role === "ai") {
                // Clean text for the onclick attribute
                const cleanText = text
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, "&#39;")
                    .replace(/\n/g, " ")
                    .replace(/<[^>]*>/g, '');
                
                toolsHtml = `
                    <div class="msg-tools">
                        <button class="tool-btn" onclick="speakText('${cleanText}')">
                            <i class="fa-solid fa-volume-high"></i> Speak
                        </button>
                        <button class="tool-btn" onclick="navigator.clipboard.writeText('${cleanText.replace(/&quot;/g, '"').replace(/&#39;/g, "'")}')">
                            <i class="fa-regular fa-copy"></i> Copy
                        </button>
                    </div>
                `;
            }

            msgDiv.innerHTML = `
                <div class="avatar">
                    <i class="fa-solid ${role === 'user' ? 'fa-user' : 'fa-robot'}"></i>
                </div>
                <div style="display:flex; flex-direction:column;">
                    <div class="msg-content">${contentHtml}</div>
                    ${toolsHtml}
                </div>
            `;

            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- UI Helper: Loading Indicator ---
        function addLoadingIndicator() {
            const id = "loading-" + Date.now();
            const msgDiv = document.createElement("div");
            msgDiv.className = "message ai";
            msgDiv.id = id;
            msgDiv.innerHTML = `
                <div class="avatar"><i class="fa-solid fa-robot"></i></div>
                <div class="msg-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            return id;
        }

        function removeLoadingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // Allow sending with Enter (Shift+Enter for new line)
        userInput.addEventListener("keypress", function(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize the chat when page loads
        document.addEventListener('DOMContentLoaded', initializeChat);

        // Clean up object URLs when page closes
        window.addEventListener('beforeunload', function() {
            chatHistory.forEach(msg => {
                if (msg.imageUrl && msg.imageUrl.startsWith('blob:')) {
                    URL.revokeObjectURL(msg.imageUrl);
                }
            });
        });

    </script>
</body>
</html>
