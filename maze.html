<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Colorful Maze Escape - Pro Edition</title>
    <style>
        :root {
            --gold: #FFD700;
            --bg: #0f0d05;
            --panel: rgba(15, 12, 0, 0.95);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg); 
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        .menu-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--panel);
            padding: 25px;
            border: 2px solid var(--gold);
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
            z-index: 30;
            width: 85%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }

        .menu-screen h1, .menu-screen h2 {
            color: var(--gold);
            margin-top: 0;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            font-size: 2rem;
            letter-spacing: -1px;
        }

        .menu-screen p { color: #ccc; font-size: 0.9rem; margin-bottom: 15px; }

        #ui-layer {
            position: absolute;
            top: 10px;
            width: 95%;
            max-width: 800px;
            display: none; 
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        #ui-title { font-size: 1.1rem; margin: 0; color: var(--gold); }

        canvas {
            background-color: #1a1500;
            border: 3px solid #665500;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            display: none;
            max-width: 95vw;
            max-height: 65vh;
            touch-action: none;
        }

        button {
            background: linear-gradient(180deg, rgba(255,215,0,0.1) 0%, rgba(255,215,0,0) 100%);
            color: var(--gold);
            border: 2px solid var(--gold);
            padding: 10px 18px;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            margin: 5px;
            display: inline-block;
            font-weight: bold;
            text-transform: uppercase;
        }

        button:active { transform: scale(0.95); background: var(--gold); color: #000; }

        .level-btn { display: block; width: 90%; margin: 8px auto; }

        #currency-display { color: #FFD700; font-size: 1rem; display: flex; align-items: center; gap: 5px; }
        .coin-icon { width: 16px; height: 16px; background: var(--gold); border-radius: 50%; display: inline-block; }

        /* Character Grid */
        .char-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        .char-item {
            font-size: 2rem;
            padding: 10px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            background: rgba(255,255,255,0.05);
        }
        .char-item.owned { border-color: rgba(255,215,0,0.3); }
        .char-item.selected { border-color: var(--gold); background: rgba(255,215,0,0.2); }
        .char-item.locked { opacity: 0.4; filter: grayscale(1); }

        /* Custom Menu Styles */
        .custom-row { display: flex; justify-content: space-between; align-items: center; margin: 8px 0; }
        input[type="color"] { background: none; border: 1px solid var(--gold); height: 30px; width: 50px; }

        /* Death Wall Overlay */
        #death-wall {
            position: fixed;
            top: 0; left: 0; height: 100vh; width: 0;
            background: repeating-linear-gradient(-45deg, #cc0000, #cc0000 25px, #8a0000 25px, #8a0000 50px);
            border-right: 15px solid #ff3333;
            z-index: 20;
            display: none;
            pointer-events: none;
        }

        #timer-bar-container {
            position: fixed;
            bottom: 0; left: 0; width: 100%; height: 6px;
            background: rgba(255,255,255,0.1);
            display: none;
            z-index: 21;
        }
        #timer-bar { height: 100%; background: #ff3333; width: 0%; }
        
        /* Swipe Instruction Hint */
        #swipe-hint {
            position: absolute;
            bottom: 30px;
            color: var(--gold);
            opacity: 0.6;
            font-size: 0.8rem;
            display: none;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <!-- TOP HUD -->
    <div id="ui-layer">
        <div>
            <h1 id="ui-title">MAZE</h1>
            <span id="level-display" style="font-size: 0.7rem; color: #aaa;"></span>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <div id="currency-display"><span class="coin-icon"></span> <span id="coin-count">0</span></div>
            <button class="small-btn" style="margin:0; padding: 4px 10px; font-size: 0.7rem;" onclick="showMainMenu()">Exit</button>
        </div>
    </div>

    <!-- MAIN MENU -->
    <div id="main-menu" class="menu-screen">
        <h1>MAZE TYCOON</h1>
        <p>Master the colorful mazes and earn coins.</p>
        <button onclick="startRandom()" class="level-btn">Survival Mode (60s)</button>
        <button onclick="showLevels()" class="level-btn">Levels</button>
        <button onclick="showCharacterShop()" class="level-btn">Change Character</button>
        <button onclick="showCustomMenu()" class="level-btn">Creator Studio</button>
        <div style="margin-top: 15px; font-size: 0.8rem; color: #777;">
            Best: <span id="best-time">--</span>s | Coins: <span id="menu-coin-count">0</span>
        </div>
    </div>

    <!-- CHARACTER SHOP -->
    <div id="shop-menu" class="menu-screen" style="display:none;">
        <h2>Character Shop</h2>
        <p>Unlocked: <span id="unlocked-count">0</span>/100+ | Cost: 50Â¢ each</p>
        <div id="char-list" class="char-grid"></div>
        <button class="level-btn" style="border-color: #888; color: #888; margin-top:20px;" onclick="showMainMenu()">Back</button>
    </div>

    <!-- LEVELS MENU -->
    <div id="levels-menu" class="menu-screen" style="display:none;">
        <h2>Select Difficulty</h2>
        <button class="level-btn" onclick="startLevel(1)">1 - Rookie (5Â¢)</button>
        <button class="level-btn" onclick="startLevel(2)">2 - Skilled (15Â¢)</button>
        <button class="level-btn" onclick="startLevel(3)">3 - Pro (30Â¢)</button>
        <button class="level-btn" onclick="startLevel(4)">4 - Master (60Â¢)</button>
        <button class="level-btn" onclick="startLevel(5)">5 - Legend (150Â¢)</button>
        <button class="level-btn" style="border-color: #888; color: #888;" onclick="showMainMenu()">Back</button>
    </div>

    <!-- CUSTOM MAZE MENU -->
    <div id="custom-menu" class="menu-screen" style="display:none;">
        <h2>Creator Studio</h2>
        <div class="custom-row">
            <label>Size: <span id="size-val">15</span></label>
            <input type="range" id="custom-size" min="5" max="40" value="15" oninput="updateCustomSize(this.value)">
        </div>
        <div class="custom-row"><label>Wall:</label> <input type="color" id="c-wall" value="#FFD700"></div>
        <div class="custom-row"><label>Path:</label> <input type="color" id="c-path" value="#1a1500"></div>
        <div class="custom-row"><label>Goal:</label> <input type="color" id="c-goal" value="#FFA500"></div>
        <button class="level-btn" onclick="startCustom()">Test Creation</button>
        <button class="level-btn" style="border-color: #888; color: #888;" onclick="showMainMenu()">Back</button>
    </div>

    <!-- GAME CANVAS -->
    <canvas id="mazeCanvas" width="600" height="600"></canvas>
    <div id="swipe-hint">Swipe to move</div>

    <!-- OVERLAYS -->
    <div id="death-wall"></div>
    <div id="timer-bar-container"><div id="timer-bar"></div></div>

    <div id="win-screen" class="menu-screen" style="display:none;">
        <h2 id="win-header">ESCAPED!</h2>
        <p id="win-text">You found the exit.</p>
        <div id="reward-box" style="margin-bottom: 20px; font-size: 1.5rem; color: var(--gold); font-weight: bold;">
            +<span id="reward-amt">0</span> Coins
        </div>
        <div id="win-buttons"></div>
    </div>

    <div id="lose-screen" class="menu-screen" style="display:none; border-color: #ff0000;">
        <h2 style="color: #ff0000;">TIME'S UP</h2>
        <p>The crushing wall caught you.</p>
        <button onclick="startRandom()" style="border-color: #ff0000; color: #ff0000;">Try Again</button>
        <button style="border-color: #888; color: #888;" onclick="showMainMenu()">Main Menu</button>
    </div>

    <script>
        const canvas = document.getElementById('mazeCanvas');
        const ctx = canvas.getContext('2d');
        const winScreen = document.getElementById('win-screen');
        const loseScreen = document.getElementById('lose-screen');
        const levelDisplay = document.getElementById('level-display');
        const mainMenu = document.getElementById('main-menu');
        const shopMenu = document.getElementById('shop-menu');
        const charList = document.getElementById('char-list');
        const levelsMenu = document.getElementById('levels-menu');
        const customMenu = document.getElementById('custom-menu');
        const uiLayer = document.getElementById('ui-layer');
        const uiTitle = document.getElementById('ui-title');
        const deathWallOverlay = document.getElementById('death-wall');
        const timerBar = document.getElementById('timer-bar');
        const timerContainer = document.getElementById('timer-bar-container');
        const coinDisplay = document.getElementById('coin-count');
        const menuCoinDisplay = document.getElementById('menu-coin-count');
        const bestTimeDisplay = document.getElementById('best-time');
        const swipeHint = document.getElementById('swipe-hint');

        // Persistent State
        let coins = parseInt(localStorage.getItem('mz_coins')) || 0;
        let bestSurvivalTime = parseInt(localStorage.getItem('mz_best')) || 0;
        let ownedChars = JSON.parse(localStorage.getItem('mz_owned')) || ['ðŸš€'];
        let selectedChar = localStorage.getItem('mz_current') || 'ðŸš€';

        const EMOJIS = "ðŸš€,â­,ðŸ”¥,ðŸ’Ž,ðŸ¤–,ðŸ±,ðŸ¶,ðŸ¦Š,ðŸ¦,ðŸ¯,ðŸ¸,ðŸµ,ðŸ§,ðŸ¤,ðŸ¦„,ðŸ¦‰,ðŸ,ðŸ¦‹,ðŸ¢,ðŸ™,ðŸ‹,ðŸ¦–,ðŸ‰,ðŸŒµ,ðŸŒ²,ðŸŒ´,ðŸ„,ðŸŽ,ðŸ‰,ðŸ¦,ðŸ©,ðŸ­,ðŸ•,ðŸ”,ðŸŸ,âš½,ðŸ€,ðŸŽ¨,ðŸŽ­,ðŸŽ¸,ðŸŽ®,ðŸ›¸,ðŸš€,ðŸ›°ï¸,ðŸª,ðŸŒ“,ðŸŒ‹,ðŸŒ€,ðŸŒˆ,â˜€ï¸,âš¡,â„ï¸,ðŸ„,ðŸŒ»,ðŸ€,ðŸ,ðŸ’,ðŸ“,ðŸ,ðŸ¥¥,ðŸ¥‘,ðŸ¥¨,ðŸ¥¯,ðŸ£,ðŸŒ®,ðŸ§,ðŸ¥§,ðŸ­,ðŸ«,ðŸ¿,ðŸ€,âš½,ðŸŽ¾,ðŸŽ±,ðŸŽ³,â™Ÿï¸,ðŸ¹,ðŸª,ðŸ¥Š,ðŸ‚,ðŸ§—,ðŸš´,ðŸš£,ðŸ°,â›©ï¸,ðŸ—½,ðŸ—¼,ðŸ”ï¸,ðŸœï¸,ðŸŒ‹,ðŸ›¸,ðŸ›´,â›µ,ðŸš,âš“,ðŸ§­,â°,ðŸ”‹,ðŸ§¿,ðŸ”®,ðŸ§¿,ðŸ§¬,ðŸ§ª,ðŸ”­,ðŸŒ¡ï¸,ðŸ§±,ðŸ§²,ðŸ’£,ðŸ›¡ï¸,ðŸ—ï¸,ðŸŽ,ðŸŽŠ,ðŸŽˆ,ðŸŽ€,ðŸª„,ðŸ§¿".split(',');

        let cols, rows, w; 
        let grid = [];
        let player, goal;
        let gameMode = 'MENU'; 
        let currentLevel = 1;
        let startTime = 0;
        let deathWallScreenX = 0;
        const SURVIVAL_TIME = 60000; 
        let themeWall, themePlayer, themeGoal, themePath;

        const THEMES = [
            { wall: '#FFD700', goal: '#FFA500', path: '#1a1500', name: "GOLDEN" },
            { wall: '#00FFFF', goal: '#00FF00', path: '#001a1a', name: "CYBER" },
            { wall: '#FF00FF', goal: '#FFFF00', path: '#1a001a', name: "NEON" },
            { wall: '#00FF00', goal: '#FF0000', path: '#001a00', name: "TOXIC" },
            { wall: '#FF4500', goal: '#FFD700', path: '#1a0500', name: "LAVA" },
            { wall: '#8A2BE2', goal: '#FF1493', path: '#0d001a', name: "MAGIC" }
        ];

        function saveState() {
            localStorage.setItem('mz_coins', coins);
            localStorage.setItem('mz_best', bestSurvivalTime);
            localStorage.setItem('mz_owned', JSON.stringify(ownedChars));
            localStorage.setItem('mz_current', selectedChar);
            coinDisplay.innerText = coins;
            menuCoinDisplay.innerText = coins;
            bestTimeDisplay.innerText = bestSurvivalTime;
        }

        // --- NAVIGATION ---
        function hideAllScreens() {
            [mainMenu, levelsMenu, customMenu, shopMenu, winScreen, loseScreen, canvas, uiLayer, deathWallOverlay, timerContainer, swipeHint].forEach(el => el.style.display = 'none');
        }

        function showMainMenu() {
            gameMode = 'MENU';
            hideAllScreens();
            mainMenu.style.display = 'block';
            saveState();
        }

        function showLevels() { hideAllScreens(); levelsMenu.style.display = 'block'; }
        function showCustomMenu() { hideAllScreens(); customMenu.style.display = 'block'; }
        
        function showCharacterShop() {
            hideAllScreens();
            shopMenu.style.display = 'block';
            renderShop();
        }

        function renderShop() {
            charList.innerHTML = '';
            EMOJIS.forEach(emoji => {
                const isOwned = ownedChars.includes(emoji);
                const isSelected = selectedChar === emoji;
                const div = document.createElement('div');
                div.className = `char-item ${isOwned ? 'owned' : 'locked'} ${isSelected ? 'selected' : ''}`;
                div.innerText = emoji;
                div.onclick = () => {
                    if (isOwned) {
                        selectedChar = emoji;
                        saveState();
                        renderShop();
                    } else if (coins >= 50) {
                        coins -= 50;
                        ownedChars.push(emoji);
                        selectedChar = emoji;
                        saveState();
                        renderShop();
                    }
                };
                charList.appendChild(div);
            });
            document.getElementById('unlocked-count').innerText = ownedChars.length;
        }

        function updateCustomSize(val) { document.getElementById('size-val').innerText = val; }

        // --- THEMES ---
        function applyDefaultTheme() {
            let t = THEMES[Math.floor(Math.random() * THEMES.length)];
            themeWall = t.wall; themeGoal = t.goal; themePath = t.path;
            uiTitle.innerText = t.name + " MAZE"; uiTitle.style.color = themeWall;
            canvas.style.borderColor = themeWall;
        }

        function applyCustomTheme() {
            themeWall = document.getElementById('c-wall').value; themePath = document.getElementById('c-path').value;
            themeGoal = document.getElementById('c-goal').value;
            uiTitle.innerText = "CUSTOM MAZE"; uiTitle.style.color = themeWall;
            canvas.style.borderColor = themeWall;
        }

        // --- GAME START ---
        function startRandom() {
            gameMode = 'RANDOM'; applyDefaultTheme();
            startTime = Date.now(); deathWallScreenX = 0;
            setupGame(Math.floor(Math.random() * 5) + 12, 12, "Survival");
            deathWallOverlay.style.display = 'block'; timerContainer.style.display = 'block';
        }

        function startLevel(lvl) {
            gameMode = 'CAMPAIGN'; applyDefaultTheme(); currentLevel = lvl;
            let size = [0, 10, 15, 22, 32, 45][lvl];
            setupGame(size, size, `Level ${lvl}`);
        }

        function startCustom() {
            gameMode = 'CUSTOM'; applyCustomTheme();
            let size = parseInt(document.getElementById('custom-size').value);
            setupGame(size, size, "Custom");
        }

        function setupGame(c, r, titleText) {
            hideAllScreens();
            canvas.style.display = 'block'; uiLayer.style.display = 'flex';
            swipeHint.style.display = 'block';
            levelDisplay.innerText = titleText; coinDisplay.innerText = coins;
            cols = c; rows = r; w = canvas.width / cols;
            grid = [];
            for (let y = 0; y < rows; y++) for (let x = 0; x < cols; x++) grid.push(new Cell(x, y));
            generateMaze();
            player = { c: 0, r: 0 }; goal = { c: cols - 1, r: rows - 1 };
        }

        class Cell {
            constructor(c, r) { this.c = c; this.r = r; this.walls = [true, true, true, true]; this.visited = false; }
            checkNeighbors() {
                let neighbors = [];
                let t = grid[index(this.c, this.r-1)], r = grid[index(this.c+1, this.r)], b = grid[index(this.c, this.r+1)], l = grid[index(this.c-1, this.r)];
                if (t && !t.visited) neighbors.push(t); if (r && !r.visited) neighbors.push(r); if (b && !b.visited) neighbors.push(b); if (l && !l.visited) neighbors.push(l);
                return neighbors.length > 0 ? neighbors[Math.floor(Math.random() * neighbors.length)] : undefined;
            }
        }

        function index(c, r) { return (c < 0 || r < 0 || c >= cols || r >= rows) ? -1 : c + r * cols; }
        function removeWalls(a, b) {
            let x = a.c - b.c, y = a.r - b.r;
            if (x === 1) { a.walls[3] = false; b.walls[1] = false; } else if (x === -1) { a.walls[1] = false; b.walls[3] = false; }
            if (y === 1) { a.walls[0] = false; b.walls[2] = false; } else if (y === -1) { a.walls[2] = false; b.walls[0] = false; }
        }

        function generateMaze() {
            let stack = []; let current = grid[0]; current.visited = true;
            while(true) {
                let next = current.checkNeighbors();
                if (next) { next.visited = true; stack.push(current); removeWalls(current, next); current = next; }
                else if (stack.length > 0) { current = stack.pop(); } else break;
            }
        }

        // --- RENDER ---
        function gameLoop() {
            if (['RANDOM', 'CAMPAIGN', 'CUSTOM'].includes(gameMode)) {
                drawGame();
                if (gameMode === 'RANDOM') {
                    let elapsed = Date.now() - startTime;
                    let progress = Math.min(elapsed / SURVIVAL_TIME, 1);
                    deathWallScreenX = progress * window.innerWidth;
                    deathWallOverlay.style.width = deathWallScreenX + 'px';
                    timerBar.style.width = (progress * 100) + '%';
                    checkDeath();
                }
            }
            requestAnimationFrame(gameLoop);
        }

        function drawGame() {
            ctx.fillStyle = themePath; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = themeWall; ctx.lineWidth = cols < 20 ? 4 : 2; ctx.lineCap = 'round';
            ctx.beginPath();
            grid.forEach(cell => {
                let x = cell.c * w, y = cell.r * w;
                if (cell.walls[0]) { ctx.moveTo(x, y); ctx.lineTo(x + w, y); }
                if (cell.walls[1]) { ctx.moveTo(x + w, y); ctx.lineTo(x + w, y + w); }
                if (cell.walls[2]) { ctx.moveTo(x + w, y + w); ctx.lineTo(x, y + w); }
                if (cell.walls[3]) { ctx.moveTo(x, y + w); ctx.lineTo(x, y); }
            });
            ctx.stroke();
            let pad = w * 0.2;
            ctx.fillStyle = themeGoal; ctx.fillRect(goal.c * w + pad, goal.r * w + pad, w - pad * 2, w - pad * 2);
            
            // Draw Emoji Player
            ctx.font = `${w * 0.8}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(selectedChar, player.c * w + w/2, player.r * w + w/2 + 2);
        }

        // --- MOVE LOGIC ---
        function handleMove(dir) {
            if (!['RANDOM', 'CAMPAIGN', 'CUSTOM'].includes(gameMode)) return;
            let currentCell = grid[index(player.c, player.r)];
            if (dir === 'up' && !currentCell.walls[0]) player.r--;
            if (dir === 'right' && !currentCell.walls[1]) player.c++;
            if (dir === 'down' && !currentCell.walls[2]) player.r++;
            if (dir === 'left' && !currentCell.walls[3]) player.c--;
            checkWin();
        }

        // GESTURE DETECTION (Upgraded Swipe)
        let touchStartX = 0, touchStartY = 0;
        window.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; }, {passive: false});
        window.addEventListener('touchend', e => {
            let diffX = e.changedTouches[0].clientX - touchStartX;
            let diffY = e.changedTouches[0].clientY - touchStartY;
            // Threshold for movement
            if (Math.abs(diffX) > 20 || Math.abs(diffY) > 20) {
                if (Math.abs(diffX) > Math.abs(diffY)) handleMove(diffX > 0 ? 'right' : 'left');
                else handleMove(diffY > 0 ? 'down' : 'up');
            }
        }, false);

        window.addEventListener('keydown', e => {
            if (e.key === 'ArrowUp' || e.key === 'w') handleMove('up');
            if (e.key === 'ArrowRight' || e.key === 'd') handleMove('right');
            if (e.key === 'ArrowDown' || e.key === 's') handleMove('down');
            if (e.key === 'ArrowLeft' || e.key === 'a') handleMove('left');
            if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault();
        });

        // --- WIN/LOSE ---
        function checkWin() {
            if (player.c === goal.c && player.r === goal.r) {
                let reward = gameMode === 'RANDOM' ? 50 : (gameMode === 'CAMPAIGN' ? [0, 5, 15, 30, 60, 150][currentLevel] : 0);
                if (gameMode === 'RANDOM') {
                    let sec = Math.floor((Date.now() - startTime)/1000);
                    if (sec > bestSurvivalTime) bestSurvivalTime = sec;
                }
                coins += reward; hideAllScreens();
                saveState();
                winScreen.style.display = 'block'; document.getElementById('reward-amt').innerText = reward;
                document.getElementById('win-buttons').innerHTML = (gameMode === 'CAMPAIGN' && currentLevel < 5) ? `<button onclick="startLevel(${currentLevel+1})">Next Level</button>` : `<button onclick="showMainMenu()">Menu</button>`;
                gameMode = 'WON';
            }
        }

        function checkDeath() {
            let rect = canvas.getBoundingClientRect();
            if (deathWallScreenX >= (rect.left + (player.c * w) + (w * 0.2))) {
                gameMode = 'LOST'; hideAllScreens(); loseScreen.style.display = 'block';
            }
        }

        // Initialize HUD
        saveState();
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
