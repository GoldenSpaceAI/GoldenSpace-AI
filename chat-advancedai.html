<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GoldenSpaceAI ‚Ä¢ Advanced Chat</title>
<style>
:root {
  --gold1:#ffd700;
  --gold2:#ffed4e;
  --border:rgba(255,255,255,.15);
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:"Segoe UI",Roboto,sans-serif;
  color:#fff;
  background:#000 url("https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=2400&auto=format&fit=crop") center/cover fixed no-repeat;
  min-height:100vh;
  display:flex;
  overflow:hidden;
}
/* Sidebar Styles */
#sidebar{
  width:300px;
  background:rgba(0,0,0,.85);
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  height:100vh;
  transition:transform 0.3s ease;
}
.sidebar-header{
  padding:20px;
  border-bottom:1px solid var(--border);
}
.new-chat-btn{
  width:100%;
  padding:12px;
  background:linear-gradient(45deg,var(--gold1),var(--gold2));
  border:none;
  border-radius:10px;
  color:#141000;
  font-weight:800;
  cursor:pointer;
  margin-bottom:10px;
  transition:transform 0.2s ease;
}
.new-chat-btn:hover{
  transform:translateY(-2px);
}
.custom-instructions-btn{
  width:100%;
  padding:10px;
  background:rgba(255,255,255,.1);
  border:1px solid var(--border);
  border-radius:8px;
  color:var(--gold1);
  font-weight:600;
  cursor:pointer;
  margin-bottom:15px;
  transition:all 0.2s ease;
}
.custom-instructions-btn:hover{
  background:rgba(255,255,255,.15);
  transform:translateY(-1px);
}
.chats-list{
  flex:1;
  overflow-y:auto;
  padding:0 15px 15px;
}
.chat-item{
  padding:12px;
  margin-bottom:8px;
  background:rgba(255,255,255,.08);
  border-radius:8px;
  cursor:pointer;
  border:1px solid transparent;
  transition:all 0.2s ease;
}
.chat-item:hover{
  background:rgba(255,255,255,.12);
  transform:translateY(-1px);
}
.chat-item.active{
  border-color:var(--gold1);
  background:rgba(255,215,0,.1);
}
.chat-preview{
  font-size:12px;
  color:#aaa;
  margin-top:4px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.delete-btn{
  float:right;
  color:#ff5555;
  cursor:pointer;
  font-size:12px;
  padding:2px 6px;
  border-radius:4px;
  transition:background 0.2s ease;
}
.delete-btn:hover{
  background:rgba(255,85,85,.2);
}

/* Main Content */
#main-content{
  flex:1;
  display:flex;
  flex-direction:column;
  height:100vh;
}
header{
  background:rgba(0,0,0,.7);
  backdrop-filter:blur(10px);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 20px;
  border-bottom:1px solid var(--border);
  z-index:100;
}
header .logo{
  width:34px;
  height:34px;
  border-radius:50%;
  background:conic-gradient(from 200deg,var(--gold1),var(--gold2),#b89200,var(--gold1));
  box-shadow:0 0 10px rgba(255,215,0,.4);
}
header h1{
  margin:0;
  font-size:18px;
  color:var(--gold1);
  font-weight:900;
}
#userBalance{
  font-size:14px;
  color:#ddd;
  font-weight:600;
}
.menuBtn{
  background:none;
  border:none;
  color:var(--gold1);
  font-size:24px;
  font-weight:bold;
  cursor:pointer;
  margin-left:10px;
  transition:transform 0.2s ease;
}
.menuBtn:hover{
  transform:scale(1.1);
}

/* Lock Screen */
#locked{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.8);
  backdrop-filter:blur(20px);
  position:relative;
  z-index:50;
}
.lockBox{
  background:rgba(0,0,0,.9);
  padding:40px 30px;
  border:2px solid var(--gold1);
  border-radius:20px;
  max-width:400px;
  text-align:center;
  box-shadow:0 0 50px rgba(255,215,0,.3);
  animation:fadeIn 0.5s ease;
}
.lockBox h2{
  color:var(--gold1);
  font-size:28px;
  margin:0 0 15px 0;
}
.lockBox p{
  font-size:16px;
  margin-bottom:25px;
  line-height:1.5;
  color:#ddd;
}
.lockBtn{
  background:linear-gradient(45deg,var(--gold1),var(--gold2));
  border:none;
  border-radius:12px;
  padding:15px 30px;
  font-weight:800;
  font-size:16px;
  color:#141000;
  cursor:pointer;
  transition:all 0.3s ease;
  box-shadow:0 5px 15px rgba(255,215,0,.3);
}
.lockBtn:hover{
  transform:translateY(-3px);
  box-shadow:0 8px 25px rgba(255,215,0,.4);
}
.lockBtn:active{
  transform:translateY(-1px);
}

/* Chat Area */
#chatArea{
  flex:1;
  overflow-y:auto;
  padding:20px;
  display:none;
}
.msg{
  max-width:800px;
  margin:15px auto;
  padding:15px 20px;
  border-radius:15px;
  border:1px solid var(--border);
  backdrop-filter:blur(6px);
  word-wrap:break-word;
  animation:fadeIn 0.3s ease;
}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px);}
  to{opacity:1;transform:translateY(0);}
}
.msg.user{
  background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(255,215,0,.08));
  margin-left:auto;
  margin-right:0;
  border-color:rgba(255,215,0,.3);
}
.msg.ai{
  background:rgba(15,15,30,.7);
  border-color:rgba(255,255,255,.1);
}
.msg small{
  display:block;
  font-size:.75rem;
  opacity:.6;
  margin-bottom:5px;
  font-weight:600;
}
.msg img{
  max-width:100%;
  border-radius:10px;
  margin-top:10px;
  border:1px solid var(--border);
  box-shadow:0 5px 15px rgba(0,0,0,.3);
}
.thinking{
  color:var(--gold1);
  font-style:italic;
  animation:pulse 1.5s infinite;
}
@keyframes pulse{
  0%, 100%{opacity:1;}
  50%{opacity:0.7;}
}

/* Feature Bar */
#featureBar{
  display:none;
  justify-content:center;
  gap:15px;
  padding:15px;
  background:rgba(0,0,0,.7);
  border-bottom:1px solid var(--border);
  backdrop-filter:blur(10px);
}
.featureBtn{
  background:rgba(255,255,255,.1);
  border:1px solid var(--border);
  border-radius:12px;
  color:var(--gold1);
  padding:12px 20px;
  text-align:center;
  font-weight:600;
  cursor:pointer;
  transition:all 0.3s ease;
  min-width:140px;
  backdrop-filter:blur(5px);
}
.featureBtn:hover{
  background:rgba(255,255,255,.15);
  transform:translateY(-3px);
  box-shadow:0 5px 15px rgba(0,0,0,.2);
}
.featureBtn.active{
  background:rgba(255,215,0,.2);
  border-color:var(--gold1);
  box-shadow:0 0 20px rgba(255,215,0,.3);
}

/* Footer - Floating 2cm from bottom */
footer{
  background:rgba(0,0,0,.75);
  backdrop-filter:blur(12px);
  border-top:1px solid var(--border);
  padding:20px;
  display:none;
  margin-top:auto;
}
#composer{
  display:flex;
  gap:12px;
  max-width:900px;
  margin:auto;
  align-items:end;
}
#prompt{
  flex:1;
  resize:none;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.2);
  background:rgba(255,255,255,.08);
  color:#fff;
  padding:12px 16px;
  min-height:50px;
  font-family:inherit;
  max-height:120px;
  transition:all 0.3s ease;
}
#prompt:focus{
  outline:none;
  border-color:var(--gold1);
  background:rgba(255,255,255,.12);
  box-shadow:0 0 10px rgba(255,215,0,.2);
}
button.send{
  background:linear-gradient(45deg,var(--gold1),var(--gold2));
  border:none;
  border-radius:12px;
  padding:12px 24px;
  font-weight:800;
  color:#141000;
  cursor:pointer;
  transition:all 0.3s ease;
  height:50px;
  box-shadow:0 4px 12px rgba(255,215,0,.3);
}
button.send:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(255,215,0,.4);
}
button.send:active{
  transform:translateY(0);
}

/* Custom Instructions Modal */
.modal-overlay{
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,.8);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
  display:none;
  backdrop-filter:blur(5px);
}
.modal-content{
  background:rgba(0,0,0,.95);
  border:2px solid var(--gold1);
  border-radius:20px;
  padding:30px;
  max-width:500px;
  width:90%;
  max-height:80vh;
  overflow-y:auto;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
  animation:modalSlideIn 0.3s ease;
}
@keyframes modalSlideIn{
  from{opacity:0;transform:scale(0.9);}
  to{opacity:1;transform:scale(1);}
}
.modal-content h3{
  color:var(--gold1);
  margin:0 0 15px 0;
  text-align:center;
  font-size:24px;
}
.modal-textarea{
  width:100%;
  height:200px;
  background:rgba(255,255,255,.08);
  border:1px solid var(--border);
  border-radius:10px;
  color:#fff;
  padding:15px;
  font-family:inherit;
  resize:vertical;
  margin-bottom:15px;
  transition:all 0.3s ease;
}
.modal-textarea:focus{
  outline:none;
  border-color:var(--gold1);
  background:rgba(255,255,255,.12);
}
.modal-buttons{
  display:flex;
  gap:10px;
  justify-content:flex-end;
}
.modal-btn{
  padding:10px 20px;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.3s ease;
}
.modal-btn.save{
  background:var(--gold1);
  color:#141000;
  box-shadow:0 4px 12px rgba(255,215,0,.3);
}
.modal-btn.save:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(255,215,0,.4);
}
.modal-btn.cancel{
  background:rgba(255,255,255,.1);
  color:#fff;
}
.modal-btn.cancel:hover{
  background:rgba(255,255,255,.2);
  transform:translateY(-2px);
}

/* Mobile Responsive */
@media(max-width:768px){
  #sidebar{
    position:fixed;
    left:-300px;
    top:0;
    height:100vh;
    z-index:1000;
    width:280px;
  }
  #sidebar.active{
    left:0;
  }
  .menuBtn{
    display:block;
  }
  #featureBar{
    flex-wrap:wrap;
    gap:8px;
    padding:10px;
  }
  .featureBtn{
    min-width:120px;
    padding:10px 15px;
    font-size:14px;
  }
  .lockBox{
    margin:20px;
    padding:30px 20px;
  }
  .modal-content{
    margin:20px;
    padding:20px;
  }
}
</style>
</head>
<body>
<!-- Sidebar -->
<div id="sidebar">
  <div class="sidebar-header">
    <button class="new-chat-btn" id="newChat">Ôºã New Chat</button>
    <button class="custom-instructions-btn" id="customInstructionsBtn">‚öôÔ∏è Custom Instructions</button>
  </div>
  <div class="chats-list" id="chatsList">
    <div style="color:#888; text-align:center; padding:20px;">Loading chats...</div>
  </div>
</div>

<!-- Main Content -->
<div id="main-content">
  <header>
    <div style="display:flex;align-items:center;gap:12px;">
      <button class="menuBtn" id="toggleSidebar">‚ò∞</button>
      <div class="logo"></div>
      <h1>GoldenSpaceAI</h1>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <span id="userBalance">G: ‚Äî</span>
    </div>
  </header>

  <!-- Lock Screen -->
  <div id="locked">
    <div class="lockBox">
      <div style="font-size:60px;margin-bottom:20px;">üîí</div>
      <h2>Advanced Chat Locked</h2>
      <p>This premium feature costs <b style="color:var(--gold1);">20 G</b> for 30 days access</p>
      <p>Unlock advanced conversations with GPT-4o, image generation, and smart features</p>
      <button class="lockBtn" id="unlockBtn">Activate for 20 G</button>
      <div id="unlockStatus" style="margin-top:15px;font-size:14px;"></div>
    </div>
  </div>

  <!-- Feature Bar -->
  <div id="featureBar">
    <div class="featureBtn" id="genImage">üñºÔ∏è Generate Image</div>
    <div class="featureBtn" id="studyLearn">üìö Study & Learn</div>
    <div class="featureBtn" id="proThinking">üöÄ Advanced Thinking</div>
  </div>

  <!-- Chat Area -->
  <div id="chatArea">
    <div class="msg ai">
      <small>GoldenSpaceAI</small>
      Welcome to Advanced Chat! You have access to GPT-4o, image generation, and smart features. 
      Start by typing a message or using the feature buttons above.
    </div>
  </div>

  <!-- Footer - Floating 2cm from bottom -->
  <footer>
    <div id="composer">
      <textarea id="prompt" placeholder="Type your message‚Ä¶" rows="1"></textarea>
      <button class="send" id="sendBtn">Send</button>
    </div>
  </footer>
</div>

<!-- Custom Instructions Modal -->
<div class="modal-overlay" id="instructionsModal">
  <div class="modal-content">
    <h3>Custom Instructions</h3>
    <textarea class="modal-textarea" id="instructionsText" placeholder="Tell the AI how to behave. Examples:
‚Ä¢ Always respond in Spanish
‚Ä¢ Be concise and to the point  
‚Ä¢ Explain concepts like I'm a beginner
‚Ä¢ Use formal language
‚Ä¢ Include examples in your answers"></textarea>
    <div class="modal-buttons">
      <button class="modal-btn cancel" id="cancelInstructions">Cancel</button>
      <button class="modal-btn save" id="saveInstructions">Save Instructions</button>
    </div>
  </div>
</div>

<script>
// Global variables
let currentChat = null;
let currentMode = "normal";
let customInstructions = "";
let chatHistory = [];

// DOM Elements
const sidebar = document.getElementById('sidebar');
const chatsList = document.getElementById('chatsList');
const chatArea = document.getElementById('chatArea');
const lockedScreen = document.getElementById('locked');
const featureBar = document.getElementById('featureBar');
const footer = document.querySelector('footer');
const promptInput = document.getElementById('prompt');
const userBalance = document.getElementById('userBalance');
const instructionsModal = document.getElementById('instructionsModal');
const instructionsText = document.getElementById('instructionsText');
const unlockStatus = document.getElementById('unlockStatus');

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log("Initializing Advanced Chat...");
    checkSubscriptionStatus();
    loadCustomInstructions();
    setupEventListeners();
});

// Event Listeners
function setupEventListeners() {
    console.log("Setting up event listeners...");
    
    document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
    document.getElementById('newChat').addEventListener('click', createNewChat);
    document.getElementById('unlockBtn').addEventListener('click', unlockAdvancedChat);
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('genImage').addEventListener('click', () => activateFeature('image'));
    document.getElementById('studyLearn').addEventListener('click', () => activateFeature('study'));
    document.getElementById('proThinking').addEventListener('click', () => activateFeature('pro'));
    document.getElementById('customInstructionsBtn').addEventListener('click', showInstructionsModal);
    document.getElementById('saveInstructions').addEventListener('click', saveInstructions);
    document.getElementById('cancelInstructions').addEventListener('click', hideInstructionsModal);
    
    promptInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    promptInput.addEventListener('input', autoResizeTextarea);
    
    // Close modal when clicking outside
    instructionsModal.addEventListener('click', function(e) {
        if (e.target === instructionsModal) {
            hideInstructionsModal();
        }
    });
    
    console.log("Event listeners setup complete");
}

// Sidebar toggle
function toggleSidebar() {
    sidebar.classList.toggle('active');
}

// Subscription check
async function checkSubscriptionStatus() {
    try {
        console.log("Checking subscription status...");
        const response = await fetch("/api/advanced-ai-status", { 
            credentials: "include",
            headers: {
                'Cache-Control': 'no-cache'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Subscription status:", data);
        
        userBalance.textContent = `G: ${data.balance ?? "0"}`;
        
        if (!data.active) {
            // Show lock screen
            console.log("Feature locked - showing lock screen");
            lockedScreen.style.display = "flex";
            chatArea.style.display = "none";
            featureBar.style.display = "none";
            footer.style.display = "none";
        } else {
            // Remove lock completely - show full chatbot interface
            console.log("Feature unlocked - showing chatbot interface");
            lockedScreen.style.display = "none";
            chatArea.style.display = "block";
            featureBar.style.display = "flex";
            footer.style.display = "block";
            await loadChats();
        }
    } catch (error) {
        console.error("Status check failed:", error);
        lockedScreen.style.display = "flex";
        userBalance.textContent = "G: Error";
    }
}

// Unlock advanced chat - FIXED VERSION
async function unlockAdvancedChat() {
    const unlockBtn = document.getElementById('unlockBtn');
    const originalText = unlockBtn.textContent;
    
    try {
        console.log("Attempting to unlock Advanced AI...");
        unlockBtn.disabled = true;
        unlockBtn.textContent = "Processing...";
        unlockStatus.textContent = "‚è≥ Processing your request...";
        unlockStatus.style.color = "#ffd700";

        const response = await fetch("/api/subscribe-advanced-ai", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: "include"
        });

        console.log("Unlock response status:", response.status);
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Unlock response data:", data);

        if (data.success) {
            unlockStatus.textContent = "‚úÖ Success! Unlocking Advanced AI...";
            unlockStatus.style.color = "#90ee90";
            
            // Wait a moment then refresh the interface
            setTimeout(() => {
                checkSubscriptionStatus();
            }, 1500);
            
        } else {
            throw new Error(data.error || "Activation failed");
        }
        
    } catch (error) {
        console.error("Unlock error:", error);
        unlockStatus.textContent = "‚ùå " + error.message;
        unlockStatus.style.color = "#ff6b6b";
        unlockBtn.disabled = false;
        unlockBtn.textContent = originalText;
        
        // Reset status message after 5 seconds
        setTimeout(() => {
            unlockStatus.textContent = "";
        }, 5000);
    }
}

// Chat Management
async function loadChats() {
    try {
        console.log("Loading chats...");
        const response = await fetch("/api/projects", { 
            credentials: "include",
            headers: {
                'Cache-Control': 'no-cache'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Chats loaded:", data);
        
        chatsList.innerHTML = "";
        
        if (!data.projects || !data.projects.length) {
            chatsList.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">No chats yet. Create your first chat!</div>';
            return;
        }
        
        data.projects.forEach(project => {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.innerHTML = `
                <div style="font-weight:600;">${project.name || 'Unnamed Chat'}</div>
                <div class="chat-preview">${project.description || 'No messages yet'}</div>
                <div style="margin-top:5px; display:flex; justify-content:space-between; align-items:center;">
                    <small style="color:#666;">${new Date(project.created_at).toLocaleDateString()}</small>
                    <span class="delete-btn" title="Delete chat">‚úï</span>
                </div>
            `;
            
            chatItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteChat(project.id);
            });
            
            chatItem.addEventListener('click', () => openChat(project));
            chatsList.appendChild(chatItem);
        });
    } catch (error) {
        console.error("Failed to load chats:", error);
        chatsList.innerHTML = '<div style="color:#ff6b6b; text-align:center; padding:20px;">Error loading chats</div>';
    }
}

async function createNewChat() {
    const chatName = prompt("Enter chat name:", `Chat ${new Date().toLocaleDateString()}`);
    if (!chatName || chatName.trim() === '') return;
    
    try {
        console.log("Creating new chat:", chatName);
        const response = await fetch("/api/projects/create", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json" 
            },
            credentials: "include",
            body: JSON.stringify({ 
                name: chatName.trim(), 
                description: "New chat" 
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Create chat response:", data);
        
        if (data.success && data.project) {
            await loadChats();
            openChat(data.project);
        } else {
            throw new Error(data.error || "Failed to create chat");
        }
    } catch (error) {
        console.error("Create chat error:", error);
        alert("‚ùå Failed to create chat: " + error.message);
    }
}

async function openChat(project) {
    if (!project || !project.id) {
        console.error("Invalid project:", project);
        return;
    }
    
    console.log("Opening chat:", project.id, project.name);
    currentChat = project.id;
    
    // Update active chat UI
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Find and activate the clicked chat item
    const chatItems = document.querySelectorAll('.chat-item');
    for (let item of chatItems) {
        if (item.textContent.includes(project.name)) {
            item.classList.add('active');
            break;
        }
    }
    
    // Close sidebar on mobile
    if (window.innerWidth <= 768) {
        sidebar.classList.remove('active');
    }
    
    // Load chat messages
    await loadChatMessages(project.id);
}

async function loadChatMessages(chatId) {
    try {
        console.log("Loading messages for chat:", chatId);
        const response = await fetch(`/api/chat/${chatId}`, { 
            credentials: "include",
            headers: {
                'Cache-Control': 'no-cache'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Messages loaded:", data);
        
        chatArea.innerHTML = "";
        chatHistory = [];
        
        if (data.messages && data.messages.length) {
            data.messages.forEach(message => {
                addMessageToChat(message.sender, message.content, false);
            });
        } else {
            addMessageToChat('ai', 'Welcome to your new chat! Start by sending a message.', false);
        }
        
        chatArea.scrollTop = chatArea.scrollHeight;
    } catch (error) {
        console.error("Failed to load messages:", error);
        addMessageToChat('ai', 'Error loading messages. Please try again.', false);
    }
}

async function deleteChat(chatId) {
    if (!confirm("Are you sure you want to delete this chat? This action cannot be undone.")) return;
    
    try {
        console.log("Deleting chat:", chatId);
        const response = await fetch(`/api/projects/${chatId}`, {
            method: "DELETE",
            credentials: "include"
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            await loadChats();
            
            if (currentChat === chatId) {
                currentChat = null;
                chatArea.innerHTML = '<div class="msg ai"><small>GoldenSpaceAI</small>Select or create a chat to start messaging.</div>';
            }
        } else {
            throw new Error(data.error || "Failed to delete chat");
        }
    } catch (error) {
        console.error("Delete chat error:", error);
        alert("‚ùå Failed to delete chat: " + error.message);
    }
}

// Message Handling
async function sendMessage() {
    const message = promptInput.value.trim();
    if (!message) {
        alert("Please enter a message");
        return;
    }
    
    if (!currentChat) {
        alert("Please create or select a chat first");
        return;
    }
    
    console.log("Sending message:", message, "to chat:", currentChat, "mode:", currentMode);
    
    // Add user message to chat
    addMessageToChat('user', message, true);
    promptInput.value = "";
    promptInput.style.height = 'auto';
    
    // Show thinking indicator
    const thinkingMsg = addMessageToChat('ai', '<span class="thinking">Thinking...</span>', true);
    
    try {
        const requestBody = {
            q: message,
            chat_id: currentChat,
            mode: currentMode,
            custom_instructions: customInstructions
        };
        
        console.log("Sending request to /chat-advanced-ai:", requestBody);
        
        const response = await fetch("/chat-advanced-ai", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json" 
            },
            credentials: "include",
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("AI Response:", data);
        
        // Remove thinking message and add actual response
        thinkingMsg.remove();
        
        if (data.imageUrl) {
            // Handle image response
            addMessageToChat('ai', `![Generated Image](${data.imageUrl})`, true);
        } else if (data.reply) {
            addMessageToChat('ai', data.reply, true);
        } else {
            addMessageToChat('ai', "No response received from AI", true);
        }
        
        // Reset mode after use
        currentMode = "normal";
        resetFeatureButtons();
        
    } catch (error) {
        console.error("Send message error:", error);
        thinkingMsg.remove();
        addMessageToChat('ai', "Error: " + error.message, true);
    }
}

function addMessageToChat(sender, content, saveToHistory = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `msg ${sender}`;
    
    // Handle image URLs in content
    let formattedContent = content;
    const imageMatch = content.match(/!\[.*?\]\((.*?)\)/);
    if (imageMatch) {
        formattedContent = content.replace(/!\[.*?\]\((.*?)\)/, 
            `<img src="${imageMatch[1]}" alt="Generated image" onload="this.scrollIntoView({behavior: 'smooth'})">`);
    }
    
    messageDiv.innerHTML = `<small>${sender === 'ai' ? 'GoldenSpaceAI' : 'You'}</small>${formattedContent}`;
    chatArea.appendChild(messageDiv);
    chatArea.scrollTop = chatArea.scrollHeight;
    
    return messageDiv;
}

// Feature Management
function activateFeature(feature) {
    // Reset all buttons first
    resetFeatureButtons();
    
    switch(feature) {
        case 'image':
            currentMode = 'image';
            document.getElementById('genImage').classList.add('active');
            alert('üñºÔ∏è Image generation activated! Your next message will generate an image.');
            break;
        case 'study':
            currentMode = 'study';
            document.getElementById('studyLearn').classList.add('active');
            alert('üìö Study mode activated! AI will provide detailed explanations.');
            break;
        case 'pro':
            currentMode = 'pro';
            document.getElementById('proThinking').classList.add('active');
            alert('üöÄ Advanced Thinking activated! Your next message will use enhanced reasoning.');
            break;
    }
}

function resetFeatureButtons() {
    document.querySelectorAll('.featureBtn').forEach(btn => {
        btn.classList.remove('active');
    });
}

// Custom Instructions Management
function showInstructionsModal() {
    instructionsText.value = customInstructions;
    instructionsModal.style.display = 'flex';
}

function hideInstructionsModal() {
    instructionsModal.style.display = 'none';
}

async function saveInstructions() {
    customInstructions = instructionsText.value.trim();
    
    try {
        // Save to localStorage
        localStorage.setItem('goldenspace_custom_instructions', customInstructions);
        
        hideInstructionsModal();
        alert('‚úÖ Custom instructions saved! The AI will now follow these guidelines.');
    } catch (error) {
        alert('‚ùå Failed to save instructions: ' + error.message);
    }
}

function loadCustomInstructions() {
    const saved = localStorage.getItem('goldenspace_custom_instructions');
    if (saved) {
        customInstructions = saved;
    }
}

// Auto-resize textarea
function autoResizeTextarea() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
}

// Initialize textarea resize
promptInput.addEventListener('input', autoResizeTextarea);

// Add some console logging for debugging
console.log("Advanced Chat interface loaded successfully");
</script>
</body>
</html>
