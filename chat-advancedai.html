<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GoldenSpaceAI ¬∑ Advanced Assistant</title>
  <style>
    :root{
      --gold-1:#ffd700; --gold-2:#e6c200; --gold-3:#b89700;
      --text:#faf7e8; --muted:#c8b88a;
      --glass: rgba(255,255,255,.08); --ring: rgba(255,215,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 75% -20%, rgba(255,215,0,.18), transparent 40%),
        radial-gradient(800px 600px at 10% 120%, rgba(255,215,0,.08), transparent 45%),
        #05060a;
      background-attachment:fixed; overflow:hidden;
    }
    .stars,.twinkle{position:fixed; inset:0; z-index:-2; pointer-events:none}
    .stars{background-image:url("https://images.unsplash.com/photo-1444703686981-a3abbc4d4fe3?q=80&w=1600&auto=format&fit=crop");
      background-size:cover; filter:saturate(1.05) brightness(.9) contrast(1.1); opacity:.28}
    .twinkle{
      background-image:
        radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.45), transparent 55%),
        radial-gradient(1.5px 1.5px at 70% 60%, rgba(255,255,255,.35), transparent 55%),
        radial-gradient(1.2px 1.2px at 40% 80%, rgba(255,255,255,.4), transparent 55%),
        radial-gradient(1px 1px at 85% 15%, rgba(255,255,255,.5), transparent 55%);
      animation: twinkle 8s linear infinite; opacity:.45
    }
    @keyframes twinkle{0%{filter:brightness(1)}50%{filter:brightness(1.25)}100%{filter:brightness(1)}}

    .wrap{display:grid; grid-template-rows:auto 1fr auto; height:100%}
    header{
      display:flex; align-items:center; gap:.9rem; padding:14px 18px;
      backdrop-filter:blur(8px);
      background:linear-gradient(180deg,rgba(10,10,14,.55),rgba(10,10,14,.25));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .brand{display:flex; align-items:center; gap:.7rem; font-weight:800}
    .logo{
      width:32px;height:32px;border-radius:50%;
      background:conic-gradient(from 210deg,var(--gold-1),var(--gold-2),var(--gold-3),var(--gold-1));
      box-shadow:0 0 0 2px rgba(255,215,0,.25), 0 0 32px rgba(255,215,0,.25) inset;
    }
    .badge{font-size:.75rem;color:#1a1606;background:linear-gradient(180deg,var(--gold-1),var(--gold-2));
      padding:4px 8px;border-radius:999px;box-shadow:0 2px 10px rgba(255,215,0,.25)}
    .model{
      margin-left:12px; height:36px; border-radius:10px; background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12); color:var(--text); padding:0 10px
    }

    main#chat{position:relative;height:100%;overflow:auto;padding:18px 18px 160px;scroll-behavior:smooth}
    .msg{max-width:min(780px,92%);padding:14px 16px;border-radius:16px;margin:10px 0;line-height:1.55;
      box-shadow:0 2px 18px rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px)}
    .msg.user{margin-left:auto;background:linear-gradient(180deg,rgba(255,215,0,.12),rgba(255,215,0,.08));border-color:rgba(255,215,0,.25)}
    .msg.ai{background:rgba(12,12,16,.55)}
    .msg small{display:block;opacity:.65;font-size:.75rem;margin-bottom:6px}
    .spinner{width:20px;height:20px;border-radius:50%;border:2px solid rgba(255,255,255,.2);border-top-color:var(--gold-1);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .composer-wrap{position:fixed;left:0;right:0;bottom:18px;display:flex;justify-content:center;pointer-events:none}
    .composer{
      pointer-events:auto;width:min(980px,92%);display:flex;align-items:center;gap:10px;padding:10px;
      border-radius:18px;background:var(--glass);backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.08); box-shadow:0 10px 30px rgba(0,0,0,.35), 0 0 0 1px var(--ring)
    }
    .btn{border:none;outline:none;cursor:pointer;height:56px;width:56px;border-radius:999px;
      background:rgba(255,255,255,.06);display:grid;place-items:center;transition:.2s transform,.2s background}
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.12)}
    .btn.plus::before{content:"+";font-size:28px;color:var(--gold-1);font-weight:700}
    .btn.send::before{content:"‚û§";font-size:18px;color:#141209;font-weight:700}
    .btn.send{background:linear-gradient(180deg,var(--gold-1),var(--gold-2));box-shadow:0 8px 18px rgba(255,215,0,.25)}

    .mic{position:relative;background:linear-gradient(180deg,var(--gold-1),var(--gold-2));box-shadow:0 8px 18px rgba(255,215,0,.25)}
    .mic::before{content:"üé§";font-size:22px;color:#141209;font-weight:700}

    textarea{flex:1;resize:none;height:56px;max-height:140px;padding:12px 14px;border-radius:12px;
      background:rgba(255,255,255,.06);color:var(--text);border:1px solid rgba(255,255,255,.09);outline:none;font-size:15px}

    .hidden{display:none}
    .attachments{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.1);
      background:rgba(255,255,255,.06);padding:6px 8px;border-radius:999px;font-size:.8rem}
    .chip button{background:none;border:none;color:var(--muted);cursor:pointer}
  </style>
</head>
<body>
  <div class="stars"></div><div class="twinkle"></div>

  <div class="wrap">
    <header>
      <div class="brand"><div class="logo"></div><span>GoldenSpaceAI</span></div>
      <span class="badge">Advanced Assistant</span>
      <select id="modelSel" class="model" title="Model">
        <option value="gpt-5">gpt-5</option>
        <option value="gpt-5-nano">gpt-5-nano</option>
        <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
        <option value="gpt-4">gpt-4</option>
      </select>
      <div style="flex:1"></div>
    </header>

    <main id="chat">
      <div class="msg ai">
        <small>GoldenSpaceAI</small>
        Welcome to your golden, galaxy-powered assistant. Attach a document with the <strong>Ôºã</strong> button, type your request in the middle box, then press <strong>Send</strong>. Use the mic to speak if you like.
      </div>
    </main>

    <div class="composer-wrap">
      <div class="composer">
        <button id="plusBtn" class="btn plus" title="Attach file"></button>
        <textarea id="prompt" placeholder="Type your message‚Ä¶ (Shift+Enter for newline)"></textarea>
        <button id="micBtn" class="btn mic" title="Talk"></button>
        <button id="sendBtn" class="btn send" title="Send"></button>
      </div>
    </div>
    <div class="attachments" id="attachments" style="width:min(980px,92%);margin:6px auto 0"></div>
  </div>

  <!-- Hidden file input -->
  <input id="fileInput" class="hidden" type="file"
         accept=".txt,.md,.json,.csv,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,image/*"/>

  <script>
    const BACKEND_URL = "/chat-advanced-ai";

    const chat = document.getElementById("chat");
    const plusBtn = document.getElementById("plusBtn");
    const fileInput = document.getElementById("fileInput");
    const micBtn = document.getElementById("micBtn");
    const sendBtn = document.getElementById("sendBtn");
    const promptEl = document.getElementById("prompt");
    const modelSel = document.getElementById("modelSel");
    const atts = document.getElementById("attachments");

    let currentFile = null;

    function el(tag, attrs={}, ...children){
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==="class") n.className=v;
        else if(k==="html") n.innerHTML=v;
        else n.setAttribute(k,v);
      });
      children.forEach(c=> n.append(c instanceof Node? c : document.createTextNode(c)));
      return n;
    }
    function addMsg(role, text){
      const m = el("div",{class:`msg ${role}`});
      m.append(el("small",{}, role==="user"?"You":"GoldenSpaceAI"));
      m.append(el("div",{html:String(text||"").replace(/\n/g,"<br/>")}));
      chat.append(m); chat.scrollTop = chat.scrollHeight; return m;
    }
    function addSpinner(){
      const row = el("div",{class:"msg ai"});
      row.append(el("small",{},"GoldenSpaceAI"));
      const s = el("div",{class:"spinner"});
      row.append(s);
      chat.append(row); chat.scrollTop = chat.scrollHeight; return row;
    }

    // attachments UI
    function renderAttachment(){
      atts.innerHTML = "";
      if(!currentFile) return;
      const chip = el("span",{class:"chip"},
        `${currentFile.name} ¬∑ ${(currentFile.size/1024/1024).toFixed(2)} MB `
      );
      const x = el("button",{},"‚úï");
      x.onclick = ()=>{ currentFile=null; renderAttachment(); };
      chip.append(x); atts.append(chip);
    }

    plusBtn.onclick = ()=> fileInput.click();
    fileInput.onchange = ()=>{ currentFile = fileInput.files?.[0] || null; fileInput.value=""; renderAttachment(); };

    // send flow
    async function send(){ 
      const text = promptEl.value.trim();
      if(!text && !currentFile){ addMsg("ai","‚ö†Ô∏è Add a message or attach a file."); return; }

      addMsg("user", text || (currentFile? `(sent file: ${currentFile.name})` : ""));
      promptEl.value = "";
      const spin = addSpinner();

      try{
        const form = new FormData();
        form.append("q", text);
        form.append("model", modelSel.value);
        if(currentFile) form.append("file", currentFile);

        const res = await fetch(BACKEND_URL, { method:"POST", body: form, credentials:"include" });

        let dataText = await res.text(); // robust: read as text first
        let data;
        try { data = JSON.parse(dataText); } catch { data = { error: dataText || "Invalid JSON" }; }

        const ok = res.ok && !data.error;
        const reply = data.reply || data.answer || (!ok ? `Error ${res.status}: ${data.error||"Unknown error"}` : "[No reply]");

        spin.remove();
        addMsg("ai", reply);
      }catch(err){
        spin.remove();
        addMsg("ai", "‚ö†Ô∏è " + err.message);
      }finally{
        currentFile = null; renderAttachment();
      }
    }

    sendBtn.onclick = send;
    promptEl.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }
    });

    // simple mic (speech to text) ‚Äì optional
    let rec=null, listening=false;
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SR){
      rec = new SR(); rec.lang="en-US"; rec.interimResults=false; rec.continuous=false;
      rec.onstart = ()=>{ listening=true; };
      rec.onend = ()=>{ listening=false; };
      rec.onresult = (ev)=>{ const t = ev.results?.[0]?.[0]?.transcript || ""; promptEl.value = (promptEl.value+" "+t).trim(); };
      micBtn.onclick = ()=> listening ? rec.stop() : rec.start();
    } else {
      micBtn.onclick = ()=> addMsg("ai","‚ö†Ô∏è Microphone not supported in this browser.");
    }
  </script>
</body>
</html>
