<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GoldenSpaceAI ‚Äî Advanced AI</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    :root{--bg:#050814;--ink:#eaf1ff;--muted:#9fb2d7;--accent:#7aa2ff;--gold:#ffd24f}
    html,body{height:100%}
    body{
      background:
        radial-gradient(1200px 800px at 80% -10%, #161f44 0%, #0c122a 50%, #050814 100%),
        linear-gradient(160deg, rgba(255,255,255,.03), rgba(255,255,255,.0));
      color:var(--ink); font-family: ui-sans-serif, system-ui, Inter, "Segoe UI", Arial;
    }
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
           border:1px solid rgba(255,255,255,.08); backdrop-filter: blur(8px)}
    .badge{font-size:.72rem;color:var(--muted);border:1px dashed rgba(255,255,255,.12);
           padding:.25rem .5rem;border-radius:9999px}

    /* Circular voice/camera button with pulse */
    .vc-btn{
      width:86px;height:86px;border-radius:9999px;display:grid;place-items:center;position:relative;
      background:#0f1a3a;border:1px solid rgba(255,255,255,.15);cursor:pointer;
      transition:transform .08s ease, box-shadow .25s ease, background .25s, border-color .25s;
    }
    .vc-btn:hover{transform:translateY(-1px);box-shadow:0 12px 32px rgba(0,0,0,.35)}
    .vc-btn .pulse,.vc-btn .pulse:before,.vc-btn .pulse:after{
      content:"";position:absolute;inset:-4px;border-radius:inherit;border:2px solid rgba(122,162,255,.35);
      animation:pulse 2.2s linear infinite}
    .vc-btn .pulse:before{animation-delay:.5s} .vc-btn .pulse:after{animation-delay:1s}
    @keyframes pulse{0%{transform:scale(1);opacity:.9}70%{opacity:.05}100%{transform:scale(1.5);opacity:0}}
    .vc-btn.active{
      background:linear-gradient(0deg, rgba(122,162,255,.24), rgba(122,162,255,.08));
      border-color:rgba(122,162,255,.7); box-shadow:0 0 0 2px rgba(122,162,255,.35)
    }
    .icon{
      width:34px;height:34px;border-radius:10px;display:grid;place-items:center;
      background:linear-gradient(180deg,#a7bfff,#7aa2ff); color:#0c142a; font-weight:900; font-size:20px
    }

    .msg{max-width:80ch;white-space:pre-wrap}
    .msg.ai{background:rgba(255,255,255,.035);border:1px solid rgba(255,255,255,.08)}
    .msg.you{background:rgba(255,210,79,.08);border:1px solid rgba(255,210,79,.25)}
    .thinking{opacity:.75;font-style:italic}

    .video-thumb{width:240px;height:136px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.12)}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="px-5 md:px-10 py-4 flex items-center justify-between">
    <div class="text-lg font-bold">GoldenSpaceAI ‚Äî Advanced AI</div>
    <div class="flex items-center gap-3">
      <span id="planBadge" class="badge">Plan: ‚Ä¶</span>
      <a class="px-3 py-2 rounded-lg border border-white border-opacity-10 bg-white bg-opacity-5 hover:bg-opacity-10" href="/plans.html">Upgrade</a>
      <button id="logoutBtn" class="px-3 py-2 rounded-lg border border-white border-opacity-10 bg-white bg-opacity-5 hover:bg-opacity-10">Log out</button>
    </div>
  </header>

  <main class="px-5 md:px-10 pb-28">
    <div class="grid lg:grid-cols-3 gap-6 items-start">

      <!-- Left: Chat with Gemini (/ask) -->
      <section class="lg:col-span-2 glass rounded-2xl p-5 md:p-6">
        <div class="flex items-center justify-between gap-4">
          <h2 class="text-xl font-semibold">Chat</h2>
          <!-- Voice/Camera master toggle -->
          <div class="flex items-center gap-3">
            <button id="vcBtn" class="vc-btn" title="Toggle Voice Replies & Enable Mic/Camera">
              <span class="pulse" aria-hidden="true"></span>
              <span class="icon">üé§</span>
            </button>
            <div class="text-sm text-gray-300">
              <div class="font-semibold">Voice & Camera</div>
              <div id="vcHint" class="opacity-70">Off ¬∑ Replies are silent</div>
            </div>
          </div>
        </div>

        <div id="feed" class="space-y-4 mt-4">
          <div class="msg ai rounded-2xl p-4">
            <div class="text-sm text-gray-300 mb-1">GoldenSpaceAI</div>
            <div>Welcome! Type your question below. Turn on the circular button to speak and get spoken replies.</div>
          </div>
        </div>

        <!-- Compose -->
        <div class="mt-4 grid md:grid-cols-[1fr_auto] gap-3 items-center">
          <input id="input" class="flex-1 w-full bg-transparent border border-white border-opacity-10 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Type your message‚Ä¶" />
          <button id="sendBtn" class="px-4 py-3 rounded-xl border border-white border-opacity-10 bg-white bg-opacity-5 hover:bg-opacity-10">Send</button>
        </div>
        <p class="text-sm text-gray-300 mt-3">Tip: If the circular button is <span class="text-blue-300">ON</span>, I‚Äôll speak my replies. If it‚Äôs OFF, I‚Äôll stay quiet.</p>

        <!-- Camera preview (local only) -->
        <div id="videoWrap" class="hidden mt-5">
          <div class="text-xs text-gray-400">Camera preview (optional, stays on your device)</div>
          <div class="video-thumb mt-2">
            <video id="cam" autoplay playsinline muted></video>
          </div>
        </div>
      </section>

      <!-- Right: Search Info (/search-info) -->
      <aside class="glass rounded-2xl p-5 md:p-6 space-y-4">
        <h2 class="text-xl font-semibold">Search Info</h2>
        <p class="text-sm text-gray-300">Get a short overview + 3 bullet facts from Gemini.</p>
        <div class="flex gap-2 mt-2">
          <input id="searchInput" class="flex-1 bg-transparent border border-white border-opacity-10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Search topic‚Ä¶"/>
          <button id="searchBtn" class="px-3 py-2 rounded-xl border border-white border-opacity-10 bg-white bg-opacity-5 hover:bg-opacity-10">Search</button>
        </div>
        <div id="searchOut" class="mt-3 text-sm text-gray-100 whitespace-pre-wrap"></div>

        <hr class="border-white border-opacity-10 my-4">
        <!-- If you keep a separate page/file for search information, link to it here -->
        <a href="/search-information.html" class="underline text-blue-300 text-sm">Open full Search Information page</a>
      </aside>

    </div>
  </main>

  <footer class="fixed bottom-0 left-0 right-0 py-3 px-5 md:px-10">
    <div class="glass rounded-2xl px-4 py-3 flex items-center justify-between text-xs text-gray-300">
      <div>¬©Ô∏è GoldenSpaceAI ¬∑ <a class="underline" href="/privacy.html">Privacy</a> ¬∑ <a class="underline" href="/terms.html">Terms</a></div>
      <div id="usage" class="opacity-80"></div>
    </div>
  </footer>

  <script>
    const $ = s => document.querySelector(s);
    const feed = $('#feed'), input = $('#input'), sendBtn = $('#sendBtn');
    const vcBtn = $('#vcBtn'), vcHint = $('#vcHint');
    const videoWrap = $('#videoWrap'), camEl = $('#cam');
    const usage = $('#usage'), planBadge = $('#planBadge');
    const logoutBtn = $('#logoutBtn');
    const searchInput = $('#searchInput'), searchBtn = $('#searchBtn'), searchOut = $('#searchOut');

    let voiceMode = false;      // <‚Äî When true, speak replies
    let micStream = null;
    let camStream = null;

    const addMsg = (who, text, extra='')=>{
      const el = document.createElement('div');
      el.className = 'msg ' + (who==='you'?'you':'ai') + ' rounded-2xl p-4 ' + extra;
      el.innerHTML = \`<div class="text-sm text-gray-300 mb-1">\${who==='you'?'You':'GoldenSpaceAI'}</div>\` +
                     '<div>' + (text||'').replace(/</g,'&lt;') + '</div>';
      feed.appendChild(el); el.scrollIntoView({behavior:'smooth',block:'end'});
      return el;
    };

    async function refreshMe(){
      try{
        const r = await fetch('/api/me'); const j = await r.json();
        planBadge.textContent = 'Plan: ' + j.plan?.toUpperCase();
        const ask = j.remaining?.ask ?? '‚àû', se = j.remaining?.search ?? '‚àû', ph = j.remaining?.physics ?? '‚àû';
        usage.textContent = \`Ask \${ask} ‚Ä¢ Search \${se} ‚Ä¢ Physics \${ph}\`;
      }catch{}
    }
    refreshMe();

    logoutBtn.onclick = async ()=>{ await fetch('/logout',{method:'POST'}); location.href='/login.html'; };

    // ---------- Chat: /ask ----------
    async function askGemini(q){
      const thinking = addMsg('ai','Thinking‚Ä¶','thinking');
      try{
        const res = await fetch('/ask',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ question: q })
        });
        const data = await res.json();
        const answer = data.answer || 'No response.';
        thinking.remove();
        addMsg('ai', answer);
        if(voiceMode) speak(answer);
        refreshMe();
      }catch(e){
        thinking.remove();
        addMsg('ai','Error contacting AI.');
      }
    }

    sendBtn.onclick = ()=>{
      const q = input.value.trim();
      if(!q) return;
      addMsg('you', q);
      input.value='';
      askGemini(q);
    };
    input.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        const q = input.value.trim(); if(!q) return;
        addMsg('you', q); input.value=''; askGemini(q);
      }
    });

    // ---------- Search Info: /search-info ----------
    async function doSearch(topic){
      searchOut.textContent = 'Searching‚Ä¶';
      try{
        const res = await fetch('/search-info',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ query: topic })
        });
        const data = await res.json();
        searchOut.textContent = data.answer || 'No info found.';
        refreshMe();
      }catch(e){
        searchOut.textContent = 'Error performing search.';
      }
    }
    searchBtn.onclick = ()=>{
      const t = searchInput.value.trim(); if(!t) return;
      doSearch(t);
    };
    searchInput.addEventListener('keydown', e=>{
      if(e.key==='Enter'){ const t=searchInput.value.trim(); if(t) doSearch(t); }
    });

    // ---------- Voice replies & Camera toggle ----------
    function speak(text){
      try{
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        const v = speechSynthesis.getVoices().find(v=>/en/i.test(v.lang));
        if(v) u.voice = v;
        speechSynthesis.speak(u);
      }catch{}
    }

    async function enableMic(){
      if(micStream) return true;
      try{
        micStream = await navigator.mediaDevices.getUserMedia({audio:true});
        return true;
      }catch{ return false; }
    }

    async function enableCam(){
      if(camStream){ camEl.srcObject = camStream; return true; }
      try{
        camStream = await navigator.mediaDevices.getUserMedia({video:true});
        camEl.srcObject = camStream;
        return true;
      }catch{ return false; }
    }

    vcBtn.onclick = async ()=>{
      if(!voiceMode){
        // Turning ON: ask for mic + camera
        const micOK = await enableMic();
        const camOK = await enableCam();
        if(camOK) videoWrap.classList.remove('hidden');
        vcBtn.classList.add('active');
        voiceMode = true;
        vcHint.textContent = 'On ¬∑ I will speak replies';
        if(!micOK) vcHint.textContent += ' (Mic blocked)';
      }else{
        // Turning OFF: stop camera (keep mic permission optional)
        if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream = null; }
        camEl.srcObject = null; videoWrap.classList.add('hidden');
        vcBtn.classList.remove('active');
        voiceMode = false;
        vcHint.textContent = 'Off ¬∑ Replies are silent';
      }
    };
  </script>
</body>
</html>
