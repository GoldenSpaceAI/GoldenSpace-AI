<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GoldenSpaceAI ¬∑ Advanced Assistant</title>
  <style>
    :root{
      --gold-1:#ffd700; --gold-2:#e6c200; --gold-3:#b89700;
      --text:#faf7e8; --muted:#c8b88a; --glass: rgba(255,255,255,.08); --ring: rgba(255,215,0,.35);
      --bg-color: #05060a;
      --wallpaper: radial-gradient(1200px 800px at 75% -20%, rgba(255,215,0,.18), transparent 40%),
                   radial-gradient(800px 600px at 10% 120%, rgba(255,215,0,.08), transparent 45%), #05060a;
      --stars-opacity: .28;
      --header-shadow: rgba(0,0,0,.2);
      --bubble-ai: rgba(12,12,16,.55);
      --bubble-user: linear-gradient(180deg,rgba(255,215,0,.12),rgba(255,215,0,.08));
      --border-weak: rgba(255,255,255,.06);
      --border-mid: rgba(255,255,255,.15);
    }
    .theme-dark{
      --text:#f3f6ff; --muted:#b7c0d9; --bg-color:#03040a;
      --wallpaper: url('https://images.unsplash.com/photo-1444703686981-a3abbc4d4fe3?q=80&w=1600&auto=format&fit=crop') center/cover no-repeat, #03040a;
      --stars-opacity: .45;
      --header-shadow: rgba(0,0,0,.35);
      --bubble-ai: rgba(12,12,20,.65);
      --bubble-user: linear-gradient(180deg,rgba(255,215,0,.12),rgba(255,215,0,.08));
      --border-weak: rgba(255,255,255,.08);
      --border-mid: rgba(255,255,255,.18);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text); background: var(--wallpaper); background-attachment:fixed; overflow:hidden;}
    .stars,.twinkle{position:fixed; inset:0; z-index:-2; pointer-events:none}
    .stars{opacity:var(--stars-opacity)}
    .twinkle{
      background-image: radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.45), transparent 55%),
                        radial-gradient(1.5px 1.5px at 70% 60%, rgba(255,255,255,.35), transparent 55%),
                        radial-gradient(1.2px 1.2px at 40% 80%, rgba(255,255,255,.4), transparent 55%),
                        radial-gradient(1px 1px at 85% 15%, rgba(255,255,255,.5), transparent 55%);
      animation: twinkle 8s linear infinite; opacity:.35
    }
    @keyframes twinkle{0%{filter:brightness(1)}50%{filter:brightness(1.25)}100%{filter:brightness(1)}}
    .wrap{display:grid; grid-template-rows:auto 1fr auto; height:100%}
    header{
      display:flex; align-items:center; gap:.9rem; padding:14px 18px; backdrop-filter:blur(8px);
      background:linear-gradient(180deg,rgba(10,10,14,.55),rgba(10,10,14,.25));
      border-bottom:1px solid var(--border-weak);
      box-shadow:0 2px 10px var(--header-shadow);
    }
    .brand{display:flex; align-items:center; gap:.7rem; font-weight:800}
    .logo{ width:32px;height:32px;border-radius:50%;
      background:conic-gradient(from 210deg,var(--gold-1),var(--gold-2),var(--gold-3),var(--gold-1));
      box-shadow:0 0 0 2px rgba(255,215,0,.25), 0 0 32px rgba(255,215,0,.25) inset;}
    .badge{font-size:.75rem;color:#1a1606;background:linear-gradient(180deg,var(--gold-1),var(--gold-2)); padding:4px 8px;border-radius:999px;box-shadow:0 2px 10px rgba(255,215,0,.25)}
    .spacer{margin-left:auto}
    .toggle{
      display:inline-flex; align-items:center; gap:.5rem; padding:6px 10px; border-radius:999px; border:1px solid var(--border-mid);
      background:rgba(255,255,255,.06); color:var(--text); cursor:pointer; font-weight:700;
    }
    .meta{font-size:.8rem; opacity:.85; border:1px solid var(--border-mid); padding:4px 8px; border-radius:8px}
    .golden-access-btn{ background: linear-gradient(45deg, #ffd700, #ffed4e)!important;color:#1a1300!important;border:1px solid rgba(255,215,0,.5)!important;font-weight:800!important}
    .golden-access-btn:hover{background:linear-gradient(45deg,#ffed4e,#ffd700)!important;transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,215,0,.3)!important}
    main#chat{position:relative;height:100%;overflow:auto;padding:18px 18px 170px;scroll-behavior:smooth}
    .msg{max-width:min(780px,92%);padding:14px 16px;border-radius:16px;margin:10px 0;line-height:1.55;
         box-shadow:0 2px 18px rgba(0,0,0,.2);border:1px solid var(--border-weak);backdrop-filter:blur(6px)}
    .msg.user{margin-left:auto;background:var(--bubble-user);border-color:rgba(255,215,0,.25)}
    .msg.ai{background:var(--bubble-ai)}
    .msg small{display:block;opacity:.7;font-size:.75rem;margin-bottom:6px}
    .msg .tools{margin-top:8px; display:flex; gap:8px; flex-wrap:wrap}
    .tool-link{display:inline-flex;align-items:center;gap:.5rem;padding:6px 10px;border-radius:10px;border:1px solid var(--border-mid);background:rgba(255,255,255,.06);cursor:pointer;text-decoration:none;color:var(--text);font-weight:700}
    .tool-link:hover{background:rgba(255,255,255,.12)}
    .img-wrap{margin-top:8px}
    .img-wrap img{max-width:100%;border-radius:12px;border:1px solid var(--border-weak)}
    .spinner{width:20px;height:20px;border-radius:50%;border:2px solid rgba(255,255,255,.2);border-top-color:var(--gold-1);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .composer-wrap{position:fixed;left:0;right:0;bottom:18px;display:flex;justify-content:center;pointer-events:none}
    .composer{ pointer-events:auto;width:min(980px,92%);display:flex;align-items:center;gap:10px;padding:10px;
      border-radius:18px;background:var(--glass);backdrop-filter:blur(10px);
      border:1px solid var(--border-weak); box-shadow:0 10px 30px rgba(0,0,0,.35), 0 0 0 1px var(--ring)}
    .btn{border:none;outline:none;cursor:pointer;height:56px;width:56px;border-radius:999px; background:rgba(255,255,255,.06);display:grid;place-items:center;transition:.2s transform,.2s background}
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.12)}
    .btn.plus::before{content:"+";font-size:28px;color:var(--gold-1);font-weight:700}
    .btn.send::before{content:"‚û§";font-size:20px;color:#141209;font-weight:800}
    .btn.send{background:linear-gradient(180deg,var(--gold-1),var(--gold-2)); box-shadow:0 8px 18px rgba(255,215,0,.25)}
    .mic{ position:relative;background:linear-gradient(180deg,var(--gold-1),var(--gold-2)); box-shadow:0 8px 18px rgba(255,215,0,.25)}
    .mic::before{content:"üé§";font-size:22px;color:#141209;font-weight:700}
    textarea#prompt{ flex:1; resize:none; min-height:56px; max-height:140px; padding:12px 14px; border-radius:12px; background:rgba(255,255,255,.06);
      color:var(--text); border:1px solid var(--border-mid); outline:none; font-size:15px; line-height:1.4;}
    textarea#prompt::placeholder{ color: rgba(255,255,255,.55) }
    .menu{position:absolute;bottom:70px;left:18px;background:#0e1118;border:1px solid var(--border-mid);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;flex-direction:column;z-index:20; min-width:240px}
    .menu button{background:none;border:none;color:var(--text);padding:12px 14px;text-align:left;cursor:pointer; font-weight:700}
    .menu button:hover{background:rgba(255,255,255,.08)}
    .menu .sep{height:1px;background:var(--border-mid); margin:4px 0}
    /* 20G Lock (unchanged) */
    .golden-lock-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);display:none;justify-content:center;align-items:center;z-index:10000;backdrop-filter:blur(10px)}
    .golden-unlock-container{background:linear-gradient(135deg,#0c0c0c,#1a1a2e);padding:35px 30px;border-radius:20px;border:3px solid gold;max-width:450px;width:95%;text-align:center;color:white;box-shadow:0 20px 40px rgba(0,0,0,.5);animation:slideIn .3s ease-out}
    @keyframes slideIn{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
    .lock-header{margin-bottom:25px}.lock-icon{font-size:4em;margin-bottom:15px;animation:pulse 2s infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
    .lock-header h2{color:gold;margin:0;font-size:1.8em;text-shadow:0 0 10px rgba(255,215,0,.5)}
    .feature-description{color:#ccc;margin-bottom:25px;font-size:1.2em;line-height:1.4}
    .pricing-section{margin-bottom:25px;background:rgba(255,215,0,.1);padding:20px;border-radius:15px;border:2px solid rgba(255,215,0,.3)}
    .price-main{font-size:3.5em;color:gold;font-weight:bold;text-shadow:0 0 15px rgba(255,215,0,.7)}
    .price-period{color:#ffed4e;font-size:1.1em;font-weight:bold}
    .balance-section{background:rgba(255,255,255,.05);padding:15px;border-radius:10px;margin-bottom:25px;border:1px solid rgba(255,215,0,.2)}
    .balance-label{color:#aaa;font-size:.95em;margin-bottom:8px}.balance-amount{color:gold;font-size:1.8em;font-weight:bold}
    .features-included{text-align:left;margin-bottom:30px;background:rgba(255,255,255,.03);padding:20px;border-radius:10px}
    .features-included h3{color:gold;margin-bottom:15px;text-align:center;font-size:1.3em}
    .feature-item{padding:8px 0;color:#ddd;font-size:1em}
    .subscribe-btn{background:linear-gradient(45deg,#ffd700,#ffed4e);color:black;border:none;padding:18px 30px;font-size:1.2em;font-weight:bold;border-radius:12px;cursor:pointer;width:100%;margin-bottom:20px;transition:.3s;text-transform:uppercase;letter-spacing:1px}
    .subscribe-btn:hover{transform:translateY(-3px);box-shadow:0 10px 25px rgba(255,215,0,.5);background:linear-gradient(45deg,#ffed4e,#ffd700)}
    .subscribe-btn:disabled{background:#666;cursor:not-allowed;transform:none;box-shadow:none}
    .action-links{display:flex;justify-content:space-between;gap:15px}
    .buy-link,.home-link{color:gold;text-decoration:none;padding:12px 20px;border:2px solid gold;border-radius:8px;transition:.3s;flex:1;text-align:center;font-weight:bold;background:rgba(255,215,0,.1)}
    .buy-link:hover,.home-link:hover{background:rgba(255,215,0,.2);transform:translateY(-2px)}
    .status-message{padding:15px;border-radius:8px;margin:15px 0;text-align:center;font-weight:bold;font-size:1em}
    .status-message.success{background:rgba(0,255,0,.15);border:2px solid #0f0;color:#0f0}
    .status-message.error{background:rgba(255,0,0,.15);border:2px solid #f44;color:#f44}
    .status-message.processing{background:rgba(255,215,0,.15);border:2px solid gold;color:gold}
  </style>
</head>
<body>
  <!-- 20G LOCK (unchanged content) -->
  <div id="goldenLockOverlay20G" class="golden-lock-overlay">
    <div class="golden-unlock-container">
      <div class="lock-header">
        <div class="lock-icon">üîí</div>
        <h2 id="lockFeatureTitle">Advanced AI Chat Locked</h2>
      </div>
      <div class="feature-description" id="lockFeatureDescription">
        Access our most powerful AI assistant with advanced capabilities, voice recognition, and deep learning modes
      </div>
      <div class="pricing-section">
        <div class="price-main">8</div>
        <div class="price-period">per month</div>
      </div>
      <div class="balance-section">
        <div class="balance-label">Your Golden Balance:</div>
        <div class="balance-amount" id="currentUserBalance20G">0G</div>
      </div>
      <div class="features-included">
        <h3>What you get:</h3>
        <div class="feature-item">‚úÖ Advanced AI Chat</div>
        <div class="feature-item">‚úÖ Voice recognition & speech</div>
        <div class="feature-item">‚úÖ Deep Search & Study modes</div>
        <div class="feature-item">‚úÖ 30-day access</div>
        <div class="feature-item">‚úÖ Priority support</div>
      </div>
      <button class="subscribe-btn" onclick="unlockUniversal20G()">UNLOCK FOR 20G/MONTH</button>
      <div id="unlockStatus8G" class="status-message"></div>
      <div class="action-links">
        <a href="/buy-golden.html" class="buy-link">üí∞ Buy More Golden</a>
        <button class="/index.html" onclick="closeUniversalLock()">‚ùå Cancel</button>
      </div>
    </div>
  </div>

  <div class="stars"></div>
  <div class="twinkle"></div>

  <div class="wrap">
    <header>
      <div class="brand"><div class="logo"></div><span>GoldenSpaceAI</span></div>
      <span class="badge">Advanced Assistant</span>
      <div class="spacer"></div>
      <span id="modeMeta" class="meta">Mode: Deep ‚Ä¢ Model: gpt-4o</span>
      <button class="toggle golden-access-btn" onclick="showUniversalLockForAdvancedAI()" title="Access Advanced AI">üí∞ 20G Access</button>
      <button id="themeToggle" class="toggle" type="button" title="Toggle theme">üåû Light</button>
    </header>

    <main id="chat">
      <div class="msg ai">
        <small>GoldenSpaceAI</small>
        Choose a mode from the Ôºã button: <strong>Deep Search</strong>, <strong>Study & Learn</strong> or <strong>Deep Think</strong>.  
        Use üìé to attach files/images, or üé® to generate images.
      </div>
    </main>

    <div class="composer-wrap">
      <div class="composer">
        <button id="plusBtn" type="button" class="btn plus" title="Menu"></button>
        <input id="fileInput" type="file" style="display:none" />
        <button id="attachBtn" class="btn" title="Attach file/image">üìé</button>
        <div style="flex:1">
          <textarea id="prompt" placeholder="Type your message‚Ä¶ (Shift+Enter for newline)"></textarea>
        </div>
        <button id="genImgBtn" class="btn" title="Generate image">üé®</button>
        <button id="micBtn" type="button" class="btn mic" title="Voice mode"></button>
        <button id="sendBtn" type="button" class="btn send" title="Send"></button>
      </div>

      <!-- Menu -->
      <div id="menu" class="menu">
        <button data-mode="deep" data-model="gpt-4o">üîé Deep Search (gpt-4o)</button>
        <button data-mode="study" data-model="gpt-4o">üìö Study & Learn (gpt-4o)</button>
        <button data-mode="deepthink" data-model="gpt-5-mini">üß† Deep Think (gpt-5-mini)</button>
        <div class="sep"></div>
        <button id="menuGen">üé® Generate Image</button>
        <button id="menuUpload">üìé Upload File / Image</button>
        <div class="sep"></div>
        <button id="menuMic">üé§ Mic</button>
        <div class="sep"></div>
        <button id="menuCI">‚öôÔ∏è Custom Instructions</button>
      </div>
    </div>
  </div>

<script>
/* ---------------- 20G LOCK (unchanged logic) ---------------- */
let current20GFeature = ''; let current20GCallback = null;
function show20GLock(featureName, featureTitle, featureDescription, unlockCallback){
  current20GFeature=featureName; current20GCallback=unlockCallback;
  document.getElementById('lockFeatureTitle').textContent=featureTitle;
  document.getElementById('lockFeatureDescription').textContent=featureDescription;
  update20GBalance(); document.getElementById('goldenLockOverlay20G').style.display='flex';
}
function closeUniversalLock(){ document.getElementById('goldenLockOverlay20G').style.display='none'; resetUniversalLock(); }
function resetUniversalLock(){ current20GFeature=''; current20GCallback=null; const s=document.getElementById('unlockStatus20G'); s.style.display='none'; s.className='status-message'; }
async function unlockUniversal20G(){
  const btn=document.querySelector('#goldenLockOverlay20G .subscribe-btn'); const s=document.getElementById('unlockStatus20G');
  try{
    btn.disabled=true; btn.textContent='PROCESSING...'; s.innerHTML='‚è≥ Processing...'; s.className='status-message processing'; s.style.display='block';
    const bal=await fetch('/api/golden-balance').then(r=>r.json());
    if(!bal.loggedIn){ s.innerHTML='‚ùå Please log in'; s.className='status-message error'; btn.disabled=false; btn.textContent='UNLOCK FOR 20G/MONTH'; return; }
    if(bal.balance<20){ s.innerHTML='‚ùå Insufficient balance (need 20G)'; s.className='status-message error'; btn.disabled=false; btn.textContent='UNLOCK FOR 20G/MONTH'; return;}
    const unlock=await fetch('/api/unlock-feature',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({feature:'premium_monthly',cost:20})}).then(r=>r.json());
    if(unlock.success){
      s.innerHTML='‚úÖ Advanced AI Chat unlocked for 30 days.'; s.className='status-message success';
      document.getElementById('currentUserBalance20G').textContent=unlock.newBalance+'G';
      setTimeout(()=>{ closeUniversalLock(); if(current20GCallback) current20GCallback(); },1200);
    }else{
      s.innerHTML='‚ùå '+(unlock.error||'Failed to unlock'); s.className='status-message error'; btn.disabled=false; btn.textContent='UNLOCK FOR 20G/MONTH';
    }
  }catch(e){ s.innerHTML='‚ùå Network error'; s.className='status-message error'; btn.disabled=false; btn.textContent='UNLOCK FOR 20G/MONTH'; }
}
function update20GBalance(){ fetch('/api/golden-balance').then(r=>r.json()).then(d=>{ if(d.loggedIn){ document.getElementById('currentUserBalance20G').textContent=d.balance+'G'; } }); }
document.getElementById('goldenLockOverlay20G').addEventListener('click',e=>{ if(e.target===e.currentTarget) closeUniversalLock(); });

document.addEventListener('DOMContentLoaded', checkAdvancedAIAccess);
async function checkAdvancedAIAccess(){
  try{
    const d=await fetch('/api/feature-status?feature=premium_monthly',{credentials:'include'}).then(r=>r.json());
    if(d.unlocked){ enableAdvancedAIChat(); } else { showUniversalLockForAdvancedAI(); }
  }catch{ showUniversalLockForAdvancedAI(); }
}
function showUniversalLockForAdvancedAI(){
  show20GLock('premium_monthly','Advanced AI Chat Locked','Access our most powerful AI assistant with advanced capabilities, voice recognition, and deep learning modes',enableAdvancedAIChat);
}
function enableAdvancedAIChat(){ console.log('Advanced AI Chat enabled'); }

/* ---------------- UI elements ---------------- */
const BACKEND_URL="/chat-advanced-ai"; const TRANSCRIBE_URL="/api/transcribe";
const chat=document.getElementById("chat");
const plusBtn=document.getElementById("plusBtn");
const micBtn=document.getElementById("micBtn");
const menuMicBtn=document.getElementById("menuMic");
const promptEl=document.getElementById("prompt");
const sendBtn=document.getElementById("sendBtn");
const menu=document.getElementById("menu");
const themeToggle=document.getElementById("themeToggle");
const attachBtn=document.getElementById("attachBtn");
const fileInput=document.getElementById("fileInput");
const genImgBtn=document.getElementById("genImgBtn");
const menuGen=document.getElementById("menuGen");
const menuUpload=document.getElementById("menuUpload");
const modeMeta=document.getElementById("modeMeta");

/* State */
let currentMode="deep";       // deep | study | deepthink
let currentModel="gpt-4o";    // switches to gpt-5-mini for Deep Think
let customInstructions="";    // user-set system prompt
let history=[];               // last 6 messages (user/assistant)

/* Theme */
const savedTheme=localStorage.getItem("gsai:theme")||"light"; applyTheme(savedTheme);
themeToggle.addEventListener("click", ()=>{ const next=document.body.classList.contains("theme-dark")?"light":"dark"; applyTheme(next); });
function applyTheme(mode){
  if(mode==="dark"){ document.body.classList.add("theme-dark"); themeToggle.textContent="üåô Dark"; localStorage.setItem("gsai:theme","dark"); }
  else{ document.body.classList.remove("theme-dark"); themeToggle.textContent="üåû Light"; localStorage.setItem("gsai:theme","light"); }
}

/* Helpers */
function el(tag, attrs={}, ...children){
  const n=document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{ if(k==="class") n.className=v; else if(k==="html") n.innerHTML=v; else n.setAttribute(k,v); });
  children.forEach(c=> n.append(c instanceof Node? c : document.createTextNode(c)));
  return n;
}
function addMsg(role, html){
  const m=el("div",{class:`msg ${role}`});
  m.append(el("small",{}, role==="user"?"You":"GoldenSpaceAI"));
  const body=el("div",{html:(html||"").toString()});
  m.append(body);

  if(role==="ai"){
    const tools=el("div",{class:"tools"});
    const speakBtn=el("button",{class:"tool-link",type:"button"},"üîä Read Aloud");
    let speaking=false, utter=null;
    speakBtn.addEventListener("click", ()=>{
      if(!speaking && window.speechSynthesis){
        utter=new SpeechSynthesisUtterance(body.textContent); utter.lang="en-US";
        utter.onend=()=>{ speaking=false; speakBtn.textContent="üîä Read Aloud"; };
        window.speechSynthesis.cancel(); window.speechSynthesis.speak(utter);
        speaking=true; speakBtn.textContent="‚èπ Stop";
      }else{ if(window.speechSynthesis) window.speechSynthesis.cancel(); speaking=false; speakBtn.textContent="üîä Read Aloud"; }
    });
    tools.append(speakBtn);
    m.append(tools);
  }
  chat.append(m); chat.scrollTop=chat.scrollHeight; return m;
}
function addAIBlock(){ const row=el("div",{class:"msg ai"}); row.append(el("small",{},"GoldenSpaceAI")); row.append(el("div",{class:"spinner"})); chat.append(row); chat.scrollTop=chat.scrollHeight; return row; }
function md(text){ return (text||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br/>"); }
function updateMeta(){ modeMeta.textContent=`Mode: ${currentMode==='deepthink'?'Deep Think':' '+(currentMode==='deep'?'Deep':'Study')} ‚Ä¢ Model: ${currentModel}`; }

/* Menu */
plusBtn.addEventListener("click", ()=>{ menu.style.display=(menu.style.display==="flex"?"none":"flex"); menu.style.flexDirection="column"; });
menu.querySelectorAll("button[data-mode]").forEach(btn=>{
  btn.addEventListener("click",()=>{
    currentMode = btn.dataset.mode;
    currentModel = btn.dataset.model || "gpt-4o";
    updateMeta();
    addMsg("ai", `Mode set to <strong>${btn.textContent}</strong>.`);
    menu.style.display="none";
  });
});
menuMicBtn.addEventListener("click", ()=>{ menu.style.display="none"; startStopRecording(); });
menuGen.addEventListener("click", ()=>{ menu.style.display="none"; generateImage(); });
menuUpload.addEventListener("click", ()=>{ menu.style.display="none"; fileInput.click(); });

/* Attach */
attachBtn.addEventListener("click", ()=> fileInput.click());

/* Generate Image button */
genImgBtn.addEventListener("click", generateImage);

/* Build system per mode */
function buildSystem(){
  if(customInstructions) return customInstructions;
  if(currentMode==="deepthink") return "You are a professional deep-thinking assistant. Think step-by-step, reason carefully, then deliver a crisp final answer.";
  if(currentMode==="deep") return "You are an advanced assistant. Perform deep reasoning and deliver a structured, thorough answer.";
  if(currentMode==="study") return "You are a master teacher. Explain step-by-step with examples and a short practice checklist.";
  return "You are a helpful, professional assistant.";
}

/* Memory: keep last 6 messages (12 entries including assistant) */
function pushHistory(role, content){
  history.push({role, content});
  if(history.length>12) history = history.slice(-12);
}

/* Vision model auto-pick when file exists */
function pickModel(hasFile){
  // If user chose Deep Think explicitly, try gpt-5-mini; otherwise use gpt-4o.
  // If a file/image is attached, ensure a vision-capable model.
  if(hasFile){
    // force a vision-capable model (gpt-4o)
    return "gpt-4o";
  }
  return currentModel;
}

/* Send text */
async function send(fromMic=false){
  const text=(promptEl.value||"").trim();
  if(!text) return;
  addMsg("user", md(text));
  pushHistory("user", text);
  const block=addAIBlock();

  try{
    const hasFile = fileInput.files.length>0;
    const model = pickModel(hasFile);
    updateMeta();

    const fd=new FormData();
    fd.append("q", text);
    fd.append("model", model);
    fd.append("system", buildSystem());
    fd.append("history", JSON.stringify(history));
    if(hasFile){ fd.append("image", fileInput.files[0]); } // backend expects field name "image"

    const res=await fetch(BACKEND_URL,{ method:"POST", body:fd, credentials:"include" });
    if(!res.ok) throw new Error("Backend error: "+res.status);
    const data=await res.json();

    // Remove spinner and render
    chat.removeChild(block);

    const msgParts=[];
    if(data.reply||data.answer){ msgParts.push(md(data.reply||data.answer)); }

    // image responses (url or base64) ‚Äî render + download
    if(data.image_url || data.image_base64){
      const url = data.image_url ? data.image_url : (`data:image/png;base64,${data.image_base64}`);
      const wrapper = el("div",{class:"img-wrap"});
      const img = el("img",{src:url,alt:"Generated image"});
      const dl = el("a",{class:"tool-link",href:url,download:`goldenspaceai-${Date.now()}.png`},"‚¨áÔ∏è Download image");
      wrapper.append(img); wrapper.append(el("div",{class:"tools"},dl));
      const container = el("div",{html: msgParts.join("<br/>")});
      const bubble = el("div"); bubble.append(container); bubble.append(wrapper);
      const m=el("div",{class:"msg ai"}); m.append(el("small",{},"GoldenSpaceAI")); m.append(bubble); chat.append(m); chat.scrollTop=chat.scrollHeight;
      pushHistory("assistant","[image]");
    }else{
      addMsg("ai", msgParts.join("<br/>") || "[No reply]");
      pushHistory("assistant", (data.reply||data.answer||"").toString());
    }

  }catch(err){
    chat.removeChild(block);
    addMsg("ai","‚ö†Ô∏è "+md(err.message));
  }finally{
    promptEl.value="";
    // clear file only after sending (so user knows it was used)
    fileInput.value="";
  }
}

/* Generate Image flow (no prompt? use current text) */
async function generateImage(){
  const text=(promptEl.value||"").trim() || "Generate a simple golden-themed illustration.";
  addMsg("user", md("[Generate image] ") + md(text));
  pushHistory("user", "[Generate image] "+text);
  const block=addAIBlock();

  try{
    const fd=new FormData();
    fd.append("q", text);
    fd.append("model", "gpt-4o"); // route through vision-capable model; backend should switch to image-gen model internally
    fd.append("system", buildSystem());
    fd.append("history", JSON.stringify(history));
    fd.append("generate_image", "true");

    const res=await fetch(BACKEND_URL,{ method:"POST", body:fd, credentials:"include" });
    if(!res.ok) throw new Error("Backend error: "+res.status);
    const data=await res.json();

    chat.removeChild(block);

    if(data.image_url || data.image_base64){
      const url = data.image_url ? data.image_url : (`data:image/png;base64,${data.image_base64}`);
      const wrap = el("div",{class:"img-wrap"});
      const img = el("img",{src:url,alt:"Generated image"});
      const dl = el("a",{class:"tool-link",href:url,download:`goldenspaceai-${Date.now()}.png`},"‚¨áÔ∏è Download image");
      wrap.append(img); wrap.append(el("div",{class:"tools"},dl));
      const m=el("div",{class:"msg ai"}); m.append(el("small",{},"GoldenSpaceAI")); m.append(wrap); chat.append(m); chat.scrollTop=chat.scrollHeight;
      pushHistory("assistant","[image]");
    }else{
      addMsg("ai", md(data.reply||data.answer||"No image returned."));
      pushHistory("assistant", (data.reply||data.answer||"").toString());
    }
  }catch(err){
    chat.removeChild(block);
    addMsg("ai","‚ö†Ô∏è "+md(err.message));
  }finally{
    promptEl.value="";
  }
}

/* Mic (same as your existing concept) */
let mediaRecorder, audioChunks=[];
micBtn.addEventListener("click", startStopRecording);
menuMicBtn?.addEventListener("click", ()=>startStopRecording());
async function startStopRecording(){
  try{
    if(!mediaRecorder || mediaRecorder.state==="inactive"){
      const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      mediaRecorder=new MediaRecorder(stream,{mimeType:"audio/webm"}); audioChunks=[];
      mediaRecorder.ondataavailable=e=>{ if(e.data.size) audioChunks.push(e.data); };
      mediaRecorder.onstop=async ()=>{
        const blob=new Blob(audioChunks,{type:"audio/webm"});
        const fd=new FormData(); fd.append("audio", blob, "speech.webm");
        const r=await fetch(TRANSCRIBE_URL,{method:"POST",body:fd,credentials:"include"}).then(r=>r.json());
        if(r?.text){ promptEl.value = (promptEl.value?promptEl.value+" ":"")+r.text.trim(); send(true); }
      };
      mediaRecorder.start(); micBtn.title="Recording‚Ä¶ click to stop"; micBtn.style.filter="brightness(1.15)";
    }else{
      mediaRecorder.stop(); micBtn.title="Voice mode"; micBtn.style.filter="";
    }
  }catch(err){ alert("Microphone error: "+err.message); }
}

/* Custom Instructions quick prompt */
document.getElementById("menuCI").addEventListener("click", ()=>{
  const ci = prompt("Enter custom instructions for the AI (system message). Leave empty to reset:", customInstructions || "");
  if(ci!==null){ customInstructions = ci.trim(); addMsg("ai", customInstructions? "‚úÖ Custom instructions set." : "‚Ü©Ô∏è Custom instructions cleared."); }
  menu.style.display="none";
});

/* Theme meta + send handlers */
updateMeta();
sendBtn.addEventListener("click", ()=>send(false));
promptEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(false); } });

/* Lock helpers */
function showUniversalLockForAdvancedAI(){
  show20GLock('premium_monthly','Advanced AI Chat Locked','Access our most powerful AI assistant with advanced capabilities, voice recognition, deep think, image generation, and file understanding.', enableAdvancedAIChat);
}
</script>
</body>
</html>
