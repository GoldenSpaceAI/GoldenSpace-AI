<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GoldenSpaceAI · Advanced Assistant</title>
  <style>
    :root{ --gold-1:#ffd700; --gold-2:#e6c200; --gold-3:#b89700; --text:#faf7e8; --muted:#c8b88a; --glass: rgba(255,255,255,.08); --ring: rgba(255,215,0,.35); }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      background: radial-gradient(1200px 800px at 75% -20%, rgba(255,215,0,.18), transparent 40%),
                 radial-gradient(800px 600px at 10% 120%, rgba(255,215,0,.08), transparent 45%), #05060a;
      background-attachment:fixed; overflow:hidden;}
    .stars,.twinkle{position:fixed; inset:0; z-index:-2; pointer-events:none}
    .stars{background-image:url("https://images.unsplash.com/photo-1444703686981-a3abbc4d4fe3?q=80&w=1600&auto=format&fit=crop"); background-size:cover; filter:saturate(1.05) brightness(.9) contrast(1.1); opacity:.28;}
    .twinkle{background-image: radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.45), transparent 55%),
                                radial-gradient(1.5px 1.5px at 70% 60%, rgba(255,255,255,.35), transparent 55%),
                                radial-gradient(1.2px 1.2px at 40% 80%, rgba(255,255,255,.4), transparent 55%),
                                radial-gradient(1px 1px at 85% 15%, rgba(255,255,255,.5), transparent 55%);
             animation: twinkle 8s linear infinite; opacity:.45}
    @keyframes twinkle{0%{filter:brightness(1)}50%{filter:brightness(1.25)}100%{filter:brightness(1)}}
    .wrap{display:grid; grid-template-rows:auto 1fr auto; height:100%}
    header{ display:flex; align-items:center; gap:.9rem; padding:14px 18px; backdrop-filter:blur(8px);
      background:linear-gradient(180deg,rgba(10,10,14,.55),rgba(10,10,14,.25)); border-bottom:1px solid rgba(255,255,255,.06);}
    .brand{display:flex; align-items:center; gap:.7rem; font-weight:800}
    .logo{ width:32px;height:32px;border-radius:50%;
      background:conic-gradient(from 210deg,var(--gold-1),var(--gold-2),var(--gold-3),var(--gold-1));
      box-shadow:0 0 0 2px rgba(255,215,0,.25), 0 0 32px rgba(255,215,0,.25) inset;}
    .badge{font-size:.75rem;color:#1a1606;background:linear-gradient(180deg,var(--gold-1),var(--gold-2)); padding:4px 8px;border-radius:999px;box-shadow:0 2px 10px rgba(255,215,0,.25)}
    main#chat{position:relative;height:100%;overflow:auto;padding:18px 18px 160px;scroll-behavior:smooth}
    .msg{max-width:min(780px,92%);padding:14px 16px;border-radius:16px;margin:10px 0;line-height:1.55; box-shadow:0 2px 18px rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px)}
    .msg.user{margin-left:auto;background:linear-gradient(180deg,rgba(255,215,0,.12),rgba(255,215,0,.08));border-color:rgba(255,215,0,.25)}
    .msg.ai{background:rgba(12,12,16,.55)}
    .msg small{display:block;opacity:.65;font-size:.75rem;margin-bottom:6px}
    .spinner{width:20px;height:20px;border-radius:50%;border:2px solid rgba(255,255,255,.2);border-top-color:var(--gold-1);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .composer-wrap{position:fixed;left:0;right:0;bottom:18px;display:flex;justify-content:center;pointer-events:none}
    .composer{ pointer-events:auto;width:min(980px,92%);display:flex;align-items:center;gap:10px;padding:10px;
      border-radius:18px;background:var(--glass);backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.08); box-shadow:0 10px 30px rgba(0,0,0,.35), 0 0 0 1px var(--ring)}
    .btn{border:none;outline:none;cursor:pointer;height:56px;width:56px;border-radius:999px; background:rgba(255,255,255,.06);display:grid;place-items:center;transition:.2s transform,.2s background}
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.12)}
    .btn.plus::before{content:"+";font-size:28px;color:var(--gold-1);font-weight:700}
    .btn.send::before{content:"➤";font-size:20px;color:#141209;font-weight:800}
    .btn.send{background:linear-gradient(180deg,var(--gold-1),var(--gold-2)); box-shadow:0 8px 18px rgba(255,215,0,.25)}
    .mic{ position:relative;background:linear-gradient(180deg,var(--gold-1),var(--gold-2)); box-shadow:0 8px 18px rgba(255,215,0,.25)}
    .mic::before{content:"🎤";font-size:22px;color:#141209;font-weight:700}
    textarea#prompt{ flex:1; resize:none; min-height:56px; max-height:140px; padding:12px 14px; border-radius:12px; background:rgba(255,255,255,.06);
      color:var(--text); border:1px solid rgba(255,255,255,.09); outline:none; font-size:15px; line-height:1.4;}
    textarea#prompt::placeholder{ color: rgba(255,255,255,.55) }
    .menu{position:absolute;bottom:70px;left:18px;background:#0e1118;border:1px solid rgba(255,255,255,.15);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none;flex-direction:column;z-index:20}
    .menu button{background:none;border:none;color:var(--text);padding:10px 14px;text-align:left;cursor:pointer}
    .menu button:hover{background:rgba(255,255,255,.1)}
  </style>
</head>
<body>
  <div class="stars"></div>
  <div class="twinkle"></div>

  <div class="wrap">
    <header>
      <div class="brand"><div class="logo"></div><span>GoldenSpaceAI</span></div>
      <span class="badge">Advanced Assistant</span>
    </header>

    <main id="chat">
      <div class="msg ai">
        <small>GoldenSpaceAI</small>
        Choose a mode from the ＋ button: Study & Learn, Deep Search, Get Advice, or upload a file.
      </div>
    </main>

    <div class="composer-wrap">
      <div class="composer">
        <button id="plusBtn" type="button" class="btn plus" title="Menu"></button>
        <div style="flex:1">
          <textarea id="prompt" placeholder="Type your message… (Shift+Enter for newline)"></textarea>
        </div>
        <button id="micBtn" type="button" class="btn mic" title="Voice mode"></button>
        <button id="sendBtn" type="button" class="btn send" title="Send"></button>
      </div>
      <div id="menu" class="menu">
        <button data-mode="study">📚 Study & Learn</button>
        <button data-mode="deep">🔎 Deep Search</button>
        <button data-mode="advice">💡 Get Advice</button>
        <button id="addFile">📂 Add File</button>
      </div>
    </div>
  </div>

  <input id="fileInput" class="hidden" type="file"
         accept=".pdf,.txt,.md,.json,.csv,.doc,.docx,.ppt,.pptx,.xlsx,image/*" />

<script>
  const BACKEND_URL = "/chat-advanced-ai";
  const TRANSCRIBE_URL = "/api/transcribe";
  const MODEL = "gpt-4o-mini"; // fixed default

  const chat = document.getElementById("chat");
  const plusBtn = document.getElementById("plusBtn");
  const micBtn = document.getElementById("micBtn");
  const promptEl = document.getElementById("prompt");
  const sendBtn = document.getElementById("sendBtn");
  const menu = document.getElementById("menu");
  const fileInput = document.getElementById("fileInput");

  let currentMode = "study"; // default mode

  function el(tag, attrs={}, ...children){
    const n = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{
      if(k==="class") n.className=v;
      else if(k==="html") n.innerHTML=v;
      else n.setAttribute(k,v);
    });
    children.forEach(c=> n.append(c instanceof Node? c : document.createTextNode(c)));
    return n;
  }
  function addMsg(role, text){
    const m = el("div",{class:`msg ${role}`});
    m.append(el("small",{}, role==="user"?"You":"GoldenSpaceAI"));
    m.append(el("div",{html:(text||"").toString().replace(/\n/g,"<br/>")}));
    chat.append(m); chat.scrollTop = chat.scrollHeight; return m;
  }
  function addSpinner(){
    const row = el("div",{class:"msg ai"}); row.append(el("small",{},"GoldenSpaceAI")); row.append(el("div",{class:"spinner"}));
    chat.append(row); chat.scrollTop = chat.scrollHeight; return row;
  }

  // ==== Menu toggle ====
  plusBtn.addEventListener("click", ()=>{
    menu.style.display = (menu.style.display==="flex"?"none":"flex");
  });
  menu.querySelectorAll("button[data-mode]").forEach(btn=>{
    btn.addEventListener("click",()=>{
      currentMode = btn.dataset.mode;
      menu.style.display="none";
      addMsg("ai", `Mode set to: ${btn.textContent}`);
    });
  });
  document.getElementById("addFile").addEventListener("click", ()=>{
    menu.style.display="none";
    fileInput.click();
  });

  // ==== File upload auto-send ====
  fileInput.addEventListener("change", ()=>{
    const f = fileInput.files[0];
    if(!f) return;
    fileInput.value="";
    sendFile(f);
  });
  async function sendFile(file){
    const userRow = addMsg("user", `📂 File sent: ${file.name}`);
    const spin = addSpinner();
    try{
      const form = new FormData();
      form.append("file", file);
      form.append("model", MODEL);
      form.append("mode", currentMode);
      const res = await fetch(BACKEND_URL, { method:"POST", body:form, credentials:"include" });
      if(!res.ok) throw new Error("Backend error: "+res.status);
      const data = await res.json();
      chat.removeChild(spin);
      addMsg("ai", data.answer || data.reply || "[No reply]");
    }catch(err){
      chat.removeChild(spin);
      addMsg("ai","⚠️ "+err.message);
    }
  }

  // ==== Mic (unchanged except model fixed) ====
  let mediaRecorder, audioChunks = [];
  micBtn.addEventListener("click", async () => {
    try{
      if(!mediaRecorder || mediaRecorder.state === "inactive"){
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
        audioChunks = [];
        mediaRecorder.ondataavailable = e => { if(e.data.size) audioChunks.push(e.data); };
        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: "audio/webm" });
          const fd = new FormData();
          fd.append("audio", blob, "speech.webm");
          const r = await fetch(TRANSCRIBE_URL, { method:"POST", body:fd, credentials:"include" });
          const j = await r.json();
          if(j?.text){
            promptEl.value = (promptEl.value ? promptEl.value + " " : "") + j.text.trim();
            promptEl.focus();
          }
        };
        mediaRecorder.start();
        micBtn.title = "Recording… click to stop";
        micBtn.style.filter = "brightness(1.15)";
      }else{
        mediaRecorder.stop();
        micBtn.title = "Voice mode";
        micBtn.style.filter = "";
      }
    }catch(err){ alert("Microphone error: "+err.message); }
  });

  // ==== Send text ====
  async function send(){
    const text = (promptEl.value||"").trim();
    if(!text) return;
    const userRow = addMsg("user", text);
    const spin = addSpinner();
    try{
      const form = new FormData();
      form.append("q", text);
      form.append("model", MODEL);
      form.append("mode", currentMode);
      const res = await fetch(BACKEND_URL, { method:"POST", body:form, credentials:"include" });
      if(!res.ok) throw new Error("Backend error: "+res.status);
      const data = await res.json();
      chat.removeChild(spin);
      addMsg("ai", data.answer || data.reply || "[No reply]");
    }catch(err){
      chat.removeChild(spin);
      addMsg("ai","⚠️ "+err.message);
    }finally{ promptEl.value=""; }
  }
  sendBtn.addEventListener("click", send);
  promptEl.addEventListener("keydown", (e)=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }
  });
</script>
</body>
</html>
