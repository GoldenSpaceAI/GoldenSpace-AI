<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced AI Chat - GoldenSpaceAI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            display: flex;
            max-width: 1400px;
            height: 100vh;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
            position: relative;
        }

        /* Lock Screen */
        .lock-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
        }

        .lock-icon {
            font-size: 80px;
            color: #f39c12;
            margin-bottom: 20px;
        }

        .lock-title {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .lock-subtitle {
            font-size: 18px;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .unlock-btn-large {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .unlock-btn-large:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .golden-cost {
            background: #f39c12;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 15px;
            display: inline-block;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 300px;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #34495e;
        }

        .sidebar-header {
            padding: 20px;
            background: #34495e;
            border-bottom: 1px solid #4a6278;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .golden-balance {
            background: #f39c12;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 5px;
        }

        .new-chat-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 20px;
            transition: background 0.3s;
        }

        .new-chat-btn:hover {
            background: #2980b9;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 0 10px;
        }

        .chat-item {
            padding: 12px 15px;
            margin: 5px 0;
            background: #34495e;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-item:hover {
            background: #3d566e;
        }

        .chat-item.active {
            background: #3498db;
        }

        .chat-delete {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .chat-delete:hover {
            background: #c0392b;
        }

        /* Main Chat Area */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }

        .chat-header {
            background: white;
            padding: 15px 25px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .model-selector {
            display: flex;
            gap: 10px;
        }

        .model-btn {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .model-btn.active {
            border-color: #3498db;
            background: #3498db;
            color: white;
        }

        .custom-instructions-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .custom-instructions-btn:hover {
            background: #8e44ad;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            line-height: 1.4;
        }

        .user-message {
            align-self: flex-end;
            background: #3498db;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            align-self: flex-start;
            background: white;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 5px;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            max-height: 120px;
            outline: none;
        }

        #messageInput:focus {
            border-color: #3498db;
        }

        #sendButton {
            padding: 12px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        #sendButton:hover:not(:disabled) {
            background: #2980b9;
        }

        #sendButton:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            align-self: flex-start;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 12px 16px;
            font-style: italic;
            color: #7f8c8d;
        }

        .empty-state {
            text-align: center;
            color: #7f8c8d;
            padding: 40px 20px;
        }

        /* Custom Instructions Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal {
            background: white;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .modal textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .modal-cancel {
            background: #95a5a6;
            color: white;
        }

        .modal-save {
            background: #3498db;
            color: white;
        }

        .memory-indicator {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 10px;
            padding: 10px 15px;
            margin: 10px 0;
            font-size: 12px;
            color: #2c3e50;
            align-self: center;
            max-width: 80%;
            text-align: center;
        }

        .memory-indicator i {
            color: #3498db;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Lock Screen -->
        <div class="lock-screen" id="lockScreen">
            <div class="lock-icon">ðŸ”’</div>
            <div class="lock-title">Advanced AI Locked</div>
            <div class="lock-subtitle">Unlock powerful AI with conversation memory and custom instructions. NOTE! THIS FEATURE IS NOT RECOMENDED FOR MOBILES, AND YOU CAN USE THIS FEATURE UNDER MANY DEVICES BUT IN THE SAME ACCOUNT.</div>
            <button class="unlock-btn-large" id="unlockBtnLarge">
                Unlock Powerful AI
            </button>
            <div class="golden-cost">20 Golden / Month</div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div id="userName">User</div>
                        <div class="golden-balance" id="goldenBalance">0G</div>
                    </div>
                </div>
            </div>
            
            <button class="new-chat-btn" id="newChatBtn">
                + New Chat
            </button>
            
            <div class="chat-history" id="chatHistory">
                <div class="empty-state" id="emptyState">
                    No chats yet<br>Start a new conversation!
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat">
            <div class="chat-header">
                <h2>Advanced AI Chat</h2>
                <div class="header-controls">
                    <div class="model-selector">
                        <button class="model-btn active" data-model="pro">Friendly</button>
                        <button class="model-btn" data-model="thinking">Thinking</button>
                        <button class="model-btn" data-model="flash">Fast</button>
                    </div>
                    <button class="custom-instructions-btn" id="customInstructionsBtn">
                        Custom Instructions
                    </button>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">
                    Welcome to Advanced AI Chat! This AI remembers our entire conversation and can follow custom instructions. Choose a model and start chatting!
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                AI is thinking...
            </div>

            <div class="chat-input-container">
                <div class="chat-input">
                    <textarea 
                        id="messageInput" 
                        placeholder="Type your message... (AI remembers conversation history)" 
                        rows="1"
                    ></textarea>
                    <button id="sendButton">Send</button>
                </div>
            </div>
        </div>

        <!-- Custom Instructions Modal -->
        <div class="modal-overlay" id="instructionsModal">
            <div class="modal">
                <h3>Custom Instructions</h3>
                <p style="margin-bottom: 15px; color: #7f8c8d; font-size: 14px;">
                    Set custom instructions for how the AI should behave. This will be remembered for all conversations.
                </p>
                <textarea 
                    id="customInstructionsInput" 
                    placeholder="Example: Always respond in a professional tone. Be concise and factual. Use markdown formatting when helpful."
                ></textarea>
                <div class="modal-buttons">
                    <button class="modal-btn modal-cancel" id="cancelInstructions">Cancel</button>
                    <button class="modal-btn modal-save" id="saveInstructions">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AdvancedAIChat {
            constructor() {
                this.currentChatId = null;
                this.chats = this.loadChats();
                this.currentModel = 'pro';
                this.isSubscribed = false;
                this.user = null;
                this.customInstructions = this.loadCustomInstructions();
                
                this.initializeElements();
                this.checkAuth();
                this.checkSubscription();
                this.renderChatHistory();
                this.setupEventListeners();
            }

            initializeElements() {
                this.elements = {
                    lockScreen: document.getElementById('lockScreen'),
                    userAvatar: document.getElementById('userAvatar'),
                    userName: document.getElementById('userName'),
                    goldenBalance: document.getElementById('goldenBalance'),
                    newChatBtn: document.getElementById('newChatBtn'),
                    chatHistory: document.getElementById('chatHistory'),
                    chatMessages: document.getElementById('chatMessages'),
                    messageInput: document.getElementById('messageInput'),
                    sendButton: document.getElementById('sendButton'),
                    modelButtons: document.querySelectorAll('.model-btn'),
                    customInstructionsBtn: document.getElementById('customInstructionsBtn'),
                    unlockBtnLarge: document.getElementById('unlockBtnLarge'),
                    typingIndicator: document.getElementById('typingIndicator'),
                    emptyState: document.getElementById('emptyState'),
                    instructionsModal: document.getElementById('instructionsModal'),
                    customInstructionsInput: document.getElementById('customInstructionsInput'),
                    cancelInstructions: document.getElementById('cancelInstructions'),
                    saveInstructions: document.getElementById('saveInstructions')
                };
            }

            async checkAuth() {
                try {
                    const response = await fetch('/api/me');
                    const data = await response.json();
                    
                    if (data.loggedIn) {
                        this.user = data.user;
                        this.updateUserInfo(data);
                    } else {
                        window.location.href = '/login-signup.html';
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                }
            }

            updateUserInfo(data) {
                this.elements.userName.textContent = data.user.name;
                this.elements.goldenBalance.textContent = `${data.balance}G`;
                
                // Set avatar initial
                const initial = data.user.name.charAt(0).toUpperCase();
                this.elements.userAvatar.textContent = initial;
            }

            async checkSubscription() {
                try {
                    const response = await fetch('/api/feature-status?feature=chat_advancedai');
                    const data = await response.json();
                    
                    this.isSubscribed = data.unlocked;
                    
                    if (this.isSubscribed) {
                        this.elements.lockScreen.style.display = 'none';
                        this.elements.messageInput.disabled = false;
                        this.elements.sendButton.disabled = false;
                        this.elements.messageInput.placeholder = 'Type your message... (AI remembers conversation history)';
                    } else {
                        this.elements.lockScreen.style.display = 'flex';
                        this.elements.messageInput.disabled = true;
                        this.elements.sendButton.disabled = true;
                    }
                } catch (error) {
                    console.error('Subscription check failed:', error);
                    this.elements.lockScreen.style.display = 'flex';
                }
            }

            loadChats() {
                const saved = localStorage.getItem('advancedAI_chats');
                if (saved) {
                    return JSON.parse(saved);
                }
                return {};
            }

            saveChats() {
                localStorage.setItem('advancedAI_chats', JSON.stringify(this.chats));
            }

            loadCustomInstructions() {
                return localStorage.getItem('advancedAI_custom_instructions') || '';
            }

            saveCustomInstructions() {
                localStorage.setItem('advancedAI_custom_instructions', this.customInstructions);
            }

            createNewChat() {
                const chatId = 'chat_' + Date.now();
                this.chats[chatId] = {
                    id: chatId,
                    title: 'New Chat',
                    messages: [],
                    createdAt: new Date().toISOString(),
                    model: this.currentModel,
                    customInstructions: this.customInstructions
                };
                
                this.saveChats();
                this.renderChatHistory();
                this.switchToChat(chatId);
                
                return chatId;
            }

            deleteChat(chatId) {
                if (this.chats[chatId]) {
                    delete this.chats[chatId];
                    this.saveChats();
                    
                    if (this.currentChatId === chatId) {
                        this.currentChatId = null;
                        this.renderMessages();
                    }
                    
                    this.renderChatHistory();
                }
            }

            switchToChat(chatId) {
                this.currentChatId = chatId;
                this.renderMessages();
                
                // Update active chat in history
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.chatId === chatId) {
                        item.classList.add('active');
                    }
                });
            }

            renderChatHistory() {
                this.elements.chatHistory.innerHTML = '';
                
                const chatArray = Object.values(this.chats)
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                if (chatArray.length === 0) {
                    this.elements.emptyState.style.display = 'block';
                    return;
                }
                
                this.elements.emptyState.style.display = 'none';
                
                chatArray.forEach(chat => {
                    const chatElement = document.createElement('div');
                    chatElement.className = 'chat-item';
                    chatElement.dataset.chatId = chat.id;
                    
                    chatElement.innerHTML = `
                        <span>${chat.title}</span>
                        <button class="chat-delete" onclick="chatApp.deleteChat('${chat.id}')">Ã—</button>
                    `;
                    
                    if (chat.id === this.currentChatId) {
                        chatElement.classList.add('active');
                    }
                    
                    chatElement.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('chat-delete')) {
                            this.switchToChat(chat.id);
                        }
                    });
                    
                    this.elements.chatHistory.appendChild(chatElement);
                });
            }

            renderMessages() {
                if (!this.currentChatId || !this.chats[this.currentChatId]) {
                    this.elements.chatMessages.innerHTML = `
                        <div class="message ai-message">
                            Welcome to Advanced AI Chat! This AI remembers our entire conversation and can follow custom instructions. Choose a model and start chatting!
                        </div>
                    `;
                    return;
                }

                const chat = this.chats[this.currentChatId];
                this.elements.chatMessages.innerHTML = '';
                
                // Show memory indicator if there are previous messages
                if (chat.messages.length > 0) {
                    const memoryIndicator = document.createElement('div');
                    memoryIndicator.className = 'memory-indicator';
                    memoryIndicator.innerHTML = 'ðŸ’­ <strong>AI Memory Active:</strong> I remember our previous conversation';
                    this.elements.chatMessages.appendChild(memoryIndicator);
                }
                
                chat.messages.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `message ${message.role === 'user' ? 'user-message' : 'ai-message'}`;
                    messageElement.textContent = message.content;
                    this.elements.chatMessages.appendChild(messageElement);
                });
                
                this.scrollToBottom();
            }

            async sendMessage() {
                if (!this.isSubscribed) {
                    this.showLockScreen();
                    return;
                }

                const message = this.elements.messageInput.value.trim();
                if (!message) return;

                // Add user message to chat
                this.addMessage('user', message);
                this.elements.messageInput.value = '';
                this.adjustTextareaHeight();
                
                // Show typing indicator
                this.elements.typingIndicator.style.display = 'block';
                this.scrollToBottom();

                try {
                    const endpoint = `/api/generate-${this.currentModel}`;
                    const chat = this.chats[this.currentChatId];
                    
                    // Prepare messages array with conversation history
                    const messages = [];
                    
                    // Add system message with custom instructions if available
                    if (this.customInstructions) {
                        messages.push({
                            role: 'system',
                            content: `You are GoldenSpaceAI's Advanced AI assistant. Follow these custom instructions: ${this.customInstructions}`
                        });
                    }
                    
                    // Add conversation history (last 10 messages to avoid token limits)
                    const recentMessages = chat.messages.slice(-10);
                    messages.push(...recentMessages);
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            messages: messages,
                            prompt: message
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.addMessage('assistant', data.text);
                    } else {
                        throw new Error(data.error || 'Failed to get response');
                    }
                } catch (error) {
                    console.error('Chat error:', error);
                    this.addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
                } finally {
                    this.elements.typingIndicator.style.display = 'none';
                }
            }

            addMessage(role, content) {
                if (!this.currentChatId) {
                    this.createNewChat();
                }

                const message = { role, content, timestamp: new Date().toISOString() };
                this.chats[this.currentChatId].messages.push(message);
                
                // Update chat title if it's the first user message
                if (role === 'user' && this.chats[this.currentChatId].messages.length === 1) {
                    this.chats[this.currentChatId].title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
                    this.renderChatHistory();
                }

                this.saveChats();
                this.renderMessages();
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
                }, 100);
            }

            adjustTextareaHeight() {
                const textarea = this.elements.messageInput;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            showLockScreen() {
                this.elements.lockScreen.style.display = 'flex';
            }

            async unlockAdvancedAI() {
                try {
                    const response = await fetch('/api/unlock-feature', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            feature: 'chat_advancedai',
                            cost: 20
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update UI
                        this.isSubscribed = true;
                        this.elements.lockScreen.style.display = 'none';
                        this.elements.messageInput.disabled = false;
                        this.elements.sendButton.disabled = false;
                        this.elements.goldenBalance.textContent = `${data.newBalance}G`;
                        
                        // Show success message
                        this.addMessage('assistant', 'Advanced AI unlocked! I now remember our conversations and can follow your custom instructions. How can I help you?');
                        
                    } else {
                        alert('Failed to unlock: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Unlock error:', error);
                    alert('Error unlocking Advanced AI. Please try again.');
                }
            }

            showCustomInstructionsModal() {
                this.elements.customInstructionsInput.value = this.customInstructions;
                this.elements.instructionsModal.style.display = 'flex';
            }

            hideCustomInstructionsModal() {
                this.elements.instructionsModal.style.display = 'none';
            }

            saveCustomInstructions() {
                this.customInstructions = this.elements.customInstructionsInput.value.trim();
                this.saveCustomInstructions();
                this.hideCustomInstructionsModal();
                
                // Update current chat if exists
                if (this.currentChatId && this.chats[this.currentChatId]) {
                    this.chats[this.currentChatId].customInstructions = this.customInstructions;
                    this.saveChats();
                }
                
                // Show confirmation
                if (this.customInstructions) {
                    this.addMessage('assistant', 'Custom instructions saved! I\'ll follow these guidelines in our conversation.');
                }
            }

            setupEventListeners() {
                // New chat button
                this.elements.newChatBtn.addEventListener('click', () => {
                    this.createNewChat();
                });

                // Model selection
                this.elements.modelButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.elements.modelButtons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentModel = btn.dataset.model;
                        
                        if (this.currentChatId) {
                            this.chats[this.currentChatId].model = this.currentModel;
                            this.saveChats();
                        }
                    });
                });

                // Send message
                this.elements.sendButton.addEventListener('click', () => {
                    this.sendMessage();
                });

                // Enter key to send
                this.elements.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Auto-resize textarea
                this.elements.messageInput.addEventListener('input', () => {
                    this.adjustTextareaHeight();
                });

                // Unlock button
                this.elements.unlockBtnLarge.addEventListener('click', () => {
                    this.unlockAdvancedAI();
                });

                // Custom instructions button
                this.elements.customInstructionsBtn.addEventListener('click', () => {
                    if (!this.isSubscribed) {
                        this.showLockScreen();
                        return;
                    }
                    this.showCustomInstructionsModal();
                });

                // Modal events
                this.elements.cancelInstructions.addEventListener('click', () => {
                    this.hideCustomInstructionsModal();
                });

                this.elements.saveInstructions.addEventListener('click', () => {
                    this.saveCustomInstructions();
                });

                // Close modal when clicking outside
                this.elements.instructionsModal.addEventListener('click', (e) => {
                    if (e.target === this.elements.instructionsModal) {
                        this.hideCustomInstructionsModal();
                    }
                });

                // Auto-create first chat if none exists and user is subscribed
                if (this.isSubscribed && Object.keys(this.chats).length === 0) {
                    this.createNewChat();
                } else if (this.isSubscribed && Object.keys(this.chats).length > 0) {
                    // Switch to most recent chat
                    const recentChat = Object.values(this.chats)
                        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                    this.switchToChat(recentChat.id);
                }
            }
        }

        // Initialize the chat when page loads
        let chatApp;
        document.addEventListener('DOMContentLoaded', () => {
            chatApp = new AdvancedAIChat();
        });
    </script>
</body>
</html>
